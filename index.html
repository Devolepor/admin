<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة تحكم الطلاب والمنشورات</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #1976d2;
      --primary-dark: #125ea5;
      --danger-color: #e53935;
      --warning-color: #ff9800;
      --success-color: #43a047;
      --text-color: #2d3748;
      --text-light: #4a5568;
      --light-bg: #f8fafc;
      --white: #ffffff;
      --gray-light: #e2e8f0;
      --gray-dark: #cbd5e0;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .dark-mode {
      --primary-color: #4299e1;
      --primary-dark: #3182ce;
      --danger-color: #fc8181;
      --warning-color: #f6ad55;
      --success-color: #68d391;
      --text-color: #e2e8f0;
      --text-light: #a0aec0;
      --light-bg: #1a202c;
      --white: #2d3748;
      --gray-light: #4a5568;
      --gray-dark: #2d3748;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--light-bg);
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      transition: var(--transition);
    }
    
    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      transition: var(--transition);
    }
    
    .sidebar {
      position: fixed;
      right: -100%;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: var(--white);
      box-shadow: var(--shadow);
      transition: var(--transition);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }
    
    .sidebar.open {
      right: 0;
    }
    
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .sidebar-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .sidebar-menu {
      list-style: none;
    }
    
    .sidebar-menu li {
      margin-bottom: 10px;
    }
    
    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 15px;
      border-radius: var(--radius);
      color: var(--text-color);
      text-decoration: none;
      transition: var(--transition);
      font-weight: 500;
      background-color: var(--light-bg);
    }
    
    .sidebar-menu a:hover {
      background-color: var(--primary-color);
      color: var(--white);
      transform: translateX(-5px);
    }
    
    .sidebar-menu a i {
      margin-left: 10px;
      font-size: 18px;
    }
    
    .sidebar-toggle {
      position: fixed;
      right: 20px;
      top: 20px;
      background-color: var(--primary-color);
      color: var(--white);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1001;
      box-shadow: var(--shadow);
      font-size: 20px;
    }
    
    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 15px 0;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .header h1 {
      color: var(--primary-color);
      font-size: 24px;
      font-weight: 700;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .grade-select {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    input, button, select, textarea {
      padding: 12px 15px;
      border-radius: var(--radius);
      border: 1px solid var(--gray-light);
      font-family: 'Tajawal', sans-serif;
      font-size: 16px;
      transition: var(--transition);
      width: 100%;
      background-color: var(--white);
      color: var(--text-color);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }
    
    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .btn {
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      transition: var(--transition);
      box-shadow: var(--shadow);
      padding: 12px 20px;
      border-radius: 8px;
    }
    
    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-danger {
      background-color: var(--danger-color);
    }
    
    .btn-danger:hover {
      background-color: #c62828;
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-success:hover {
      background-color: #2e7d32;
    }
    
    .btn-warning {
      background-color: var(--warning-color);
    }
    
    .btn-warning:hover {
      background-color: #e65100;
    }
    
    .btn-secondary {
      background-color: var(--gray-light);
      color: var(--text-color);
    }
    
    .btn-secondary:hover {
      background-color: var(--gray-dark);
    }
    
    .btn-small {
      padding: 8px 15px;
      font-size: 14px;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn-group .btn {
      flex: 1;
      min-width: 120px;
    }
    
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--white) 0%, var(--light-bg) 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .login-box {
      background: var(--white);
      padding: 30px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    
    .login-box h2 {
      margin-bottom: 25px;
      color: var(--primary-color);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .login-box input {
      margin-bottom: 20px;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      overflow-y: auto;
      padding: 0;
      box-sizing: border-box;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background-color: var(--white);
      padding: 25px;
      border-radius: 0;
      width: 100%;
      min-height: 100vh;
      box-shadow: none;
      margin: 0;
      position: relative;
      animation: slideIn 0.3s ease forwards;
      z-index: 1051;
    }
    
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .modal-title {
      margin: 0;
      color: var(--primary-color);
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close {
      color: var(--text-light);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
      background: var(--light-bg);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .close:hover {
      color: var(--danger-color);
      background: rgba(229, 57, 53, 0.1);
      transform: rotate(90deg);
    }
    
    .modal-body {
      padding: 15px 0;
    }
    
    .modal-footer {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-top: 20px;
      border-top: 1px solid var(--gray-light);
      margin-top: 20px;
      position: sticky;
      bottom: 0;
      background: var(--white);
      padding-bottom: 20px;
    }
    
    .modal-footer button {
      width: 100%;
    }
    
    .image-upload-container {
      background: var(--light-bg);
      padding: 20px;
      border-radius: 12px;
      margin-top: 10px;
    }
    
    .image-preview-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .image-preview {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px dashed var(--gray-light);
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow);
      display: none;
    }
    
    .image-preview:hover {
      transform: scale(1.03);
      border-color: var(--primary-color);
    }
    
    .image-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      width: 100%;
      margin-top: 10px;
      display: none;
    }
    
    .upload-btn {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    
    .upload-btn input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .image-modal .modal-content {
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      padding: 20px;
    }
    
    .image-modal-content {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 8px;
      box-shadow: 0 5px 30px rgba(0,0,0,0.3);
    }
    
    .close-image {
      position: fixed;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1002;
      background: rgba(0,0,0,0.5);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--gray-light);
      overflow-x: auto;
      padding-bottom: 5px;
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
      white-space: nowrap;
      font-weight: 500;
    }
    
    .tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    #studentsCards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .student-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 15px;
      transition: var(--transition);
      position: relative;
    }
    
    .student-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    
    .student-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
      cursor: pointer;
    }
    
    .student-id {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 16px;
    }
    
    .student-name {
      font-weight: bold;
      font-size: 18px;
    }
    
    .student-grade {
      color: var(--text-light);
      font-size: 14px;
    }
    
    .student-level {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .level-weak {
      background-color: #ffebee;
      color: #c62828;
    }
    
    .level-acceptable {
      background-color: #fff8e1;
      color: #e65100;
    }
    
    .level-good {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    
    .level-very-good {
      background-color: #e3f2fd;
      color: #1565c0;
    }
    
    .level-excellent {
      background-color: #f3e5f5;
      color: #6a1b9a;
    }
    
    .student-image-thumb {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--gray-light);
    }
    
    .posts-container {
      margin-top: 30px;
    }
    
    .posts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .post {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
    }
    
    .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .post-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-left: 15px;
    }
    
    .post-author {
      font-weight: bold;
    }
    
    .post-date {
      color: var(--text-light);
      font-size: 14px;
    }
    
    .post-content {
      margin-bottom: 15px;
      line-height: 1.6;
    }
    
    .post-image {
      max-width: 100%;
      border-radius: 8px;
      margin: 10px 0;
      display: block;
      cursor: pointer;
    }
    
    .post-actions {
      display: flex;
      gap: 15px;
      border-top: 1px solid var(--gray-light);
      padding-top: 15px;
      flex-wrap: wrap;
    }
    
    .post-action {
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--text-light);
      cursor: pointer;
      transition: var(--transition);
      padding: 8px 12px;
      border-radius: 20px;
      background-color: var(--light-bg);
    }
    
    .post-action:hover {
      color: var(--primary-color);
      background-color: rgba(25, 118, 210, 0.1);
    }
    
    .post-action.liked {
      color: var(--danger-color);
      background-color: rgba(229, 57, 53, 0.1);
    }
    
    .post-delete {
      position: absolute;
      top: 15px;
      left: 15px;
      color: var(--danger-color);
      cursor: pointer;
      opacity: 0.7;
      transition: var(--transition);
    }
    
    .post-delete:hover {
      opacity: 1;
    }
    
    .student-detail-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }
    
    .student-detail-header {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .student-detail-title {
      color: var(--primary-color);
      font-size: 22px;
      margin: 0;
    }
    
    .student-info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 10px;
      background-color: var(--light-bg);
      border-radius: var(--radius);
    }
    
    .student-info-label {
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .student-info-value {
      color: var(--text-color);
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }
    
    .qr-code-container {
      margin: 20px 0;
      text-align: center;
    }
    
    .qr-code {
      margin: 0 auto;
      padding: 10px;
      background: white;
      border-radius: var(--radius);
      display: inline-block;
    }
    
    .attendance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .attendance-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: var(--light-bg);
      border-radius: var(--radius);
    }
    
    .fees-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .fee-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: var(--light-bg);
      border-radius: var(--radius);
    }
    
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .report-table th, .report-table td {
      padding: 12px;
      text-align: right;
      border: 1px solid var(--gray-light);
    }
    
    .report-table th {
      background-color: var(--primary-color);
      color: white;
    }
    
    .report-table tr:nth-child(even) {
      background-color: var(--light-bg);
    }
    
    .report-table tr:hover {
      background-color: rgba(25, 118, 210, 0.1);
    }
    
    .report-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .report-filter select {
      flex: 1;
      min-width: 150px;
    }
    
    .trash-list {
      margin-top: 20px;
    }
    
    .trash-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 10px;
    }
    
    .trash-info {
      flex: 1;
    }
    
    .trash-actions {
      display: flex;
      gap: 10px;
    }
    
    .no-students {
      text-align: center;
      padding: 40px;
      background: var(--white);
      border-radius: 12px;
      box-shadow: var(--shadow);
    }
    
    .no-students h3 {
      color: var(--text-light);
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .report-type-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .report-type-btn {
      flex: 1;
      min-width: 200px;
    }
    
    .report-section {
      display: none;
    }
    
    .report-section.active {
      display: block;
    }
    
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      text-align: center;
    }
    
    .stat-card h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .stat-card .description {
      color: var(--text-light);
      font-size: 14px;
    }
    
    .stat-card.present {
      border-top: 4px solid var(--success-color);
    }
    
    .stat-card.absent {
      border-top: 4px solid var(--danger-color);
    }
    
    .stat-card.paid {
      border-top: 4px solid var(--success-color);
    }
    
    .stat-card.unpaid {
      border-top: 4px solid var(--danger-color);
    }
    
    .stat-card.total {
      border-top: 4px solid var(--primary-color);
    }
    
    .edit-student-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      color: var(--warning-color);
      cursor: pointer;
      opacity: 0.7;
      transition: var(--transition);
    }
    
    .edit-student-btn:hover {
      opacity: 1;
    }
    
    @media (min-width: 768px) {
      .sidebar {
        width: 300px;
        right: -300px;
      }
      
      .modal-content {
        width: 90%;
        max-width: 600px;
        min-height: auto;
        border-radius: 16px;
        margin: 30px auto;
      }
      
      .modal-footer {
        flex-direction: row;
        justify-content: flex-end;
      }
      
      .modal-footer button {
        width: auto;
      }
      
      .action-buttons {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }
    
    @media (max-width: 480px) {
      .header h1 {
        font-size: 20px;
      }
      
      .control-panel {
        grid-template-columns: 1fr;
      }
      
      .sidebar-menu a {
        padding: 12px;
        font-size: 15px;
      }
      
      .modal-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .modal-title {
        font-size: 20px;
      }
      
      .student-card {
        padding: 12px;
      }
      
      .student-name {
        font-size: 16px;
      }
      
      .student-id {
        font-size: 14px;
      }
    }
    
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--gray-light);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
  </style>
</head>
<body>
  <!-- Modal لعرض الصورة بالحجم الكامل -->
  <div id="imageModal" class="modal image-modal">
    <span class="close-image" onclick="closeImageModal()">&times;</span>
    <div class="modal-content">
      <img class="image-modal-content" id="expandedImage">
    </div>
  </div>

  <!-- شاشة تسجيل الدخول -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h2><i class="fas fa-lock"></i> تسجيل الدخول</h2>
      <input type="password" id="loginPassword" placeholder="ادخل كلمة المرور">
      <button class="btn btn-success" onclick="checkLogin()"><i class="fas fa-sign-in-alt"></i> دخول</button>
    </div>
  </div>

  <!-- الشريط الجانبي -->
  <div class="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </div>
  
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2 class="sidebar-title"><i class="fas fa-user-graduate"></i> القائمة الرئيسية</h2>
      <button class="btn btn-danger" onclick="toggleSidebar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <ul class="sidebar-menu">
      <li><a href="#" onclick="showAddModal()"><i class="fas fa-user-plus"></i> إضافة طالب جديد</a></li>
      <li><a href="#" onclick="showDeleteModal(null)"><i class="fas fa-user-minus"></i> حذف طالب</a></li>
      <li><a href="#" onclick="showAllStudents()"><i class="fas fa-users"></i> عرض جميع الطلاب</a></li>
      <li><a href="#" onclick="showReports('fees')"><i class="fas fa-money-bill-wave"></i> تقرير المصروفات</a></li>
      <li><a href="#" onclick="showReports('attendance')"><i class="fas fa-calendar-check"></i> تقرير الحضور</a></li>
      <li><a href="#" onclick="showGradeModal()"><i class="fas fa-filter"></i> تصفية حسب الصف</a></li>
      <li><a href="#" onclick="showTrash()"><i class="fas fa-trash"></i> سلة المهملات</a></li>
      <li><a href="#" onclick="exportData('json')"><i class="fas fa-file-export"></i> تصدير البيانات</a></li>
      <li><a href="#" onclick="saveToGitHub()"><i class="fas fa-save"></i> حفظ البيانات</a></li>
    </ul>
  </div>

  <!-- المحتوى الرئيسي -->
  <div class="container">
    <!-- رأس الصفحة -->
    <div class="header">
      <h1><i class="fas fa-user-graduate"></i> لوحة تحكم الطلاب</h1>
      <div class="header-actions">
        <div class="grade-select">
          <button class="btn" onclick="showGradeModal()"><i class="fas fa-filter"></i> تصفية حسب الصف</button>
        </div>
        <button class="btn theme-toggle" id="themeToggle">
          <i class="fas fa-moon"></i> الوضع الليلي
        </button>
      </div>
    </div>

    <!-- تبويبات الصفحة -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('students')">
        <i class="fas fa-users"></i> الطلاب
      </div>
      <div class="tab" onclick="switchTab('posts')">
        <i class="fas fa-newspaper"></i> المنشورات
      </div>
      <div class="tab" onclick="switchTab('reports')">
        <i class="fas fa-chart-bar"></i> التقارير
      </div>
    </div>

    <!-- تبويب الطلاب -->
    <div id="students-tab" class="tab-content active">
      <div class="control-panel">
        <input type="text" id="token" placeholder="🔑 GitHub Token">
        <input type="text" id="searchId" placeholder="🔍 كود الطالب">
        <button class="btn" onclick="searchStudent()"><i class="fas fa-search"></i> بحث</button>
        <div class="btn-group">
          <button class="btn btn-success" onclick="showAddModal()"><i class="fas fa-user-plus"></i> إضافة</button>
          <button class="btn btn-secondary" onclick="hideAllStudents()"><i class="fas fa-eye-slash"></i> إخفاء الكل</button>
          <button class="btn btn-secondary" onclick="showAllStudents()"><i class="fas fa-eye"></i> عرض الكل</button>
          <button class="btn btn-warning" onclick="saveToGitHub()"><i class="fas fa-save"></i> حفظ</button>
        </div>
      </div>

      <div id="studentsCount" style="background: var(--white); padding: 15px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span><i class="fas fa-users"></i> عدد الطلاب: <span id="studentsCountNumber">0</span></span>
          <span><i class="fas fa-calendar-alt"></i> تاريخ اليوم: <span id="currentDate"></span></span>
        </div>
      </div>
      
      <div id="studentsCards"></div>
    </div>

    <!-- تبويب المنشورات -->
    <div id="posts-tab" class="tab-content">
      <div class="posts-container">
        <div class="posts-header">
          <h2><i class="fas fa-newspaper"></i> المنشورات</h2>
          <button class="btn btn-success" onclick="showPostModal()">
            <i class="fas fa-plus"></i> منشور جديد
          </button>
        </div>

        <div id="postsList"></div>
      </div>
    </div>

    <!-- تبويب التقارير -->
    <div id="reports-tab" class="tab-content">
      <div class="posts-container">
        <div class="posts-header">
          <h2><i class="fas fa-chart-bar"></i> التقارير</h2>
        </div>

        <div class="report-type-selector">
          <button class="btn report-type-btn" onclick="showReports('fees')">
            <i class="fas fa-money-bill-wave"></i> تقرير المصروفات
          </button>
          <button class="btn report-type-btn" onclick="showReports('attendance')">
            <i class="fas fa-calendar-check"></i> تقرير الحضور
          </button>
          <button class="btn report-type-btn" onclick="showReports('stats')">
            <i class="fas fa-chart-pie"></i> الإحصائيات
          </button>
        </div>

        <!-- إحصائيات سريعة -->
        <div id="statsReport" class="report-section">
          <div class="stats-cards">
            <div class="stat-card total">
              <h3><i class="fas fa-users"></i> إجمالي الطلاب</h3>
              <div class="value" id="totalStudentsCount">0</div>
              <div class="description">عدد الطلاب المسجلين في النظام</div>
            </div>
            
            <div class="stat-card present">
              <h3><i class="fas fa-user-check"></i> الحضور اليوم</h3>
              <div class="value" id="todayPresentCount">0</div>
              <div class="description">عدد الطلاب الحاضرين اليوم</div>
            </div>
            
            <div class="stat-card absent">
              <h3><i class="fas fa-user-times"></i> الغياب اليوم</h3>
              <div class="value" id="todayAbsentCount">0</div>
              <div class="description">عدد الطلاب الغائبين اليوم</div>
            </div>
            
            <div class="stat-card paid">
              <h3><i class="fas fa-check-circle"></i> مصروفات مسددة</h3>
              <div class="value" id="paidFeesCount">0</div>
              <div class="description">عدد الطلاب الذين سددوا المصروفات</div>
            </div>
            
            <div class="stat-card unpaid">
              <h3><i class="fas fa-exclamation-circle"></i> مصروفات غير مسددة</h3>
              <div class="value" id="unpaidFeesCount">0</div>
              <div class="description">عدد الطلاب الذين لم يسددوا المصروفات</div>
            </div>
          </div>
        </div>

        <!-- تقرير المصروفات -->
        <div id="feesReport" class="report-section">
          <div class="report-header">
            <h3><i class="fas fa-money-bill-wave"></i> تقرير المصروفات</h3>
            <button class="btn btn-success" onclick="generateFeesReport()">
              <i class="fas fa-download"></i> تصدير التقرير
            </button>
          </div>
          
          <div class="report-filter">
            <select id="feesGradeFilter" style="flex: 1;">
              <option value="">جميع الصفوف</option>
            </select>
            <select id="feesMonthFilter" style="flex: 1;">
              <option value="">جميع الأشهر</option>
            </select>
            <select id="feesStatusFilter" style="flex: 1;">
              <option value="">جميع الحالات</option>
              <option value="paid">مسددة</option>
              <option value="unpaid">غير مسددة</option>
            </select>
            <button class="btn" onclick="filterFeesReport()">
              <i class="fas fa-filter"></i> تصفية
            </button>
          </div>
          
          <div class="table-responsive">
            <table class="report-table" id="feesReportTable">
              <thead>
                <tr>
                  <th>كود الطالب</th>
                  <th>الاسم</th>
                  <th>الصف</th>
                  <th>أغسطس</th>
                  <th>سبتمبر</th>
                  <th>أكتوبر</th>
                  <th>نوفمبر</th>
                  <th>ديسمبر</th>
                  <th>يناير</th>
                  <th>فبراير</th>
                  <th>مارس</th>
                  <th>أبريل</th>
                </tr>
              </thead>
              <tbody id="feesReportBody"></tbody>
            </table>
          </div>
        </div>

        <!-- تقرير الحضور -->
        <div id="attendanceReport" class="report-section">
          <div class="report-header">
            <h3><i class="fas fa-calendar-check"></i> تقرير الحضور والغياب</h3>
            <button class="btn btn-success" onclick="generateAttendanceReport()">
              <i class="fas fa-download"></i> تصدير التقرير
            </button>
          </div>
          
          <div class="report-filter">
            <select id="attendanceGradeFilter" style="flex: 1;">
              <option value="">جميع الصفوف</option>
            </select>
            <select id="attendanceDayFilter" style="flex: 1;">
              <option value="">جميع الأيام</option>
            </select>
            <select id="attendanceStatusFilter" style="flex: 1;">
              <option value="">جميع الحالات</option>
              <option value="حاضر">حاضر</option>
              <option value="غائب">غائب</option>
            </select>
            <button class="btn" onclick="filterAttendanceReport()">
              <i class="fas fa-filter"></i> تصفية
            </button>
          </div>
          
          <div class="table-responsive">
            <table class="report-table" id="attendanceReportTable">
              <thead>
                <tr>
                  <th>كود الطالب</th>
                  <th>الاسم</th>
                  <th>الصف</th>
                  <th>السبت</th>
                  <th>الأحد</th>
                  <th>الاثنين</th>
                  <th>الثلاثاء</th>
                  <th>الأربعاء</th>
                  <th>الخميس</th>
                  <th>الجمعة</th>
                </tr>
              </thead>
              <tbody id="attendanceReportBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal إضافة/تعديل طالب -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle"><i class="fas fa-user-plus"></i> إضافة طالب جديد</h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="studentId"><i class="fas fa-id-card"></i> كود الطالب</label>
          <input type="text" id="studentId" placeholder="سيتم توليد الكود تلقائياً" disabled>
        </div>
        
        <div class="form-group">
          <label for="studentName"><i class="fas fa-user"></i> اسم الطالب</label>
          <input type="text" id="studentName" placeholder="أدخل اسم الطالب">
        </div>
        
        <div class="form-group">
          <label for="studentGrade"><i class="fas fa-graduation-cap"></i> الصف</label>
          <select id="studentGrade">
            <option value="" disabled selected>اختر الصف</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="studentPhone"><i class="fas fa-phone"></i> رقم ولي الأمر (اختياري)</label>
          <input type="text" id="studentPhone" placeholder="أدخل رقم الهاتف">
        </div>
        
        <div class="form-group">
          <label for="studentLevel"><i class="fas fa-star"></i> المستوى الأكاديمي (اختياري)</label>
          <select id="studentLevel">
            <option value="">اختر المستوى</option>
            <option value="ضعيف">ضعيف</option>
            <option value="مقبول">مقبول</option>
            <option value="جيد">جيد</option>
            <option value="جيد جدا">جيد جدا</option>
            <option value="ممتاز">ممتاز</option>
          </select>
        </div>
        
        <div class="form-group">
          <label><i class="fas fa-image"></i> صورة الطالب (اختياري)</label>
          <div class="image-upload-container">
            <div class="image-preview-wrapper">
              <img id="studentImagePreview" class="image-preview" alt="معاينة الصورة" onclick="expandImage(this)">
              <div class="image-actions" id="imageActions">
                <button class="btn btn-small btn-danger" onclick="removeImage()">
                  <i class="fas fa-trash"></i> حذف
                </button>
                <button class="btn btn-small btn-success" onclick="document.getElementById('studentImage').click()">
                  <i class="fas fa-sync"></i> تغيير
                </button>
              </div>
            </div>
            <button class="btn upload-btn">
              <i class="fas fa-upload"></i> اختر صورة
              <input type="file" id="studentImage" accept="image/*" onchange="previewStudentImage()">
            </button>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> إلغاء
        </button>
        <button class="btn btn-success" id="saveStudentBtn">
          <i class="fas fa-save"></i> حفظ الطالب
        </button>
      </div>
    </div>
  </div>

  <!-- Modal حذف طالب -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-trash-alt"></i> تأكيد الحذف</h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      
      <div class="modal-body">
        <div style="background: #fde8e8; color: var(--danger-color); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>تحذير:</strong> هذا الإجراء لا يمكن التراجع عنه!
        </div>
        
        <div id="deleteStudentInfo" style="display: none;">
          <div class="student-card" style="background: var(--light-bg); padding: 15px; border-radius: 8px;">
            <div class="student-header">
              <div>
                <div class="student-name" id="deleteStudentName"></div>
                <div class="student-id" id="deleteStudentId"></div>
              </div>
              <div class="student-grade" id="deleteStudentGrade"></div>
            </div>
          </div>
        </div>
        
        <div id="deleteStudentSelectContainer" style="margin-top: 15px;">
          <select id="deleteStudentSelect" style="width: 100%;">
            <option value="" disabled selected>اختر الطالب للحذف</option>
          </select>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> إلغاء
        </button>
        <button class="btn btn-danger" onclick="confirmDelete()">
          <i class="fas fa-trash"></i> تأكيد الحذف
        </button>
      </div>
    </div>
  </div>

  <!-- Modal الملاحظات -->
  <div id="notesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-sticky-note"></i> ملاحظات الطالب</h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <textarea id="notesContent" rows="8" placeholder="أدخل ملاحظات عن الطالب..." 
                    style="width: 100%; border-radius: 8px; padding: 15px; border: 1px solid var(--gray-light);"></textarea>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> إلغاء
        </button>
        <button class="btn btn-success" onclick="saveNotes()">
          <i class="fas fa-save"></i> حفظ الملاحظات
        </button>
      </div>
    </div>
  </div>

  <!-- Modal المنشورات -->
  <div id="postModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="postModalTitle"><i class="fas fa-plus"></i> منشور جديد</h3>
        <span class="close" onclick="closePostModal()">&times;</span>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="editPostTitle"><i class="fas fa-heading"></i> عنوان المنشور</label>
          <input type="text" id="editPostTitle" placeholder="أدخل عنوان المنشور">
        </div>
        
        <div class="form-group">
          <label for="editPostContent"><i class="fas fa-align-left"></i> محتوى المنشور</label>
          <textarea id="editPostContent" rows="6" placeholder="اكتب محتوى المنشور هنا..."></textarea>
        </div>
        
        <div class="form-group">
          <label><i class="fas fa-image"></i> صورة المنشور (اختياري)</label>
          <div class="image-upload-container">
            <div class="image-preview-wrapper">
              <img id="postImagePreview" class="image-preview" alt="معاينة الصورة" onclick="expandImage(this)">
              <div class="image-actions" id="postImageActions">
                <button class="btn btn-small btn-danger" onclick="removePostImage()">
                  <i class="fas fa-trash"></i> حذف
                </button>
                <button class="btn btn-small btn-success" onclick="document.getElementById('postImageInput').click()">
                  <i class="fas fa-sync"></i> تغيير
                </button>
              </div>
            </div>
            <button class="btn upload-btn">
              <i class="fas fa-upload"></i> اختر صورة
              <input type="file" id="postImageInput" accept="image/*" onchange="previewPostImage()">
            </button>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn" onclick="closePostModal()">
          <i class="fas fa-times"></i> إلغاء
        </button>
        <button class="btn btn-success" id="savePostBtn">
          <i class="fas fa-save"></i> حفظ المنشور
        </button>
      </div>
    </div>
  </div>

  <!-- Modal تفاصيل الطالب -->
  <div id="studentDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-user"></i> تفاصيل الطالب</h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-body" id="studentDetailContent"></div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> إغلاق
        </button>
      </div>
    </div>
  </div>

  <!-- Modal سلة المهملات -->
  <div id="trashModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-trash"></i> سلة المهملات</h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="trashContent"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> إغلاق
        </button>
      </div>
    </div>
  </div>

<script>
// Initialize jsPDF
const { jsPDF } = window.jspdf;

let students = {};
let posts = {};
let trash = {};
let sha = "";
const owner = "Devolepor";
const repo = "app";
const path = "students.json";
const postsPath = "posts.json";
const trashPath = "trash.json";
const branch = "main";
const PASSWORD = "010135685900122327731001150929598";
let githubFileUrl = `https://github.com/${owner}/${repo}/blob/${branch}/${path}`;
let currentStudentId = null;
let currentPostId = null;
let deleteStudentId = null;
let isLoading = false;
let originalButtonText = "";
let postImageFile = null;
let studentImageFile = null;

const grades = [
  "الصف الأول الابتدائي", "الصف الثاني الابتدائي", "الصف الثالث الابتدائي",
  "الصف الرابع الابتدائي", "الصف الخامس الابتدائي", "الصف السادس الابتدائي",
  "الصف الأول الإعدادي", "الصف الثاني الإعدادي", "الصف الثالث الإعدادي",
  "الصف الأول الثانوي", "الصف الثاني الثانوي", "الصف الثالث الثانوي"
];

const levels = ["ضعيف", "مقبول", "جيد", "جيد جدا", "ممتاز"];

// أيام الأسبوع وأشهر السنة للاستخدام في الجدول
const weekDays = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];
const months = ["أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر", "يناير", "فبراير", "مارس", "أبريل"];

// Check for saved theme preference
if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark-mode");
  document.getElementById("themeToggle").innerHTML = '<i class="fas fa-sun"></i> الوضع النهاري';
}

if (localStorage.getItem("gh_token")) {
  document.getElementById("token").value = localStorage.getItem("gh_token");
}

// Theme toggle functionality
document.getElementById("themeToggle").addEventListener("click", function() {
  document.body.classList.toggle("dark-mode");
  if (document.body.classList.contains("dark-mode")) {
    localStorage.setItem("theme", "dark");
    this.innerHTML = '<i class="fas fa-sun"></i> الوضع النهاري';
  } else {
    localStorage.setItem("theme", "light");
    this.innerHTML = '<i class="fas fa-moon"></i> الوضع الليلي';
  }
});

// Toggle sidebar
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

// دالة لتوليد كود طالب عشوائي مكون من 6 أرقام
function generateStudentId() {
  let id;
  do {
    id = Math.floor(100000 + Math.random() * 900000).toString();
  } while (students[id]); // تأكد من أن الكود غير موجود مسبقاً
  return id;
}

function checkLogin() {
  const pass = document.getElementById("loginPassword").value;
  if (pass === PASSWORD) {
    localStorage.setItem("isLoggedIn", "true");
    document.getElementById("loginScreen").style.display = "none";
    loadStudents();
    loadPosts();
    loadTrash();
    
    // تعبئة قائمة الصفوف عند تسجيل الدخول
    fillGradeSelects();
    
    // عرض تاريخ اليوم
    const today = new Date();
    document.getElementById('currentDate').textContent = today.toLocaleDateString('ar-EG');
  } else {
    Swal.fire({
      title: 'خطأ!',
      text: 'كلمة مرور خاطئة!',
      icon: 'error',
      confirmButtonText: 'حسناً'
    });
  }
}

// تعبئة قوائم الصفوف في النماذج
function fillGradeSelects() {
  const gradeSelects = [
    document.getElementById('studentGrade'),
    document.getElementById('gradeSelect'),
    document.getElementById('feesGradeFilter'),
    document.getElementById('attendanceGradeFilter')
  ];
  
  gradeSelects.forEach(select => {
    if (select) {
      select.innerHTML = '<option value="" disabled selected>اختر الصف</option>';
      grades.forEach(grade => {
        select.innerHTML += `<option value="${grade}">${grade}</option>`;
      });
    }
  });
  
  // تعبئة قائمة الأشهر لتقرير المصروفات
  const monthSelect = document.getElementById('feesMonthFilter');
  if (monthSelect) {
    monthSelect.innerHTML = '<option value="">جميع الأشهر</option>';
    months.forEach(month => {
      monthSelect.innerHTML += `<option value="${month}">${month}</option>`;
    });
  }
  
  // تعبئة قائمة الأيام لتقرير الحضور
  const daySelect = document.getElementById('attendanceDayFilter');
  if (daySelect) {
    daySelect.innerHTML = '<option value="">جميع الأيام</option>';
    weekDays.forEach(day => {
      daySelect.innerHTML += `<option value="${day}">${day}</option>`;
    });
  }
}

async function loadStudents() {
  try {
    showLoading(true);
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`);
    if (!res.ok) throw new Error('فشل في تحميل بيانات الطلاب');
    
    let data = await res.json();
    sha = data.sha;
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    students = JSON.parse(decodedContent);
    renderStudentCards();
    document.getElementById('studentsCountNumber').textContent = Object.keys(students).length;
    updateStats();
  } catch (error) {
    console.error("Error loading students:", error);
    students = {};
    renderStudentCards();
    Swal.fire({
      title: 'تحذير',
      text: 'لا يوجد بيانات حالية للطلاب، سيتم إنشاء ملف جديد عند الحفظ',
      icon: 'warning'
    });
  } finally {
    showLoading(false);
  }
}

async function loadPosts() {
  try {
    showLoading(true);
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`);
    if (!res.ok) throw new Error('فشل في تحميل المنشورات');
    
    let data = await res.json();
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    posts = JSON.parse(decodedContent);
    renderPosts();
  } catch (error) {
    console.error("Error loading posts:", error);
    posts = {};
    renderPosts();
    Swal.fire({
      title: 'تحذير',
      text: 'لا يوجد منشورات حالية، سيتم إنشاء ملف جديد عند الحفظ',
      icon: 'warning'
    });
  } finally {
    showLoading(false);
  }
}

async function loadTrash() {
  try {
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${trashPath}`);
    if (!res.ok) throw new Error('فشل في تحميل سلة المهملات');
    
    let data = await res.json();
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    trash = JSON.parse(decodedContent);
  } catch (error) {
    console.error("Error loading trash:", error);
    trash = {};
  }
}

function renderStudentCards(filterGrade = null) {
  let html = '';
  let studentCount = 0;
  
  for (let id in students) {
    let s = students[id];
    if (filterGrade && s.main.trim() !== filterGrade.trim()) continue;

    studentCount++;
    
    // تحديد فئة المستوى لتنسيق العرض
    let levelClass = '';
    if (s.info === "ضعيف") levelClass = "level-weak";
    else if (s.info === "مقبول") levelClass = "level-acceptable";
    else if (s.info === "جيد") levelClass = "level-good";
    else if (s.info === "جيد جدا") levelClass = "level-very-good";
    else if (s.info === "ممتاز") levelClass = "level-excellent";
    
    // إضافة صورة الطالب إذا كانت موجودة
    let imageThumb = '';
    if (s.image) {
      imageThumb = `<img src="${s.image}" class="student-image-thumb" alt="صورة الطالب">`;
    }
    
    html += `
      <div class="student-card" id="student-card-${id}">
        ${imageThumb}
        <i class="fas fa-edit edit-student-btn" onclick="showEditModal('${id}')"></i>
        <div class="student-header" onclick="showStudentDetails('${id}')">
          <div>
            <div class="student-name">${s.name}</div>
            <div class="student-id">كود: ${id}</div>
          </div>
          <div>
            <div class="student-grade">${s.main}</div>
            ${s.info ? `<span class="student-level ${levelClass}">${s.info}</span>` : ''}
          </div>
        </div>
      </div>
    `;
  }
  
  document.getElementById('studentsCards').innerHTML = studentCount > 0 ? html : `
    <div class="no-students">
      <h3><i class="fas fa-info-circle"></i> لا يوجد طلاب مسجلين حالياً</h3>
    </div>
  `;
  
  document.getElementById('studentsCountNumber').textContent = studentCount;
  updateStats();
}

function hideAllStudents() {
  document.getElementById('studentsCards').innerHTML = `
    <div class="no-students">
      <h3><i class="fas fa-eye-slash"></i> تم إخفاء جميع الطلاب</h3>
      <button class="btn btn-success" onclick="showAllStudents()">
        <i class="fas fa-eye"></i> عرض الطلاب
      </button>
    </div>
  `;
}

function showAllStudents() {
  renderStudentCards();
}

function showStudentDetails(id) {
  const student = students[id];
  
  // Generate QR code if phone number exists
  let qrCodeHtml = '';
  if (student.phone) {
    qrCodeHtml = `
      <div class="qr-code-container">
        <div id="qr-code-${id}" class="qr-code"></div>
        <p>QR Code لرقم ولي الأمر</p>
      </div>
    `;
  }
  
  // Generate image if exists
  let imageHtml = '';
  if (student.image) {
    imageHtml = `
      <div class="image-upload">
        <img src="${student.image}" class="image-preview" style="display: block; max-width: 200px;" onclick="expandImage(this)">
      </div>
    `;
  }
  
  let html = `
    <div class="student-detail-card">
      <div class="student-detail-header">
        <h2 class="student-detail-title"><i class="fas fa-user"></i> بيانات الطالب</h2>
      </div>
      
      <div class="student-detail-body">
        <div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-id-card"></i> كود الطالب:</span>
            <span class="student-info-value">${id}</span>
          </div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-user"></i> الاسم:</span>
            <span class="student-info-value">${student.name}</span>
          </div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-graduation-cap"></i> الصف:</span>
            <span class="student-info-value">${student.main}</span>
          </div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-star"></i> المستوى:</span>
            <span class="student-info-value">${student.info || '-'}</span>
          </div>
          ${student.phone ? `
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-phone"></i> رقم ولي الأمر:</span>
            <span class="student-info-value">${student.phone}</span>
          </div>
          ` : ''}
        </div>
        
        ${imageHtml}
        ${qrCodeHtml}
      </div>
      
      <div class="action-buttons">
        <button class="btn" onclick="showAttendanceModal('${id}')">
          <i class="fas fa-calendar-check"></i> الحضور والغياب
        </button>
        <button class="btn" onclick="showFeesModal('${id}')">
          <i class="fas fa-money-bill-wave"></i> المصروفات
        </button>
        <button class="btn" onclick="showNotesModal('${id}')">
          <i class="fas fa-sticky-note"></i> الملاحظات
        </button>
        ${student.phone ? `
        <button class="btn btn-success" onclick="generateQRCode('${id}', '${student.phone}')">
          <i class="fas fa-qrcode"></i> إنشاء QR Code
        </button>
        ` : ''}
        <button class="btn btn-warning" onclick="showEditModal('${id}')">
          <i class="fas fa-edit"></i> تعديل البيانات
        </button>
      </div>
    </div>
  `;
  
  document.getElementById('studentDetailContent').innerHTML = html;
  
  // Initialize QR code if phone exists
  if (student.phone) {
    new QRCode(document.getElementById(`qr-code-${id}`), {
      text: `https://wa.me/${student.phone}?text=حاضر`,
      width: 150,
      height: 150,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });
  }
  
  document.getElementById('studentDetailModal').style.display = 'block';
}

function showAttendanceModal(id) {
  const student = students[id];
  
  let html = `
    <div class="report-section">
      <div class="report-header">
        <h3 class="report-title"><i class="fas fa-calendar-check"></i> الحضور والغياب للطالب ${student.name}</h3>
      </div>
      
      <div class="attendance-grid">
        ${weekDays.map(day => `
          <div class="attendance-item">
            <span>${day}</span>
            <select onchange="updateAttendance('${id}','${day}',this.value)" 
                    style="padding: 3px; border-radius: 5px; background: var(--white); color: var(--text-color);">
              <option value="حاضر" ${student.attendance?.[day] === "حاضر" ? 'selected' : ''}>حاضر</option>
              <option value="غائب" ${student.attendance?.[day] === "غائب" ? 'selected' : ''}>غائب</option>
              <option value="-" ${!student.attendance?.[day] || student.attendance?.[day] === "-" ? 'selected' : ''}>-</option>
            </select>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  
  document.getElementById('studentDetailContent').innerHTML = html;
}

function updateAttendance(id, day, status) {
  if (!students[id].attendance) {
    students[id].attendance = {};
  }
  students[id].attendance[day] = status;
  showSuccess('تم تحديث حالة الحضور بنجاح');
  updateStats();
}

function showFeesModal(id) {
  const student = students[id];
  
  let html = `
    <div class="report-section">
      <div class="report-header">
        <h3 class="report-title"><i class="fas fa-money-bill-wave"></i> مصروفات الطالب ${student.name}</h3>
      </div>
      
      <div class="fees-grid">
        ${months.map(month => `
          <div class="fee-item">
            <span>${month}</span>
            <input type="checkbox" onchange="updateFee('${id}','${month}',this.checked)" 
                   ${student.fees?.[month] ? 'checked' : ''} style="transform: scale(1.2);">
          </div>
        `).join('')}
      </div>
    </div>
  `;
  
  document.getElementById('studentDetailContent').innerHTML = html;
}

function updateFee(id, month, paid) {
  if (!students[id].fees) {
    students[id].fees = {};
  }
  students[id].fees[month] = paid;
  showSuccess('تم تحديث حالة المصروفات بنجاح');
  updateStats();
}

function generateQRCode(id, phone) {
  const qrCodeContainer = document.getElementById(`qr-code-${id}`);
  qrCodeContainer.innerHTML = '';
  
  new QRCode(qrCodeContainer, {
    text: `https://wa.me/${phone}?text=حاضر`,
    width: 150,
    height: 150,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });
  
  Swal.fire({
    title: 'تم إنشاء QR Code',
    html: `
      <div style="text-align: center;">
        <p>يمكن استخدام هذا الكود لتأكيد حضور الطالب</p>
        <div id="qr-code-display" style="margin: 15px auto;"></div>
        <button class="btn btn-success" onclick="downloadQRCode('${id}')">
          <i class="fas fa-download"></i> تحميل QR Code
        </button>
      </div>
    `,
    showConfirmButton: false
  });
  
  new QRCode(document.getElementById('qr-code-display'), {
    text: `https://wa.me/${phone}?text=حاضر`,
    width: 200,
    height: 200,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });
}

function downloadQRCode(id) {
  const qrCodeElement = document.getElementById(`qr-code-${id}`);
  html2canvas(qrCodeElement).then(canvas => {
    const link = document.createElement('a');
    link.download = `qr-code-${id}.png`;
    link.href = canvas.toDataURL();
    link.click();
  });
}

function showTrash() {
  let html = `
    <div class="trash-list">
      <h3><i class="fas fa-trash"></i> سلة المهملات</h3>
      <p>إجمالي الطلاب المحذوفين: ${Object.keys(trash).length}</p>
  `;

  if (Object.keys(trash).length === 0) {
    html += `
      <div class="no-students">
        <h3><i class="fas fa-trash-restore"></i> سلة المهملات فارغة</h3>
      </div>
    `;
  } else {
    for (let id in trash) {
      const student = trash[id];
      html += `
        <div class="trash-item">
          <div class="trash-info">
            <div><strong>${student.name}</strong></div>
            <div>كود: ${id} | الصف: ${student.main}</div>
            <div><small>تم الحذف في: ${student.deletedAt || 'غير معروف'}</small></div>
          </div>
          <div class="trash-actions">
            <button class="btn btn-success btn-small" onclick="restoreStudent('${id}')">
              <i class="fas fa-trash-restore"></i> استعادة
            </button>
            <button class="btn btn-danger btn-small" onclick="permanentDelete('${id}')">
              <i class="fas fa-trash-alt"></i> حذف نهائي
            </button>
          </div>
        </div>
      `;
    }
  }

  html += `</div>`;
  document.getElementById('trashContent').innerHTML = html;
  document.getElementById('trashModal').style.display = 'block';
  toggleSidebar();
}

function restoreStudent(id) {
  if (trash[id]) {
    students[id] = trash[id];
    delete trash[id];
    saveToGitHub();
    saveTrashToGitHub();
    showTrash();
    renderStudentCards();
    showSuccess('تم استعادة الطالب بنجاح');
  }
}

function permanentDelete(id) {
  Swal.fire({
    title: 'هل أنت متأكد؟',
    text: 'سيتم حذف هذا الطالب نهائياً ولا يمكن استعادته!',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'نعم، احذف نهائياً',
    cancelButtonText: 'إلغاء'
  }).then((result) => {
    if (result.isConfirmed) {
      delete trash[id];
      saveTrashToGitHub();
      showTrash();
      showSuccess('تم الحذف النهائي للطالب');
    }
  });
}

function searchStudent() {
  const id = document.getElementById('searchId').value.trim();
  if (!id) {
    Swal.fire({
      title: 'تنبيه',
      text: 'الرجاء إدخال كود الطالب للبحث',
      icon: 'warning'
    });
    return;
  }

  if (students[id]) {
    showStudentDetails(id);
  } else {
    Swal.fire({
      title: '⚠️ تنبيه',
      text: 'لم يتم العثور على الطالب',
      confirmButtonText: 'حسناً'
    });
  }
}

function showGradeModal() {
  document.getElementById('studentDetailModal').style.display = 'block';
  document.getElementById('studentDetailContent').innerHTML = `
    <div style="padding: 20px;">
      <h3 style="margin-bottom: 20px;"><i class="fas fa-filter"></i> اختر الصف لعرض الطلاب</h3>
      <select id="gradeSelect" style="width: 100%; margin-bottom: 20px;">
        <option value="">عرض جميع الطلاب</option>
      </select>
      <div class="modal-footer">
        <button class="btn" onclick="document.getElementById('studentDetailModal').style.display = 'none'">
          <i class="fas fa-times"></i> إلغاء
        </button>
        <button class="btn" onclick="filterByGrade()">
          <i class="fas fa-eye"></i> عرض
        </button>
      </div>
    </div>
  `;
  
  // تعبئة قائمة الصفوف
  const select = document.getElementById('gradeSelect');
  select.innerHTML = '<option value="">عرض جميع الطلاب</option>';
  grades.forEach(grade => {
    select.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
}

function filterByGrade() {
  const gradeSelect = document.getElementById('gradeSelect');
  const selectedGrade = gradeSelect.value;
  renderStudentCards(selectedGrade);
  document.getElementById('studentDetailModal').style.display = 'none';
}

function showAddModal() {
  currentStudentId = null;
  document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus"></i> إضافة طالب جديد';
  
  // توليد كود تلقائي وتعطيل الحقل
  const studentIdField = document.getElementById('studentId');
  studentIdField.value = generateStudentId();
  studentIdField.disabled = true;
  
  document.getElementById('studentName').value = '';
  document.getElementById('studentPhone').value = '';
  document.getElementById('studentLevel').value = '';
  document.getElementById('studentImagePreview').style.display = 'none';
  document.getElementById('imageActions').style.display = 'none';
  studentImageFile = null;
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '<option value="" disabled selected>اختر الصف</option>';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
  toggleSidebar();
  
  // Focus على حقل الاسم
  setTimeout(() => {
    document.getElementById('studentName').focus();
  }, 100);
}

function showEditModal(id) {
  currentStudentId = id;
  const student = students[id];
  
  document.getElementById('modalTitle').innerHTML = `<i class="fas fa-user-edit"></i> تعديل بيانات الطالب ${id}`;
  
  // تمكين حقل الكود في حالة التعديل
  const studentIdField = document.getElementById('studentId');
  studentIdField.value = id;
  studentIdField.disabled = false;
  
  document.getElementById('studentName').value = student.name;
  document.getElementById('studentPhone').value = student.phone || '';
  document.getElementById('studentLevel').value = student.info || '';
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}" ${grade === student.main ? 'selected' : ''}>${grade}</option>`;
  });
  
  // عرض الصورة إذا كانت موجودة
  const preview = document.getElementById('studentImagePreview');
  const actions = document.getElementById('imageActions');
  if (student.image) {
    preview.src = student.image;
    preview.style.display = 'block';
    actions.style.display = 'flex';
  } else {
    preview.style.display = 'none';
    actions.style.display = 'none';
  }
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
}

function previewStudentImage() {
  const fileInput = document.getElementById('studentImage');
  const preview = document.getElementById('studentImagePreview');
  const actions = document.getElementById('imageActions');
  
  if (fileInput.files && fileInput.files[0]) {
    studentImageFile = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
      actions.style.display = 'flex';
    }
    
    reader.readAsDataURL(fileInput.files[0]);
  }
}

function removeImage() {
  const preview = document.getElementById('studentImagePreview');
  const actions = document.getElementById('imageActions');
  const fileInput = document.getElementById('studentImage');
  
  preview.src = '';
  preview.style.display = 'none';
  actions.style.display = 'none';
  fileInput.value = '';
  studentImageFile = null;
}

function showNotesModal(id) {
  currentStudentId = id;
  const student = students[id];
  
  document.getElementById('notesContent').value = student.notes || '';
  document.getElementById('notesModal').style.display = 'block';
}

function saveNotes() {
  const notes = document.getElementById('notesContent').value.trim();
  if (currentStudentId) {
    students[currentStudentId].notes = notes;
    renderStudentCards();
    closeModal();
    showSuccess('تم حفظ الملاحظات بنجاح');
  }
}

function showDeleteModal(id) {
  if (id) {
    deleteStudentId = id;
    const student = students[id];
    document.getElementById('deleteStudentInfo').style.display = 'block';
    document.getElementById('deleteStudentSelectContainer').style.display = 'none';
    
    document.getElementById('deleteStudentName').textContent = student.name;
    document.getElementById('deleteStudentId').textContent = `كود: ${id}`;
    document.getElementById('deleteStudentGrade').textContent = student.main;
  } else {
    deleteStudentId = null;
    document.getElementById('deleteStudentInfo').style.display = 'none';
    document.getElementById('deleteStudentSelectContainer').style.display = 'block';
    
    const select = document.getElementById('deleteStudentSelect');
    select.innerHTML = '<option value="" disabled selected>اختر الطالب للحذف</option>';
    
    for (let id in students) {
      const student = students[id];
      select.innerHTML += `<option value="${id}">${id} - ${student.name} (${student.main})</option>`;
    }
  }
  
  document.getElementById('deleteModal').style.display = 'block';
  toggleSidebar();
}

function closeModal() {
  document.getElementById('studentModal').style.display = 'none';
  document.getElementById('deleteModal').style.display = 'none';
  document.getElementById('notesModal').style.display = 'none';
  document.getElementById('studentDetailModal').style.display = 'none';
  document.getElementById('trashModal').style.display = 'none';
}

function closePostModal() {
  document.getElementById('postModal').style.display = 'none';
}

function closeImageModal() {
  document.getElementById('imageModal').style.display = 'none';
}

function expandImage(img) {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('expandedImage');
  modal.style.display = 'block';
  modalImg.src = img.src;
}

function saveStudent() {
  const id = document.getElementById('studentId').value.trim();
  const name = document.getElementById('studentName').value.trim();
  const grade = document.getElementById('studentGrade').value;
  const phone = document.getElementById('studentPhone').value.trim();
  const level = document.getElementById('studentLevel').value;
  
  if (!id) {
    showError('يجب إدخال كود الطالب');
    document.getElementById('studentId').focus();
    return;
  }
  
  if (!name) {
    showError('يجب إدخال اسم الطالب');
    document.getElementById('studentName').focus();
    return;
  }
  
  if (!grade) {
    showError('يجب اختيار الصف');
    document.getElementById('studentGrade').focus();
    return;
  }
  
  if (currentStudentId === null && students[id]) {
    showError('كود الطالب موجود مسبقاً');
    document.getElementById('studentId').focus();
    return;
  }
  
  if (currentStudentId === null) {
    // Add new student
    students[id] = {
      name,
      main: grade,
      info: level || undefined,
      phone: phone || undefined,
      notes: '',
      attendance: Object.fromEntries(weekDays.map(day => [day, "-"])),
      fees: Object.fromEntries(months.map(month => [month, false]))
    };
    
    // Add QR code to notes if phone exists
    if (phone) {
      students[id].notes = `QR Code لرقم ولي الأمر: https://wa.me/${phone}?text=حاضر\n\n`;
    }
    
    // Handle image upload if exists
    if (studentImageFile) {
      const reader = new FileReader();
      reader.onload = function(e) {
        students[id].image = e.target.result;
        renderStudentCards();
        document.getElementById('studentsCountNumber').textContent = Object.keys(students).length;
        closeModal();
        showSuccess('تم إضافة الطالب بنجاح');
      };
      reader.readAsDataURL(studentImageFile);
    } else {
      renderStudentCards();
      document.getElementById('studentsCountNumber').textContent = Object.keys(students).length;
      closeModal();
      showSuccess('تم إضافة الطالب بنجاح');
    }
  } else {
    // Update existing student
    if (currentStudentId !== id) {
      // If ID changed, we need to create new entry and delete old one
      students[id] = {
        name,
        main: grade,
        info: level || undefined,
        phone: phone || undefined,
        notes: students[currentStudentId].notes || '',
        attendance: {...students[currentStudentId].attendance},
        fees: {...students[currentStudentId].fees},
        image: students[currentStudentId].image || undefined
      };
      delete students[currentStudentId];
    } else {
      // Just update the existing student
      students[id].name = name;
      students[id].main = grade;
      students[id].info = level || undefined;
      students[id].phone = phone || undefined;
      
      // Update QR code in notes if phone exists
      if (phone && !students[id].notes.includes('QR Code')) {
        students[id].notes = `QR Code لرقم ولي الأمر: https://wa.me/${phone}?text=حاضر\n\n${students[id].notes}`;
      }
    }
    
    // Handle image upload if exists
    if (studentImageFile) {
      const reader = new FileReader();
      reader.onload = function(e) {
        students[id].image = e.target.result;
        renderStudentCards();
        closeModal();
        showSuccess('تم تحديث بيانات الطالب بنجاح');
      };
      reader.readAsDataURL(studentImageFile);
    } else {
      // Only update image if it wasn't removed
      if (document.getElementById('studentImagePreview').style.display === 'none' && students[id].image) {
        delete students[id].image;
      }
      renderStudentCards();
      closeModal();
      showSuccess('تم تحديث بيانات الطالب بنجاح');
    }
  }
}

function confirmDelete() {
  if (!deleteStudentId) {
    const select = document.getElementById('deleteStudentSelect');
    if (!select.value) {
      showError('الرجاء اختيار طالب للحذف');
      return;
    }
    deleteStudentId = select.value;
  }
  
  if (deleteStudentId) {
    // Move student to trash
    trash[deleteStudentId] = {
      ...students[deleteStudentId],
      deletedAt: new Date().toLocaleString('ar-EG')
    };
    
    delete students[deleteStudentId];
    saveToGitHub();
    saveTrashToGitHub();
    renderStudentCards();
    document.getElementById('studentsCountNumber').textContent = Object.keys(students).length;
    closeModal();
    showSuccess('تم حذف الطالب بنجاح');
    deleteStudentId = null;
  }
}

async function saveTrashToGitHub() {
  const token = document.getElementById('token').value.trim();
  if (!token) return;

  const content = JSON.stringify(trash, null, 2);
  const utf8Content = unescape(encodeURIComponent(content));
  const encoded = btoa(utf8Content);

  try {
    // تحقق مما إذا كان الملف موجودًا بالفعل للحصول على SHA
    let sha = '';
    try {
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${trashPath}`, {
        headers: {
          'Authorization': `token ${token}`
        }
      });
      
      if (res.ok) {
        const data = await res.json();
        sha = data.sha;
      }
    } catch (error) {
      console.log('ملف سلة المهملات غير موجود، سيتم إنشاء ملف جديد');
    }
    
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${trashPath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: "تحديث سلة المهملات",
        content: encoded,
        sha: sha || undefined,
        branch: branch
      })
    });

    if (!res.ok) {
      const error = await res.json();
      console.error('فشل في حفظ سلة المهملات:', error);
    }
  } catch (error) {
    console.error('خطأ في حفظ سلة المهملات:', error);
  }
}

// وظائف المنشورات
function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
  document.getElementById(`${tabName}-tab`).classList.add('active');
  
  // إذا كان تبويب التقارير، قم بتحميل التقارير
  if (tabName === 'reports') {
    showReports('stats');
  }
}

function showPostModal(postId = null) {
  currentPostId = postId;
  postImageFile = null;
  
  if (postId) {
    // وضع التعديل
    document.getElementById('postModalTitle').innerHTML = '<i class="fas fa-edit"></i> تعديل المنشور';
    const post = posts[postId];
    document.getElementById('editPostTitle').value = post.title;
    document.getElementById('editPostContent').value = post.content;
    
    // عرض الصورة إذا كانت موجودة
    const preview = document.getElementById('postImagePreview');
    const actions = document.getElementById('postImageActions');
    if (post.image) {
      preview.src = post.image;
      preview.style.display = 'block';
      actions.style.display = 'flex';
    } else {
      preview.style.display = 'none';
      actions.style.display = 'none';
    }
  } else {
    // وضع الإضافة
    document.getElementById('postModalTitle').innerHTML = '<i class="fas fa-plus"></i> منشور جديد';
    document.getElementById('editPostTitle').value = '';
    document.getElementById('editPostContent').value = '';
    document.getElementById('postImagePreview').style.display = 'none';
    document.getElementById('postImageActions').style.display = 'none';
  }
  
  document.getElementById('savePostBtn').onclick = savePost;
  document.getElementById('postModal').style.display = 'block';
}

function previewPostImage() {
  const fileInput = document.getElementById('postImageInput');
  const preview = document.getElementById('postImagePreview');
  const actions = document.getElementById('postImageActions');
  
  if (fileInput.files && fileInput.files[0]) {
    postImageFile = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
      actions.style.display = 'flex';
    }
    
    reader.readAsDataURL(fileInput.files[0]);
  }
}

function removePostImage() {
  const preview = document.getElementById('postImagePreview');
  const actions = document.getElementById('postImageActions');
  const fileInput = document.getElementById('postImageInput');
  
  preview.src = '';
  preview.style.display = 'none';
  actions.style.display = 'none';
  fileInput.value = '';
  postImageFile = null;
}

function savePost() {
  const title = document.getElementById('editPostTitle').value.trim();
  const content = document.getElementById('editPostContent').value.trim();
  
  if (!title) {
    showError('الرجاء إدخال عنوان للمنشور');
    return;
  }
  
  if (!content) {
    showError('الرجاء إدخال محتوى للمنشور');
    return;
  }
  
  const postId = currentPostId || Date.now().toString();
  
  if (!currentPostId) {
    // منشور جديد
    posts[postId] = {
      title,
      content,
      likes: 0,
      likedBy: [],
      shares: 0,
      date: new Date().toLocaleString('ar-EG'),
      author: 'المدير'
    };
    
    // Handle image upload if exists
    if (postImageFile) {
      const reader = new FileReader();
      reader.onload = function(e) {
        posts[postId].image = e.target.result;
        savePostsToGitHub();
        renderPosts();
        closePostModal();
        showSuccess('تم نشر المنشور بنجاح');
      };
      reader.readAsDataURL(postImageFile);
    } else {
      savePostsToGitHub();
      renderPosts();
      closePostModal();
      showSuccess('تم نشر المنشور بنجاح');
    }
  } else {
    // تعديل منشور موجود
    posts[postId].title = title;
    posts[postId].content = content;
    
    // Handle image upload if exists
    if (postImageFile) {
      const reader = new FileReader();
      reader.onload = function(e) {
        posts[postId].image = e.target.result;
        savePostsToGitHub();
        renderPosts();
        closePostModal();
        showSuccess('تم تحديث المنشور بنجاح');
      };
      reader.readAsDataURL(postImageFile);
    } else {
      // Only update image if it wasn't removed
      if (document.getElementById('postImagePreview').style.display === 'none' && posts[postId].image) {
        delete posts[postId].image;
      }
      savePostsToGitHub();
      renderPosts();
      closePostModal();
      showSuccess('تم تحديث المنشور بنجاح');
    }
  }
}

function renderPosts() {
  const postsList = document.getElementById('postsList');
  postsList.innerHTML = '';
  
  if (Object.keys(posts).length === 0) {
    postsList.innerHTML = `
      <div class="no-students">
        <h3><i class="fas fa-info-circle"></i> لا يوجد منشورات حالياً</h3>
      </div>
    `;
    return;
  }
  
  // ترتيب المنشورات من الأحدث إلى الأقدم
  const sortedPosts = Object.entries(posts).sort((a, b) => new Date(b[1].date) - new Date(a[1].date));
  
  sortedPosts.forEach(([id, post]) => {
    const postElement = document.createElement('div');
    postElement.className = 'post';
    
    let imageHtml = '';
    if (post.image) {
      imageHtml = `<img src="${post.image}" class="post-image" alt="صورة المنشور" onclick="expandImage(this)">`;
    }
    
    postElement.innerHTML = `
      <div class="post-delete" onclick="deletePost('${id}')">
        <i class="fas fa-trash"></i>
      </div>
      <div class="post-header">
        <div class="post-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div>
          <div class="post-author">${post.author}</div>
          <div class="post-date">${post.date}</div>
        </div>
      </div>
      <div class="post-content">
        <h3>${post.title}</h3>
        <p>${post.content.replace(/\n/g, '<br>')}</p>
        ${imageHtml}
      </div>
      <div class="post-actions">
        <div class="post-action ${post.likedBy && post.likedBy.includes('admin') ? 'liked' : ''}" 
             onclick="toggleLike('${id}')">
          <i class="fas fa-heart"></i>
          <span>${post.likes || 0} إعجاب</span>
        </div>
        <div class="post-action" onclick="sharePost('${id}')">
          <i class="fas fa-share"></i>
          <span>${post.shares || 0} مشاركة</span>
        </div>
        <div class="post-action" onclick="showPostModal('${id}')">
          <i class="fas fa-edit"></i>
          <span>تعديل</span>
        </div>
      </div>
    `;
    postsList.appendChild(postElement);
  });
}

function deletePost(postId) {
  Swal.fire({
    title: 'هل أنت متأكد؟',
    text: 'سيتم حذف هذا المنشور ولا يمكن التراجع عن هذا الإجراء!',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'نعم، احذف',
    cancelButtonText: 'إلغاء'
  }).then((result) => {
    if (result.isConfirmed) {
      delete posts[postId];
      savePostsToGitHub();
      renderPosts();
      showSuccess('تم حذف المنشور بنجاح');
    }
  });
}

function toggleLike(postId) {
  const post = posts[postId];
  const user = 'admin'; // يمكن تغيير هذا إذا كان لديك نظام مستخدمين
  
  if (!post.likedBy) {
    post.likedBy = [];
  }
  
  if (post.likedBy.includes(user)) {
    // إزالة الإعجاب
    post.likes--;
    post.likedBy = post.likedBy.filter(u => u !== user);
  } else {
    // إضافة إعجاب
    post.likes = (post.likes || 0) + 1;
    post.likedBy.push(user);
  }
  
  savePostsToGitHub();
  renderPosts();
}

function sharePost(postId) {
  const post = posts[postId];
  let shareText = `${post.title}\n\n${post.content}\n\nتاريخ النشر: ${post.date}`;
  const shareUrl = encodeURIComponent(window.location.href);
  const encodedText = encodeURIComponent(shareText);
  
  // زيادة عدد المشاركات
  post.shares = (post.shares || 0) + 1;
  savePostsToGitHub();
  renderPosts();
  
  // إنشاء محتوى المشاركة
  let shareHtml = `
    <div style="text-align: right;">
      <p>اختر طريقة المشاركة:</p>
      <div class="share-buttons">
        <a href="https://www.facebook.com/sharer/sharer.php?u=${shareUrl}&quote=${encodedText}" 
           target="_blank" class="share-btn facebook">
          <i class="fab fa-facebook-f"></i> فيسبوك
        </a>
        <a href="https://wa.me/?text=${encodedText}" 
           target="_blank" class="share-btn whatsapp">
          <i class="fab fa-whatsapp"></i> واتساب
        </a>
        <a href="https://t.me/share/url?url=${shareUrl}&text=${encodedText}" 
           target="_blank" class="share-btn telegram">
          <i class="fab fa-telegram-plane"></i> تيليجرام
        </a>
  `;
  
  // إضافة زر تحميل الصورة إذا كان المنشور يحتوي على صورة
  if (post.image) {
    shareHtml += `
        <a href="#" onclick="downloadPostImage('${postId}')" class="share-btn" style="background-color: #4CAF50;">
          <i class="fas fa-download"></i> تحميل الصورة
        </a>
    `;
  }
  
  shareHtml += `
      </div>
    </div>
  `;
  
  Swal.fire({
    title: 'مشاركة المنشور',
    html: shareHtml,
    showConfirmButton: false,
    width: '600px'
  });
}

function downloadPostImage(postId) {
  const post = posts[postId];
  if (post.image) {
    const link = document.createElement('a');
    link.href = post.image;
    link.download = `منشور_${postId}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}

async function savePostsToGitHub() {
  const token = document.getElementById('token').value.trim();
  if (!token) {
    showError('الرجاء إدخال توكن GitHub أولاً');
    document.getElementById('token').focus();
    return;
  }

  const content = JSON.stringify(posts, null, 2);
  const utf8Content = unescape(encodeURIComponent(content));
  const encoded = btoa(utf8Content);

  try {
    showLoading(true);
    
    // تحقق مما إذا كان الملف موجودًا بالفعل للحصول على SHA
    let sha = '';
    try {
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`, {
        headers: {
          'Authorization': `token ${token}`
        }
      });
      
      if (res.ok) {
        const data = await res.json();
        sha = data.sha;
      }
    } catch (error) {
      console.log('الملف غير موجود، سيتم إنشاء ملف جديد');
    }
    
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: "تحديث المنشورات من لوحة التحكم",
        content: encoded,
        sha: sha || undefined,
        branch: branch
      })
    });

    if (res.ok) {
      const data = await res.json();
      showSuccess('تم حفظ المنشورات بنجاح على GitHub');
    } else {
      const error = await res.json();
      showError(`فشل في حفظ المنشورات! ${error.message}`);
    }
  } catch (error) {
    showError(`خطأ في الاتصال: ${error.message}`);
  } finally {
    showLoading(false);
  }
}

async function saveToGitHub() {
  const token = document.getElementById('token').value.trim();
  if (!token) {
    showError('الرجاء إدخال توكن GitHub أولاً');
    document.getElementById('token').focus();
    return;
  }
  localStorage.setItem("gh_token", token);

  // حفظ بيانات الطلاب
  const content = JSON.stringify(students, null, 2);
  const utf8Content = unescape(encodeURIComponent(content));
  const encoded = btoa(utf8Content);

  try {
    showLoading(true);
    const saveBtn = document.querySelector('button[onclick="saveToGitHub()"]');
    originalButtonText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="spinner"></span> جاري الحفظ...';
    saveBtn.disabled = true;
    
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: "تحديث بيانات الطلاب من لوحة التحكم",
        content: encoded,
        sha: sha,
        branch: branch
      })
    });

    if (res.ok) {
      const data = await res.json();
      sha = data.content.sha;
      showSuccess('تم حفظ البيانات بنجاح على GitHub');
      loadStudents();
    } else {
      const error = await res.json();
      showError(`فشل في الحفظ! ${error.message}`);
    }
  } catch (error) {
    showError(`خطأ في الاتصال: ${error.message}`);
  } finally {
    showLoading(false);
    const saveBtn = document.querySelector('button[onclick="saveToGitHub()"]');
    if (saveBtn) {
      saveBtn.innerHTML = originalButtonText;
      saveBtn.disabled = false;
    }
  }
}

function showLoading(show) {
  isLoading = show;
  const loader = document.createElement('div');
  loader.id = 'loadingOverlay';
  loader.style.position = 'fixed';
  loader.style.top = '0';
  loader.style.left = '0';
  loader.style.width = '100%';
  loader.style.height = '100%';
  loader.style.backgroundColor = 'rgba(0,0,0,0.5)';
  loader.style.display = 'flex';
  loader.style.justifyContent = 'center';
  loader.style.alignItems = 'center';
  loader.style.zIndex = '9998';
  loader.innerHTML = `
    <div style="background: var(--white); padding: 30px; border-radius: 12px; text-align: center; box-shadow: var(--shadow);">
      <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 15px; border-top-color: var(--primary-color);"></div>
      <p style="font-weight: bold; color: var(--text-color);">جاري التحميل...</p>
    </div>
  `;
  
  if (show) {
    document.body.appendChild(loader);
  } else {
    const existingLoader = document.getElementById('loadingOverlay');
    if (existingLoader) {
      existingLoader.remove();
    }
  }
}

function showError(message) {
  Swal.fire({
    title: '❌ خطأ',
    text: message,
    icon: 'error',
    confirmButtonText: 'حسناً'
  });
}

function showSuccess(message) {
  Swal.fire({
    title: '✅ تم بنجاح',
    text: message,
    icon: 'success',
    confirmButtonText: 'حسناً'
  });
}

// وظائف التقارير
function showReports(reportType) {
  // إخفاء جميع التقارير أولاً
  document.querySelectorAll('.report-section').forEach(section => {
    section.classList.remove('active');
  });
  
  // إظهار التقرير المطلوب
  document.getElementById(`${reportType}Report`).classList.add('active');
  
  // إذا كان التقرير المطلوب هو المصروفات أو الحضور، قم بتحميل البيانات
  if (reportType === 'fees') {
    showFeesReport();
  } else if (reportType === 'attendance') {
    showAttendanceReport();
  } else if (reportType === 'stats') {
    updateStats();
  }
}

function updateStats() {
  const today = new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
  
  let totalStudents = Object.keys(students).length;
  let todayPresent = 0;
  let todayAbsent = 0;
  let paidFees = 0;
  let unpaidFees = 0;
  
  for (let id in students) {
    const student = students[id];
    
    // حساب الحضور والغياب لليوم
    if (student.attendance?.[today] === 'حاضر') {
      todayPresent++;
    } else if (student.attendance?.[today] === 'غائب') {
      todayAbsent++;
    }
    
    // حساب المصروفات
    let hasPaid = false;
    for (let month in student.fees) {
      if (student.fees[month]) {
        hasPaid = true;
        break;
      }
    }
    
    if (hasPaid) {
      paidFees++;
    } else {
      unpaidFees++;
    }
  }
  
  document.getElementById('totalStudentsCount').textContent = totalStudents;
  document.getElementById('todayPresentCount').textContent = todayPresent;
  document.getElementById('todayAbsentCount').textContent = todayAbsent;
  document.getElementById('paidFeesCount').textContent = paidFees;
  document.getElementById('unpaidFeesCount').textContent = unpaidFees;
}

function showFeesReport() {
  const gradeFilter = document.getElementById('feesGradeFilter').value;
  const monthFilter = document.getElementById('feesMonthFilter').value;
  const statusFilter = document.getElementById('feesStatusFilter').value;
  
  let html = '';
  let count = 0;
  
  for (let id in students) {
    const student = students[id];
    
    // تطبيق الفلاتر
    if (gradeFilter && student.main !== gradeFilter) continue;
    
    // تحقق من حالة المصروفات إذا كان هناك فلتر شهر
    if (monthFilter) {
      if (statusFilter === 'paid' && !student.fees?.[monthFilter]) continue;
      if (statusFilter === 'unpaid' && student.fees?.[monthFilter]) continue;
    } else if (statusFilter) {
      // إذا كان هناك فلتر حالة بدون فلتر شهر، تحقق من حالة المصروفات في أي شهر
      let hasPaid = false;
      for (let month in student.fees) {
        if (student.fees[month]) {
          hasPaid = true;
          break;
        }
      }
      
      if (statusFilter === 'paid' && !hasPaid) continue;
      if (statusFilter === 'unpaid' && hasPaid) continue;
    }
    
    count++;
    
    html += `
      <tr>
        <td>${id}</td>
        <td>${student.name}</td>
        <td>${student.main}</td>
        ${months.map(month => `
          <td style="background-color: ${student.fees?.[month] ? '#e8f5e9' : '#ffebee'};">
            ${student.fees?.[month] ? '✔️' : '❌'}
          </td>
        `).join('')}
      </tr>
    `;
  }
  
  document.getElementById('feesReportBody').innerHTML = count > 0 ? html : `
    <tr>
      <td colspan="12" style="text-align: center; padding: 20px;">
        لا يوجد بيانات متطابقة مع معايير البحث
      </td>
    </tr>
  `;
  
  // إضافة إجمالي المصروفات
  let summaryHtml = `
    <tr style="font-weight: bold; background-color: #e3f2fd;">
      <td colspan="3">الإجمالي</td>
      ${months.map(month => {
        let paidCount = 0;
        for (let id in students) {
          if (students[id].fees?.[month]) paidCount++;
        }
        return `<td>${paidCount}/${Object.keys(students).length}</td>`;
      }).join('')}
    </tr>
  `;
  
  document.getElementById('feesReportBody').insertAdjacentHTML('beforeend', summaryHtml);
}

function filterFeesReport() {
  showFeesReport();
}

function generateFeesReport() {
  const doc = new jsPDF();
  
  // Add title
  doc.setFont('Tajawal', 'normal');
  doc.setTextColor(33, 150, 243);
  doc.setFontSize(22);
  doc.text('تقرير مصروفات الطلاب', 105, 15, null, null, 'center');
  
  // Add date
  doc.setFontSize(12);
  doc.setTextColor(100, 100, 100);
  doc.text(`تاريخ التصدير: ${new Date().toLocaleDateString('ar-EG')}`, 105, 25, null, null, 'center');
  
  // Add filters info
  const gradeFilter = document.getElementById('feesGradeFilter').value;
  const monthFilter = document.getElementById('feesMonthFilter').value;
  const statusFilter = document.getElementById('feesStatusFilter').value;
  
  let filtersText = 'الفلاتر المطبقة: ';
  if (gradeFilter) filtersText += `الصف: ${gradeFilter}، `;
  if (monthFilter) filtersText += `الشهر: ${monthFilter}، `;
  if (statusFilter) filtersText += `الحالة: ${statusFilter === 'paid' ? 'مسددة' : 'غير مسددة'}`;
  
  if (filtersText === 'الفلاتر المطبقة: ') {
    filtersText += 'لا يوجد';
  }
  
  doc.text(filtersText, 14, 35);
  
  // Create table
  const headers = [
    'كود الطالب',
    'الاسم',
    'الصف',
    ...months
  ];
  
  const data = [];
  
  for (let id in students) {
    const student = students[id];
    
    // تطبيق الفلاتر
    if (gradeFilter && student.main !== gradeFilter) continue;
    
    // تحقق من حالة المصروفات إذا كان هناك فلتر شهر
    if (monthFilter) {
      if (statusFilter === 'paid' && !student.fees?.[monthFilter]) continue;
      if (statusFilter === 'unpaid' && student.fees?.[monthFilter]) continue;
    } else if (statusFilter) {
      // إذا كان هناك فلتر حالة بدون فلتر شهر، تحقق من حالة المصروفات في أي شهر
      let hasPaid = false;
      for (let month in student.fees) {
        if (student.fees[month]) {
          hasPaid = true;
          break;
        }
      }
      
      if (statusFilter === 'paid' && !hasPaid) continue;
      if (statusFilter === 'unpaid' && hasPaid) continue;
    }
    
    data.push([
      id,
      student.name,
      student.main,
      ...months.map(month => student.fees?.[month] ? '✔️' : '❌')
    ]);
  }
  
  // Add table to PDF
  doc.autoTable({
    head: [headers],
    body: data,
    startY: 45,
    styles: {
      font: 'Tajawal',
      fontStyle: 'normal',
      textColor: [0, 0, 0],
      halign: 'right'
    },
    headStyles: {
      fillColor: [25, 118, 210],
      textColor: [255, 255, 255],
      fontStyle: 'bold'
    },
    alternateRowStyles: {
      fillColor: [248, 250, 252]
    },
    columnStyles: {
      0: { cellWidth: 30 },
      1: { cellWidth: 40 },
      2: { cellWidth: 40 },
      ...Object.fromEntries(months.map((_, i) => [i + 3, { cellWidth: 15 }]))
    }
  });
  
  // Add summary
  let y = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(14);
  doc.setTextColor(33, 150, 243);
  doc.text('ملخص المصروفات:', 14, y);
  y += 10;
  
  doc.setFontSize(12);
  doc.setTextColor(0, 0, 0);
  
  months.forEach(month => {
    let paidCount = 0;
    for (let id in students) {
      if (students[id].fees?.[month]) paidCount++;
    }
    
    doc.text(`${month}: ${paidCount} مسددة / ${Object.keys(students).length} إجمالي`, 14, y);
    y += 8;
  });
  
  // Save the PDF
  doc.save('تقرير_المصروفات.pdf');
}

function showAttendanceReport() {
  const gradeFilter = document.getElementById('attendanceGradeFilter').value;
  const dayFilter = document.getElementById('attendanceDayFilter').value;
  const statusFilter = document.getElementById('attendanceStatusFilter').value;
  
  let html = '';
  let count = 0;
  
  for (let id in students) {
    const student = students[id];
    
    // تطبيق الفلاتر
    if (gradeFilter && student.main !== gradeFilter) continue;
    
    // تحقق من حالة الحضور إذا كان هناك فلتر يوم
    if (dayFilter) {
      if (statusFilter && student.attendance?.[dayFilter] !== statusFilter) continue;
    } else if (statusFilter) {
      // إذا كان هناك فلتر حالة بدون فلتر يوم، تحقق من حالة الحضور في أي يوم
      let hasStatus = false;
      for (let day in student.attendance) {
        if (student.attendance[day] === statusFilter) {
          hasStatus = true;
          break;
        }
      }
      
      if (!hasStatus) continue;
    }
    
    count++;
    
    html += `
      <tr>
        <td>${id}</td>
        <td>${student.name}</td>
        <td>${student.main}</td>
        ${weekDays.map(day => `
          <td style="background-color: ${student.attendance?.[day] === 'حاضر' ? '#e8f5e9' : 
                                      student.attendance?.[day] === 'غائب' ? '#ffebee' : '#fff8e1'};">
            ${student.attendance?.[day] || '-'}
          </td>
        `).join('')}
      </tr>
    `;
  }
  
  document.getElementById('attendanceReportBody').innerHTML = count > 0 ? html : `
    <tr>
      <td colspan="10" style="text-align: center; padding: 20px;">
        لا يوجد بيانات متطابقة مع معايير البحث
      </td>
    </tr>
  `;
  
  // إضافة إجمالي الحضور
  let summaryHtml = `
    <tr style="font-weight: bold; background-color: #e3f2fd;">
      <td colspan="3">الإجمالي</td>
      ${weekDays.map(day => {
        let presentCount = 0;
        let absentCount = 0;
        for (let id in students) {
          if (students[id].attendance?.[day] === 'حاضر') presentCount++;
          else if (students[id].attendance?.[day] === 'غائب') absentCount++;
        }
        return `<td>ح: ${presentCount}<br>غ: ${absentCount}</td>`;
      }).join('')}
    </tr>
  `;
  
  document.getElementById('attendanceReportBody').insertAdjacentHTML('beforeend', summaryHtml);
}

function filterAttendanceReport() {
  showAttendanceReport();
}

function generateAttendanceReport() {
  const doc = new jsPDF();
  
  // Add title
  doc.setFont('Tajawal', 'normal');
  doc.setTextColor(33, 150, 243);
  doc.setFontSize(22);
  doc.text('تقرير الحضور والغياب', 105, 15, null, null, 'center');
  
  // Add date
  doc.setFontSize(12);
  doc.setTextColor(100, 100, 100);
  doc.text(`تاريخ التصدير: ${new Date().toLocaleDateString('ar-EG')}`, 105, 25, null, null, 'center');
  
  // Add filters info
  const gradeFilter = document.getElementById('attendanceGradeFilter').value;
  const dayFilter = document.getElementById('attendanceDayFilter').value;
  const statusFilter = document.getElementById('attendanceStatusFilter').value;
  
  let filtersText = 'الفلاتر المطبقة: ';
  if (gradeFilter) filtersText += `الصف: ${gradeFilter}، `;
  if (dayFilter) filtersText += `اليوم: ${dayFilter}، `;
  if (statusFilter) filtersText += `الحالة: ${statusFilter}`;
  
  if (filtersText === 'الفلاتر المطبقة: ') {
    filtersText += 'لا يوجد';
  }
  
  doc.text(filtersText, 14, 35);
  
  // Create table
  const headers = [
    'كود الطالب',
    'الاسم',
    'الصف',
    ...weekDays
  ];
  
  const data = [];
  
  for (let id in students) {
    const student = students[id];
    
    // تطبيق الفلاتر
    if (gradeFilter && student.main !== gradeFilter) continue;
    
    // تحقق من حالة الحضور إذا كان هناك فلتر يوم
    if (dayFilter) {
      if (statusFilter && student.attendance?.[dayFilter] !== statusFilter) continue;
    } else if (statusFilter) {
      // إذا كان هناك فلتر حالة بدون فلتر يوم، تحقق من حالة الحضور في أي يوم
      let hasStatus = false;
      for (let day in student.attendance) {
        if (student.attendance[day] === statusFilter) {
          hasStatus = true;
          break;
        }
      }
      
      if (!hasStatus) continue;
    }
    
    data.push([
      id,
      student.name,
      student.main,
      ...weekDays.map(day => student.attendance?.[day] || '-')
    ]);
  }
  
  // Add table to PDF
  doc.autoTable({
    head: [headers],
    body: data,
    startY: 45,
    styles: {
      font: 'Tajawal',
      fontStyle: 'normal',
      textColor: [0, 0, 0],
      halign: 'right'
    },
    headStyles: {
      fillColor: [25, 118, 210],
      textColor: [255, 255, 255],
      fontStyle: 'bold'
    },
    alternateRowStyles: {
      fillColor: [248, 250, 252]
    },
    columnStyles: {
      0: { cellWidth: 30 },
      1: { cellWidth: 40 },
      2: { cellWidth: 40 },
      ...Object.fromEntries(weekDays.map((_, i) => [i + 3, { cellWidth: 20 }]))
    }
  });
  
  // Add summary
  let y = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(14);
  doc.setTextColor(33, 150, 243);
  doc.text('ملخص الحضور:', 14, y);
  y += 10;
  
  doc.setFontSize(12);
  doc.setTextColor(0, 0, 0);
  
  weekDays.forEach(day => {
    let presentCount = 0;
    let absentCount = 0;
    for (let id in students) {
      if (students[id].attendance?.[day] === 'حاضر') presentCount++;
      else if (students[id].attendance?.[day] === 'غائب') absentCount++;
    }
    
    doc.text(`${day}: ${presentCount} حاضر / ${absentCount} غائب / ${Object.keys(students).length - presentCount - absentCount} غير محدد`, 14, y);
    y += 8;
  });
  
  // Save the PDF
  doc.save('تقرير_الحضور.pdf');
}

// Export data functions
function exportData(format) {
  if (Object.keys(students).length === 0) {
    showError('لا يوجد بيانات لتصديرها');
    return;
  }

  switch(format) {
    case 'pdf':
      exportToPDF();
      break;
    case 'excel':
      exportToExcel();
      break;
    case 'word':
      exportToWord();
      break;
    case 'json':
      exportToJSON();
      break;
    default:
      showError('صيغة التصدير غير معروفة');
  }
}

function exportToPDF() {
  const doc = new jsPDF();
  
  // Add title
  doc.setFont('Tajawal', 'normal');
  doc.setTextColor(33, 150, 243);
  doc.setFontSize(22);
  doc.text('تقرير بيانات الطلاب', 105, 15, null, null, 'center');
  
  // Add date
  doc.setFontSize(12);
  doc.setTextColor(100, 100, 100);
  doc.text(`تاريخ التصدير: ${new Date().toLocaleDateString('ar-EG')}`, 105, 25, null, null, 'center');
  
  let y = 35;
  
  // Add each student's data
  Object.keys(students).forEach((id, index) => {
    const student = students[id];
    
    // Start new page if needed
    if (y > 250) {
      doc.addPage();
      y = 20;
    }
    
    // Student header
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text(`الطالب ${index + 1}: ${student.name} (${id})`, 14, y);
    y += 10;
    
    // Basic info
    doc.setFontSize(12);
    doc.text(`الصف: ${student.main}`, 14, y);
    doc.text(`المستوى: ${student.info || '-'}`, 100, y);
    y += 8;
    
    if (student.phone) {
      doc.text(`رقم ولي الأمر: ${student.phone}`, 14, y);
      y += 8;
    }
    
    // Notes
    if (student.notes) {
      doc.text('الملاحظات:', 14, y);
      y += 8;
      doc.text(student.notes, 14, y, { maxWidth: 180 });
      y += 10;
    }
    
    // Attendance
    doc.text('الحضور:', 14, y);
    y += 8;
    
    let attendanceText = weekDays.map(day => {
      return `${day}: ${student.attendance?.[day] || '-'}`;
    }).join('، ');
    
    doc.text(attendanceText, 14, y, { maxWidth: 180 });
    y += 10;
    
    // Fees
    doc.text('المصروفات:', 14, y);
    y += 8;
    
    let feesText = months.map(month => {
      return `${month}: ${student.fees?.[month] ? 'مسددة' : 'غير مسددة'}`;
    }).join('، ');
    
    doc.text(feesText, 14, y, { maxWidth: 180 });
    y += 15;
    
    // Add separator
    doc.setDrawColor(200, 200, 200);
    doc.line(14, y, 196, y);
    y += 5;
  });
  
  // Save the PDF
  doc.save('بيانات_الطلاب.pdf');
}

function exportToExcel() {
  // Prepare data
  const data = [];
  
  // Add headers
  data.push([
    'كود الطالب', 'الاسم', 'الصف', 'المستوى', 'رقم ولي الأمر', 'الملاحظات',
    ...weekDays.map(d => `حضور ${d}`),
    ...months.map(m => `مصروفات ${m}`)
  ]);
  
  // Add students data
  Object.keys(students).forEach(id => {
    const student = students[id];
    const row = [
      id,
      student.name,
      student.main,
      student.info || '-',
      student.phone || '-',
      student.notes || '-',
      ...weekDays.map(day => student.attendance?.[day] || '-'),
      ...months.map(month => student.fees?.[month] ? 'مسددة' : 'غير مسددة')
    ];
    data.push(row);
  });
  
  // Create worksheet
  const ws = XLSX.utils.aoa_to_sheet(data);
  
  // Create workbook
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "بيانات الطلاب");
  
  // Export to Excel
  XLSX.writeFile(wb, "بيانات_الطلاب.xlsx");
}

function exportToWord() {
  // Create HTML content
  let html = `
    <!DOCTYPE html>
    <html dir="rtl">
    <head>
      <meta charset="UTF-8">
      <title>بيانات الطلاب</title>
      <style>
        body { font-family: 'Tajawal', sans-serif; }
        h1 { color: #1976d2; text-align: center; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
        th { background-color: #1976d2; color: white; }
        .notes { background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0; }
      </style>
    </head>
    <body>
      <h1>تقرير بيانات الطلاب</h1>
      <p style="text-align: center;">تاريخ التصدير: ${new Date().toLocaleDateString('ar-EG')}</p>
  `;
  
  // Add students data
  let count = 1;
  Object.keys(students).forEach(id => {
    const student = students[id];
    html += `
      <div style="page-break-inside: avoid;">
        <h3>الطالب ${count++}: ${student.name} (${id})</h3>
        <table>
          <tr>
            <th>الصف</th>
            <th>المستوى</th>
            ${student.phone ? '<th>رقم ولي الأمر</th>' : ''}
          </tr>
          <tr>
            <td>${student.main}</td>
            <td>${student.info || '-'}</td>
            ${student.phone ? `<td>${student.phone}</td>` : ''}
          </tr>
        </table>
        ${student.notes ? `<div class="notes"><strong>الملاحظات:</strong> ${student.notes}</div>` : ''}
        <hr>
      </div>
    `;
  });
  
  html += `
    </body>
    </html>
  `;
  
  // Create Blob and download
  const blob = new Blob([html], { type: 'application/msword' });
  saveAs(blob, 'بيانات_الطلاب.doc');
}

function exportToJSON() {
  const dataStr = JSON.stringify(students, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  saveAs(blob, 'بيانات_الطلاب.json');
}

// Initialize when page loads
window.onload = function() {
  // Check if already logged in
  if (localStorage.getItem('isLoggedIn') === 'true') {
    document.getElementById('loginScreen').style.display = 'none';
    loadStudents();
    loadPosts();
    loadTrash();
    fillGradeSelects();
    
    // عرض تاريخ اليوم
    const today = new Date();
    document.getElementById('currentDate').textContent = today.toLocaleDateString('ar-EG');
  }
  
  // Focus on password field if not logged in
  if (document.getElementById('loginScreen').style.display !== 'none') {
    document.getElementById('loginPassword').focus();
  }
};
</script>
</body>
</html>
