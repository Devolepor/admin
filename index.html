<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة تحكم الطلاب - النظام المتطور</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #1976d2;
      --primary-dark: #125ea5;
      --danger-color: #e53935;
      --warning-color: #ff9800;
      --success-color: #43a047;
      --text-color: #2d3748;
      --text-light: #4a5568;
      --light-bg: #f8fafc;
      --white: #ffffff;
      --gray-light: #e2e8f0;
      --gray-dark: #cbd5e0;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --transition: all 0.3s ease;
    }

    /* Dark Mode Variables */
    .dark-mode {
      --primary-color: #4299e1;
      --primary-dark: #3182ce;
      --danger-color: #fc8181;
      --warning-color: #f6ad55;
      --success-color: #68d391;
      --text-color: #e2e8f0;
      --text-light: #a0aec0;
      --light-bg: #1a202c;
      --white: #2d3748;
      --gray-light: #4a5568;
      --gray-dark: #2d3748;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--light-bg);
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      transition: var(--transition);
    }
    
    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 15px 0;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .header h1 {
      color: var(--primary-color);
      font-size: 28px;
      font-weight: 700;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .grade-select {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    input, button, select {
      padding: 12px 15px;
      border-radius: var(--radius);
      border: 1px solid var(--gray-light);
      font-family: 'Tajawal', sans-serif;
      font-size: 16px;
      transition: var(--transition);
      width: 100%;
      background-color: var(--white);
      color: var(--text-color);
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }
    
    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    th, td {
      border: 1px solid var(--gray-light);
      padding: 12px 15px;
      text-align: center;
      font-size: 15px;
    }
    
    th {
      background-color: var(--primary-color);
      color: var(--white);
      font-weight: 500;
    }
    
    tr:nth-child(even) {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    tr:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    .btn {
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      transition: var(--transition);
    }
    
    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-danger {
      background-color: var(--danger-color);
    }
    
    .btn-danger:hover {
      background-color: #c62828;
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-success:hover {
      background-color: #2e7d32;
    }
    
    .btn-warning {
      background-color: var(--warning-color);
    }
    
    .btn-warning:hover {
      background-color: #e65100;
    }
    
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--white) 0%, var(--light-bg) 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .login-box {
      background: var(--white);
      padding: 40px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    
    .login-box h2 {
      margin-bottom: 25px;
      color: var(--primary-color);
      font-size: 24px;
    }
    
    .login-box input {
      margin-bottom: 20px;
    }
    
    #studentsCount {
      text-align: center;
      font-weight: bold;
      margin: 20px 0;
      color: var(--text-color);
      font-size: 18px;
      background: var(--white);
      padding: 15px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(3px);
    }
    
    .modal-content {
      background-color: var(--white);
      margin: 5% auto;
      padding: 25px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 600px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      position: relative;
    }
    
    .close {
      color: var(--text-light);
      position: absolute;
      right: 20px;
      top: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .close:hover {
      color: var(--text-color);
    }
    
    .modal-body {
      padding: 20px 0;
    }
    
    .modal-footer {
      text-align: left;
      padding-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .modal-title {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 22px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-color);
    }
    
    .attendance-select, .fee-checkbox {
      margin: 5px 0;
    }
    
    /* Dark mode toggle */
    .theme-toggle {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-color);
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .theme-toggle:hover {
      background-color: rgba(0,0,0,0.1);
    }
    
    /* Export dropdown */
    .export-dropdown {
      position: relative;
      display: inline-block;
    }
    
    .export-btn {
      background-color: var(--warning-color);
    }
    
    .export-btn:hover {
      background-color: #e65100;
    }
    
    .export-content {
      display: none;
      position: absolute;
      background-color: var(--white);
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: var(--radius);
      overflow: hidden;
      right: 0;
      margin-top: 5px;
    }
    
    .export-content a {
      color: var(--text-color);
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      text-align: right;
      transition: var(--transition);
    }
    
    .export-content a:hover {
      background-color: var(--gray-light);
    }
    
    .export-dropdown:hover .export-content {
      display: block;
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .header-actions {
        width: 100%;
      }
      
      .grade-select {
        width: 100%;
      }
      
      .grade-select button {
        width: 100%;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
      }
      
      table {
        display: block;
        overflow-x: auto;
      }
      
      .control-panel {
        grid-template-columns: 1fr;
      }
      
      .export-content {
        right: auto;
        left: 0;
      }
    }
    
    @media (max-width: 480px) {
      .login-box {
        padding: 30px 20px;
      }
      
      .modal-footer {
        flex-direction: column;
      }
      
      .modal-footer button {
        width: 100%;
      }
    }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--gray-light);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
  </style>
</head>
<body>
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h2><i class="fas fa-lock"></i> تسجيل الدخول</h2>
      <input type="password" id="loginPassword" placeholder="ادخل كلمة المرور">
      <button class="btn btn-success" onclick="checkLogin()"><i class="fas fa-sign-in-alt"></i> دخول</button>
    </div>
  </div>

  <div class="container">
    <!-- Modal for Add/Edit Student -->
    <div id="studentModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 class="modal-title" id="modalTitle"><i class="fas fa-user-plus"></i> إضافة طالب</h3>
        <div class="modal-body">
          <div class="form-group">
            <label for="studentId"><i class="fas fa-id-card"></i> كود الطالب</label>
            <input type="text" id="studentId" placeholder="أدخل كود الطالب">
          </div>
          <div class="form-group">
            <label for="studentName"><i class="fas fa-user"></i> اسم الطالب</label>
            <input type="text" id="studentName" placeholder="أدخل اسم الطالب">
          </div>
          <div class="form-group">
            <label for="studentGrade"><i class="fas fa-graduation-cap"></i> الصف</label>
            <select id="studentGrade">
              <option value="" disabled selected>اختر الصف</option>
            </select>
          </div>
          <div class="form-group">
            <label for="studentLevel"><i class="fas fa-star"></i> المستوى</label>
            <select id="studentLevel">
              <option value="" disabled selected>اختر المستوى</option>
              <option value="ضعيف">ضعيف</option>
              <option value="مقبول">مقبول</option>
              <option value="جيد">جيد</option>
              <option value="جيد جدا">جيد جدا</option>
              <option value="ممتاز">ممتاز</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal()"><i class="fas fa-times"></i> إلغاء</button>
          <button class="btn btn-success" id="saveStudentBtn"><i class="fas fa-save"></i> حفظ</button>
        </div>
      </div>
    </div>

    <!-- Modal for Grade Selection -->
    <div id="gradeModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 class="modal-title"><i class="fas fa-filter"></i> اختر الصف لعرض الطلاب</h3>
        <div class="modal-body">
          <select id="gradeSelect">
            <option value="">عرض جميع الطلاب</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal()"><i class="fas fa-times"></i> إلغاء</button>
          <button class="btn" onclick="filterByGrade()"><i class="fas fa-eye"></i> عرض</button>
        </div>
      </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 class="modal-title"><i class="fas fa-trash-alt"></i> تأكيد الحذف</h3>
        <div class="modal-body">
          <p id="deleteMessage">هل أنت متأكد من حذف هذا الطالب؟</p>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal()"><i class="fas fa-times"></i> إلغاء</button>
          <button class="btn btn-danger" onclick="confirmDelete()"><i class="fas fa-trash"></i> نعم، احذف</button>
        </div>
      </div>
    </div>

    <div class="header">
      <h1><i class="fas fa-user-graduate"></i> لوحة تحكم الطلاب</h1>
      <div class="header-actions">
        <div class="grade-select">
          <button onclick="showGradeModal()"><i class="fas fa-filter"></i> اختر الصف</button>
          <button onclick="renderTable()"><i class="fas fa-list"></i> عرض الكل</button>
        </div>
        <button class="theme-toggle" id="themeToggle" title="تبديل الوضع الليلي">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>

    <div class="control-panel">
      <input type="text" id="token" placeholder="🔑 GitHub Token">
      <input type="text" id="searchId" placeholder="🔍 كود الطالب">
      <button class="btn" onclick="searchStudent()"><i class="fas fa-search"></i> بحث</button>
      <button class="btn btn-success" onclick="showAddModal()"><i class="fas fa-user-plus"></i> إضافة طالب</button>
      <button class="btn" onclick="openFile()"><i class="fas fa-folder-open"></i> فتح ملف</button>
      <button class="btn" onclick="saveToGitHub()"><i class="fas fa-save"></i> حفظ</button>
      <div class="export-dropdown">
        <button class="btn export-btn"><i class="fas fa-file-export"></i> تصدير البيانات</button>
        <div class="export-content">
          <a href="#" onclick="exportData('pdf')"><i class="fas fa-file-pdf"></i> تصدير PDF</a>
          <a href="#" onclick="exportData('excel')"><i class="fas fa-file-excel"></i> تصدير Excel</a>
          <a href="#" onclick="exportData('word')"><i class="fas fa-file-word"></i> تصدير Word</a>
          <a href="#" onclick="exportData('json')"><i class="fas fa-file-code"></i> تصدير JSON</a>
        </div>
      </div>
    </div>

    <div id="studentsCount"></div>
    <div id="studentsTable"></div>
  </div>

<script>
// Initialize jsPDF
const { jsPDF } = window.jspdf;

let students = {};
let sha = "";
const owner = "Devolepor";
const repo = "app";
const path = "students.json";
const branch = "main";
const PASSWORD = "0101356859001223277310";
let githubFileUrl = `https://github.com/${owner}/${repo}/blob/${branch}/${path}`;
let currentStudentId = null;
let deleteStudentId = null;
let isLoading = false;
let originalButtonText = "";

const grades = [
  "الصف الأول الابتدائي", "الصف الثاني الابتدائي", "الصف الثالث الابتدائي",
  "الصف الرابع الابتدائي", "الصف الخامس الابتدائي", "الصف السادس الابتدائي",
  "الصف الأول الإعدادي", "الصف الثاني الإعدادي", "الصف الثالث الإعدادي",
  "الصف الأول الثانوي", "الصف الثاني الثانوي", "الصف الثالث الثانوي"
];

const levels = ["ضعيف", "مقبول", "جيد", "جيد جدا", "ممتاز"];

// أيام الأسبوع وأشهر السنة للاستخدام في الجدول
const weekDays = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];
const months = ["أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر", "يناير", "فبراير", "مارس", "أبريل"];

// Check for saved theme preference
if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark-mode");
  document.getElementById("themeToggle").innerHTML = '<i class="fas fa-sun"></i>';
}

if (localStorage.getItem("gh_token")) {
  document.getElementById("token").value = localStorage.getItem("gh_token");
}

// Theme toggle functionality
document.getElementById("themeToggle").addEventListener("click", function() {
  document.body.classList.toggle("dark-mode");
  if (document.body.classList.contains("dark-mode")) {
    localStorage.setItem("theme", "dark");
    this.innerHTML = '<i class="fas fa-sun"></i>';
  } else {
    localStorage.setItem("theme", "light");
    this.innerHTML = '<i class="fas fa-moon"></i>';
  }
});

function checkLogin() {
  const pass = document.getElementById("loginPassword").value;
  if (pass === PASSWORD) {
    localStorage.setItem("isLoggedIn", "true");
    document.getElementById("loginScreen").style.display = "none";
    loadStudents();
  } else {
    Swal.fire({
      title: 'خطأ!',
      text: 'كلمة مرور خاطئة!',
      icon: 'error',
      confirmButtonText: 'حسناً'
    });
  }
}

async function loadStudents() {
  try {
    showLoading(true);
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`);
    if (!res.ok) throw new Error('فشل في تحميل البيانات');
    
    let data = await res.json();
    sha = data.sha;
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    students = JSON.parse(decodedContent);
    renderTable();
  } catch (error) {
    console.error("Error loading students:", error);
    students = {};
    renderTable();
    Swal.fire({
      title: 'تحذير',
      text: 'لا يوجد بيانات حالية، سيتم إنشاء ملف جديد عند الحفظ',
      icon: 'warning'
    });
  } finally {
    showLoading(false);
  }
}

function renderTable(filterGrade = null) {
  let html = `
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>الكود</th>
            <th>الاسم</th>
            <th>الصف</th>
            <th>المستوى</th>
            <th>الحضور</th>
            <th>المصروفات</th>
            <th>تعديل</th>
            <th>حذف</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  let count = 1;
  let studentCount = 0;
  
  for (let id in students) {
    let s = students[id];
    if (filterGrade && s.main.trim() !== filterGrade.trim()) continue;

    studentCount++;
    
    // تحضير بيانات الحضور
    let attendanceHtml = weekDays.map(day => {
      const status = s.attendance?.[day] || '-';
      return `
        <div class="attendance-select">
          ${day}: 
          <select onchange="updateAttendance('${id}','${day}',this.value)" style="padding: 5px; border-radius: 5px; background: var(--white); color: var(--text-color);">
            <option value="حاضر" ${status === "حاضر" ? 'selected' : ''}>حاضر</option>
            <option value="غائب" ${status === "غائب" ? 'selected' : ''}>غائب</option>
            <option value="-" ${status === "-" ? 'selected' : ''}>-</option>
          </select>
        </div>
      `;
    }).join('');
    
    // تحضير بيانات المصروفات
    let feesHtml = months.map(month => {
      const paid = s.fees?.[month] || false;
      return `
        <div class="fee-checkbox">
          ${month}: 
          <input type="checkbox" onchange="updateFee('${id}','${month}',this.checked)" ${paid ? 'checked' : ''} 
                 style="transform: scale(1.3); margin-right: 5px;">
        </div>
      `;
    }).join('');
    
    html += `
      <tr>
        <td>${count++}</td>
        <td>${id}</td>
        <td>${s.name}</td>
        <td>${s.main}</td>
        <td>${s.info || '-'}</td>
        <td>${attendanceHtml}</td>
        <td>${feesHtml}</td>
        <td><button class="btn" onclick="showEditModal('${id}')"><i class="fas fa-edit"></i> تعديل</button></td>
        <td><button class="btn btn-danger" onclick="showDeleteModal('${id}')"><i class="fas fa-trash"></i> حذف</button></td>
      </tr>
    `;
  }
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  document.getElementById('studentsTable').innerHTML = studentCount > 0 ? html : `
    <div style="text-align: center; padding: 40px; background: var(--white); border-radius: 12px; box-shadow: var(--shadow);">
      <h3 style="color: var(--text-light);"><i class="fas fa-info-circle"></i> لا يوجد طلاب مسجلين حالياً</h3>
      <button class="btn btn-success" onclick="showAddModal()" style="margin-top: 20px;"><i class="fas fa-user-plus"></i> إضافة طالب جديد</button>
    </div>
  `;
  
  document.getElementById('studentsCount').innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <span><i class="fas fa-users"></i> عدد الطلاب المعروضين: ${studentCount}</span>
      <span><i class="fas fa-calendar-alt"></i> ${new Date().toLocaleDateString('ar-EG')}</span>
    </div>
  `;
}

function updateAttendance(id, day, value) {
  if (!students[id].attendance) {
    students[id].attendance = {};
  }
  students[id].attendance[day] = value;
}

function updateFee(id, month, value) {
  if (!students[id].fees) {
    students[id].fees = {};
  }
  students[id].fees[month] = value;
}

function searchStudent() {
  const id = document.getElementById('searchId').value.trim();
  if (!id) {
    Swal.fire({
      title: 'تنبيه',
      text: 'الرجاء إدخال كود الطالب للبحث',
      icon: 'warning'
    });
    return;
  }

  if (students[id]) {
    const student = students[id];
    let attendanceList = weekDays.map(day => 
      `<li>${day}: ${student.attendance?.[day] || '-'}</li>`
    ).join('');
    
    let feesList = months.map(month => 
      `<li>${month}: ${student.fees?.[month] ? '✅ مسددة' : '❌ غير مسددة'}</li>`
    ).join('');
    
    Swal.fire({
      title: '📄 بيانات الطالب',
      html: `
        <div style="text-align: right;">
          <p><b><i class="fas fa-id-card"></i> الكود:</b> ${id}</p>
          <p><b><i class="fas fa-user"></i> الاسم:</b> ${student.name}</p>
          <p><b><i class="fas fa-graduation-cap"></i> الصف:</b> ${student.main}</p>
          <p><b><i class="fas fa-star"></i> المستوى:</b> ${student.info || '-'}</p>
          <hr>
          <h4><i class="fas fa-calendar-check"></i> الحضور:</h4>
          <ul>${attendanceList}</ul>
          <h4><i class="fas fa-money-bill-wave"></i> المصروفات:</h4>
          <ul>${feesList}</ul>
        </div>
      `,
      confirmButtonText: 'حسناً',
      width: '600px'
    });
  } else {
    Swal.fire({
      title: '⚠️ تنبيه',
      text: 'لم يتم العثور على الطالب',
      confirmButtonText: 'حسناً'
    });
  }
}

function openFile() {
  window.open(githubFileUrl, '_blank');
}

function showGradeModal() {
  const gradeSelect = document.getElementById('gradeSelect');
  gradeSelect.innerHTML = '<option value="">عرض جميع الطلاب</option>';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
  document.getElementById('gradeModal').style.display = 'block';
}

function filterByGrade() {
  const gradeSelect = document.getElementById('gradeSelect');
  const selectedGrade = gradeSelect.value;
  renderTable(selectedGrade);
  closeModal();
}

function showAddModal() {
  currentStudentId = null;
  document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus"></i> إضافة طالب جديد';
  document.getElementById('studentId').value = '';
  document.getElementById('studentName').value = '';
  document.getElementById('studentLevel').value = '';
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '<option value="" disabled selected>اختر الصف</option>';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
  
  // Focus on first input
  setTimeout(() => {
    document.getElementById('studentId').focus();
  }, 100);
}

function showEditModal(id) {
  currentStudentId = id;
  const student = students[id];
  
  document.getElementById('modalTitle').innerHTML = `<i class="fas fa-user-edit"></i> تعديل بيانات الطالب ${id}`;
  document.getElementById('studentId').value = id;
  document.getElementById('studentName').value = student.name;
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}" ${grade === student.main ? 'selected' : ''}>${grade}</option>`;
  });
  
  const levelSelect = document.getElementById('studentLevel');
  levelSelect.innerHTML = '<option value="" disabled>اختر المستوى</option>';
  levels.forEach(level => {
    levelSelect.innerHTML += `<option value="${level}" ${level === student.info ? 'selected' : ''}>${level}</option>`;
  });
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
}

function showDeleteModal(id) {
  deleteStudentId = id;
  const student = students[id];
  document.getElementById('deleteMessage').innerHTML = `
    <p>هل أنت متأكد من حذف الطالب التالي؟</p>
    <div style="background: var(--gray-light); padding: 10px; border-radius: 8px; margin-top: 10px;">
      <p><strong><i class="fas fa-id-card"></i> الكود:</strong> ${id}</p>
      <p><strong><i class="fas fa-user"></i> الاسم:</strong> ${student.name}</p>
      <p><strong><i class="fas fa-graduation-cap"></i> الصف:</strong> ${student.main}</p>
    </div>
    <p style="color: var(--danger-color); margin-top: 10px;"><i class="fas fa-exclamation-triangle"></i> هذا الإجراء لا يمكن التراجع عنه!</p>
  `;
  document.getElementById('deleteModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('studentModal').style.display = 'none';
  document.getElementById('gradeModal').style.display = 'none';
  document.getElementById('deleteModal').style.display = 'none';
}

function saveStudent() {
  const id = document.getElementById('studentId').value.trim();
  const name = document.getElementById('studentName').value.trim();
  const grade = document.getElementById('studentGrade').value;
  const level = document.getElementById('studentLevel').value;
  
  if (!id) {
    showError('يجب إدخال كود الطالب');
    document.getElementById('studentId').focus();
    return;
  }
  
  if (!name) {
    showError('يجب إدخال اسم الطالب');
    document.getElementById('studentName').focus();
    return;
  }
  
  if (!grade) {
    showError('يجب اختيار الصف');
    document.getElementById('studentGrade').focus();
    return;
  }
  
  if (currentStudentId === null && students[id]) {
    showError('كود الطالب موجود مسبقاً');
    document.getElementById('studentId').focus();
    return;
  }
  
  if (currentStudentId === null) {
    // Add new student
    students[id] = {
      name,
      main: grade,
      info: level,
      attendance: Object.fromEntries(weekDays.map(day => [day, "-"])),
      fees: Object.fromEntries(months.map(month => [month, false]))
    };
  } else {
    // Update existing student
    if (currentStudentId !== id) {
      // If ID changed, we need to create new entry and delete old one
      students[id] = {
        name,
        main: grade,
        info: level,
        attendance: {...students[currentStudentId].attendance},
        fees: {...students[currentStudentId].fees}
      };
      delete students[currentStudentId];
    } else {
      // Just update the existing student
      students[id].name = name;
      students[id].main = grade;
      students[id].info = level;
    }
  }
  
  renderTable();
  closeModal();
  showSuccess('تم حفظ بيانات الطالب بنجاح');
}

function confirmDelete() {
  if (deleteStudentId) {
    delete students[deleteStudentId];
    renderTable();
    closeModal();
    showSuccess('تم حذف الطالب بنجاح');
    deleteStudentId = null;
  }
}

async function saveToGitHub() {
  const token = document.getElementById('token').value.trim();
  if (!token) {
    showError('الرجاء إدخال توكن GitHub أولاً');
    document.getElementById('token').focus();
    return;
  }
  localStorage.setItem("gh_token", token);

  const content = JSON.stringify(students, null, 2);
  const utf8Content = unescape(encodeURIComponent(content));
  const encoded = btoa(utf8Content);

  try {
    showLoading(true);
    const saveBtn = document.querySelector('button[onclick="saveToGitHub()"]');
    originalButtonText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="spinner"></span> جاري الحفظ...';
    saveBtn.disabled = true;
    
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: "تحديث بيانات الطلاب من لوحة التحكم",
        content: encoded,
        sha: sha,
        branch: branch
      })
    });

    if (res.ok) {
      const data = await res.json();
      sha = data.content.sha;
      showSuccess('تم حفظ البيانات بنجاح على GitHub');
      loadStudents();
    } else {
      const error = await res.json();
      showError(`فشل في الحفظ! ${error.message}`);
    }
  } catch (error) {
    showError(`خطأ في الاتصال: ${error.message}`);
  } finally {
    showLoading(false);
    const saveBtn = document.querySelector('button[onclick="saveToGitHub()"]');
    if (saveBtn) {
      saveBtn.innerHTML = originalButtonText;
      saveBtn.disabled = false;
    }
  }
}

function showLoading(show) {
  isLoading = show;
  const loader = document.createElement('div');
  loader.id = 'loadingOverlay';
  loader.style.position = 'fixed';
  loader.style.top = '0';
  loader.style.left = '0';
  loader.style.width = '100%';
  loader.style.height = '100%';
  loader.style.backgroundColor = 'rgba(0,0,0,0.5)';
  loader.style.display = 'flex';
  loader.style.justifyContent = 'center';
  loader.style.alignItems = 'center';
  loader.style.zIndex = '9998';
  loader.innerHTML = `
    <div style="background: var(--white); padding: 30px; border-radius: 12px; text-align: center; box-shadow: var(--shadow);">
      <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 15px; border-top-color: var(--primary-color);"></div>
      <p style="font-weight: bold; color: var(--text-color);">جاري التحميل...</p>
    </div>
  `;
  
  if (show) {
    document.body.appendChild(loader);
  } else {
    const existingLoader = document.getElementById('loadingOverlay');
    if (existingLoader) {
      existingLoader.remove();
    }
  }
}

function showError(message) {
  Swal.fire({
    title: '❌ خطأ',
    text: message,
    icon: 'error',
    confirmButtonText: 'حسناً'
  });
}

function showSuccess(message) {
  Swal.fire({
    title: '✅ تم بنجاح',
    text: message,
    icon: 'success',
    confirmButtonText: 'حسناً'
  });
}

// Export data functions
function exportData(format) {
  if (Object.keys(students).length === 0) {
    showError('لا يوجد بيانات لتصديرها');
    return;
  }

  switch(format) {
    case 'pdf':
      exportToPDF();
      break;
    case 'excel':
      exportToExcel();
      break;
    case 'word':
      exportToWord();
      break;
    case 'json':
      exportToJSON();
      break;
    default:
      showError('صيغة التصدير غير معروفة');
  }
}

function exportToPDF() {
  const doc = new jsPDF();
  
  // Add title
  doc.setFont('Tajawal', 'normal');
  doc.setTextColor(33, 150, 243);
  doc.setFontSize(22);
  doc.text('تقرير بيانات الطلاب', 105, 15, null, null, 'center');
  
  // Add date
  doc.setFontSize(12);
  doc.setTextColor(100, 100, 100);
  doc.text(`تاريخ التصدير: ${new Date().toLocaleDateString('ar-EG')}`, 105, 25, null, null, 'center');
  
  let y = 35;
  
  // Add each student's data
  Object.keys(students).forEach((id, index) => {
    const student = students[id];
    
    // Start new page if needed
    if (y > 250) {
      doc.addPage();
      y = 20;
    }
    
    // Student header
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text(`الطالب ${index + 1}: ${student.name} (${id})`, 14, y);
    y += 10;
    
    // Basic info
    doc.setFontSize(12);
    doc.text(`الصف: ${student.main}`, 14, y);
    doc.text(`المستوى: ${student.info || '-'}`, 100, y);
    y += 8;
    
    // Attendance
    doc.text('الحضور:', 14, y);
    y += 8;
    
    let attendanceText = weekDays.map(day => {
      return `${day}: ${student.attendance?.[day] || '-'}`;
    }).join('، ');
    
    doc.text(attendanceText, 14, y, { maxWidth: 180 });
    y += 10;
    
    // Fees
    doc.text('المصروفات:', 14, y);
    y += 8;
    
    let feesText = months.map(month => {
      return `${month}: ${student.fees?.[month] ? 'مسددة' : 'غير مسددة'}`;
    }).join('، ');
    
    doc.text(feesText, 14, y, { maxWidth: 180 });
    y += 15;
    
    // Add separator
    doc.setDrawColor(200, 200, 200);
    doc.line(14, y, 196, y);
    y += 5;
  });
  
  // Save the PDF
  doc.save('بيانات_الطلاب.pdf');
}

function exportToExcel() {
  // Prepare data
  const data = [];
  
  // Add headers
  data.push([
    'كود الطالب', 'الاسم', 'الصف', 'المستوى', 
    ...weekDays.map(d => `حضور ${d}`),
    ...months.map(m => `مصروفات ${m}`)
  ]);
  
  // Add students data
  Object.keys(students).forEach(id => {
    const student = students[id];
    const row = [
      id,
      student.name,
      student.main,
      student.info || '-',
      ...weekDays.map(day => student.attendance?.[day] || '-'),
      ...months.map(month => student.fees?.[month] ? 'مسددة' : 'غير مسددة')
    ];
    data.push(row);
  });
  
  // Create worksheet
  const ws = XLSX.utils.aoa_to_sheet(data);
  
  // Create workbook
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "بيانات الطلاب");
  
  // Export to Excel
  XLSX.writeFile(wb, "بيانات_الطلاب.xlsx");
}

function exportToWord() {
  // Create HTML content
  let html = `
    <!DOCTYPE html>
    <html dir="rtl">
    <head>
      <meta charset="UTF-8">
      <title>بيانات الطلاب</title>
      <style>
        body { font-family: 'Tajawal', sans-serif; }
        h1 { color: #1976d2; text-align: center; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #1976d2; color: white; }
      </style>
    </head>
    <body>
      <h1>تقرير بيانات الطلاب</h1>
      <p style="text-align: center;">تاريخ التصدير: ${new Date().toLocaleDateString('ar-EG')}</p>
      <table>
        <tr>
          <th>#</th>
          <th>الكود</th>
          <th>الاسم</th>
          <th>الصف</th>
          <th>المستوى</th>
        </tr>
  `;
  
  // Add students data
  let count = 1;
  Object.keys(students).forEach(id => {
    const student = students[id];
    html += `
      <tr>
        <td>${count++}</td>
        <td>${id}</td>
        <td>${student.name}</td>
        <td>${student.main}</td>
        <td>${student.info || '-'}</td>
      </tr>
    `;
  });
  
  html += `
      </table>
    </body>
    </html>
  `;
  
  // Create Blob and download
  const blob = new Blob([html], { type: 'application/msword' });
  saveAs(blob, 'بيانات_الطلاب.doc');
}

function exportToJSON() {
  const dataStr = JSON.stringify(students, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  saveAs(blob, 'بيانات_الطلاب.json');
}

// Initialize when page loads
window.onload = function() {
  // Check if already logged in
  if (localStorage.getItem('isLoggedIn') === 'true') {
    document.getElementById('loginScreen').style.display = 'none';
    loadStudents();
  }
  
  // Focus on password field if not logged in
  if (document.getElementById('loginScreen').style.display !== 'none') {
    document.getElementById('loginPassword').focus();
  }
};
</script>
</body>
</html>
