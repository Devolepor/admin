<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>لوحة تحكم الطلاب والمنشورات</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #0288d1;
      --primary-dark: #01579b;
      --danger-color: #d32f2f;
      --warning-color: #f57c00;
      --success-color: #388e3c;
      --text-color: #263238;
      --text-light: #546e7a;
      --light-bg: #eceff1;
      --white: #ffffff;
      --gray-light: #cfd8dc;
      --gray-dark: #b0bec5;
      --shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      --radius: 12px;
      --transition: all 0.3s ease-in-out;
    }

    .dark-mode {
      --primary-color: #4fc3f7;
      --primary-dark: #0288d1;
      --danger-color: #ef5350;
      --warning-color: #ff9800;
      --success-color: #66bb6a;
      --text-color: #eceff1;
      --text-light: #b0bec5;
      --light-bg: #263238;
      --white: #37474f;
      --gray-light: #546e7a;
      --gray-dark: #455a64;
      --shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, var(--light-bg), #ffffff);
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      transition: var(--transition);
      overflow-x: hidden;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 15px;
    }

    .sidebar {
      position: fixed;
      right: -100%;
      top: 0;
      width: 80%;
      max-width: 320px;
      height: 100%;
      background: var(--white);
      box-shadow: var(--shadow);
      transition: right 0.3s ease-in-out;
      z-index: 1000;
      overflow-y: auto;
      padding: 15px;
      border-radius: 0 0 0 12px;
    }

    .sidebar.open {
      right: 0;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gray-light);
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-color);
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: var(--radius);
      color: var(--text-color);
      text-decoration: none;
      transition: var(--transition);
      font-weight: 500;
      background: var(--light-bg);
      margin-bottom: 8px;
      font-size: 14px;
    }

    .sidebar-menu a:hover {
      background: var(--primary-color);
      color: var(--white);
      transform: translateX(-5px);
      box-shadow: var(--shadow);
    }

    .sidebar-toggle {
      position: fixed;
      right: 15px;
      top: 15px;
      background: var(--primary-color);
      color: var(--white);
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1001;
      box-shadow: var(--shadow);
      font-size: 20px;
    }

    .header {
      background: var(--white);
      padding: 15px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .header h1 {
      color: var(--primary-color);
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      background: var(--primary-color);
      color: var(--white);
      border: none;
      font-weight: 600;
      cursor: pointer;
      padding: 10px 20px;
      border-radius: 8px;
      transition: var(--transition);
      box-shadow: var(--shadow);
      font-size: 14px;
      touch-action: manipulation;
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: var(--white);
      padding: 20px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
      box-shadow: var(--shadow);
      animation: slideIn 0.3s ease;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .modal-title {
      color: var(--primary-color);
      font-size: 20px;
      font-weight: 700;
    }

    .close {
      color: var(--text-light);
      font-size: 24px;
      cursor: pointer;
      transition: var(--transition);
    }

    .close:hover {
      color: var(--danger-color);
      transform: scale(1.2);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--primary-color);
      font-size: 14px;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--gray-light);
      border-radius: 8px;
      font-size: 14px;
      transition: var(--transition);
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(2, 136, 209, 0.2);
      outline: none;
    }

    .image-upload-container {
      background: var(--light-bg);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .image-preview {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px dashed var(--gray-light);
      cursor: pointer;
      transition: var(--transition);
      margin: 0 auto;
    }

    .student-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 15px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      margin-bottom: 15px;
      position: relative;
    }

    .student-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .qr-code-container {
      text-align: center;
      margin: 15px 0;
      padding: 10px;
      background: var(--light-bg);
      border-radius: 10px;
    }

    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(145deg, var(--white), var(--light-bg));
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary-color);
      margin: 10px 0;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .report-table th, .report-table td {
      padding: 10px;
      text-align: center;
      border: 1px solid var(--gray-light);
      font-size: 12px;
    }

    .report-table th {
      background: var(--primary-color);
      color: var(--white);
      font-weight: 600;
    }

    .report-table tbody tr:hover {
      background: var(--light-bg);
      cursor: pointer;
    }

    .report-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .report-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
    }

    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: var(--light-bg);
    }

    .login-box {
      background: var(--white);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
      width: 90%;
      max-width: 350px;
    }

    .login-box h2 {
      color: var(--primary-color);
      margin-bottom: 15px;
      font-size: 20px;
    }

    .login-box input {
      margin-bottom: 10px;
      font-size: 14px;
    }

    .btn-success {
      background: var(--success-color);
    }

    .btn-success:hover {
      background: #2e7d32;
    }

    .btn-danger {
      background: var(--danger-color);
    }

    .btn-danger:hover {
      background: #b71c1c;
    }

    .btn-secondary {
      background: var(--gray-dark);
    }

    .btn-secondary:hover {
      background: #90a4ae;
    }

    .file-info {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
      background: var(--white);
      padding: 10px;
      border-radius: var(--radius);
      box: var(--shadow);
    }

    .control-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
    gap: 10px;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .tab {
      padding: 10px 15px;
      background: var(--gray-light);
      color: var(--text-color);
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 14px;
    }

    .tab.active {
      background: var(--primary-color);
      color: var(--white);
    }

    .tab:hover {
      background: var(--primary-dark);
      color: var(--white);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .posts-container {
      background: var(--white);
      padding: 15px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .posts-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
    }

    .post {
      background: var(--white);
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: var(--shadow);
      position: relative;
    }

    .post-header {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .post-avatar {
      width: 36px;
      height: 36px;
      background: var(--primary-color);
      color: var(--white);
      border-radius: 50%;
     みる

System: Here is the complete updated code with the modification to show the student details modal with QR code immediately after adding a student:

<xaiArtifact artifact_id="2e4d7fbc-92f4-45cc-af97-f2d4776384bd" artifact_version_id="ebca1bb9-303c-4bef-ab9a-a94d2432607c" title="index.html" contentType="text/html">
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>لوحة تحكم الطلاب والمنشورات</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #0288d1;
      --primary-dark: #01579b;
      --danger-color: #d32f2f;
      --warning-color: #f57c00;
      --success-color: #388e3c;
      --text-color: #263238;
      --text-light: #546e7a;
      --light-bg: #eceff1;
      --white: #ffffff;
      --gray-light: #cfd8dc;
      --gray-dark: #b0bec5;
      --shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
      --radius: 12px;
      --transition: all 0.3s ease-in-out;
    }

    .dark-mode {
      --primary-color: #4fc3f7;
      --primary-dark: #0288d1;
      --danger-color: #ef5350;
      --warning-color: #ff9800;
      --success-color: #66bb6a;
      --text-color: #eceff1;
      --text-light: #b0bec5;
      --light-bg: #263238;
      --white: #37474f;
      --gray-light: #546e7a;
      --gray-dark: #455a64;
      --shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, var(--light-bg), #ffffff);
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      transition: var(--transition);
      overflow-x: hidden;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 15px;
    }

    .sidebar {
      position: fixed;
      right: -100%;
      top: 0;
      width: 80%;
      max-width: 320px;
      height: 100%;
      background: var(--white);
      box-shadow: var(--shadow);
      transition: right 0.3s ease-in-out;
      z-index: 1000;
      overflow-y: auto;
      padding: 15px;
      border-radius: 0 0 0 12px;
    }

    .sidebar.open {
      right: 0;
    }

    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gray-light);
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary-color);
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: var(--radius);
      color: var(--text-color);
      text-decoration: none;
      transition: var(--transition);
      font-weight: 500;
      background: var(--light-bg);
      margin-bottom: 8px;
      font-size: 14px;
    }

    .sidebar-menu a:hover {
      background: var(--primary-color);
      color: var(--white);
      transform: translateX(-5px);
      box-shadow: var(--shadow);
    }

    .sidebar-toggle {
      position: fixed;
      right: 15px;
      top: 15px;
      background: var(--primary-color);
      color: var(--white);
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1001;
      box-shadow: var(--shadow);
      font-size: 20px;
    }

    .header {
      background: var(--white);
      padding: 15px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .header h1 {
      color: var(--primary-color);
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      background: var(--primary-color);
      color: var(--white);
      border: none;
      font-weight: 600;
      cursor: pointer;
      padding: 10px 20px;
      border-radius: 8px;
      transition: var(--transition);
      box-shadow: var(--shadow);
      font-size: 14px;
      touch-action: manipulation;
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: var(--white);
      padding: 20px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 600px;
      margin: 20px auto;
      box-shadow: var(--shadow);
      animation: slideIn 0.3s ease;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .modal-title {
      color: var(--primary-color);
      font-size: 20px;
      font-weight: 700;
    }

    .close {
      color: var(--text-light);
      font-size: 24px;
      cursor: pointer;
      transition: var(--transition);
    }

    .close:hover {
      color: var(--danger-color);
      transform: scale(1.2);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--primary-color);
      font-size: 14px;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--gray-light);
      border-radius: 8px;
      font-size: 14px;
      transition: var(--transition);
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(2, 136, 209, 0.2);
      outline: none;
    }

    .image-upload-container {
      background: var(--light-bg);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .image-preview {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px dashed var(--gray-light);
      cursor: pointer;
      transition: var(--transition);
      margin: 0 auto;
    }

    .student-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 15px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      margin-bottom: 15px;
      position: relative;
    }

    .student-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .qr-code-container {
      text-align: center;
      margin: 15px 0;
      padding: 10px;
      background: var(--light-bg);
      border-radius: 10px;
    }

    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(145deg, var(--white), var(--light-bg));
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary-color);
      margin: 10px 0;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .report-table th, .report-table td {
      padding: 10px;
      text-align: center;
      border: 1px solid var(--gray-light);
      font-size: 12px;
    }

    .report-table th {
      background: var(--primary-color);
      color: var(--white);
      font-weight: 600;
    }

    .report-table tbody tr:hover {
      background: var(--light-bg);
    }

    .report-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .report-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
    }

    .login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: var(--light-bg);
    }

    .login-box {
      background: var(--white);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
      width: 90%;
      max-width: 350px;
    }

    .login-box h2 {
      color: var(--primary-color);
      margin-bottom: 15px;
      font-size: 20px;
    }

    .login-box input {
      margin-bottom: 10px;
      font-size: 14px;
    }

    .btn-success {
      background: var(--success-color);
    }

    .btn-success:hover {
      background: #2e7d32;
    }

    .btn-danger {
      background: var(--danger-color);
    }

    .btn-danger:hover {
      background: #b71c1c;
    }

    .btn-secondary {
      background: var(--gray-dark);
    }

    .btn-secondary:hover {
      background: #90a4ae;
    }

    .file-info {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
      background: var(--white);
      padding: 10px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .control-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .tab {
      padding: 10px 15px;
      background: var(--gray-light);
      color: var(--text-color);
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 14px;
    }

    .tab.active {
      background: var(--primary-color);
      color: var(--white);
    }

    .tab:hover {
      background: var(--primary-dark);
      color: var(--white);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .posts-container {
      background: var(--white);
      padding: 15px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .posts-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
    }

    .post {
      background: var(--white);
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: var(--shadow);
      position: relative;
    }

    .post-header {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .post-avatar {
      width: 36px;
      height: 36px;
      background: var(--primary-color);
      color: var(--white);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .post-author {
      font-weight: 600;
      font-size: 14px;
    }

    .post-date {
      color: var(--text-light);
      font-size: 12px;
    }

    .post-content {
      margin-bottom: 10px;
    }

    .post-image {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 8px;
      cursor: pointer;
    }

    .post-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }

    .post-action {
      cursor: pointer;
      color: var(--text-light);
      transition: var(--transition);
      font-size: 14px;
    }

    .post-action:hover {
      color: var(--primary-color);
    }

    .post-action.liked {
      color: var(--danger-color);
    }

    .post-delete {
      position: absolute;
      top: 10px;
      left: 10px;
      color: var(--danger-color);
      cursor: pointer;
      font-size: 16px;
      transition: var(--transition);
    }

    .post-delete:hover {
      transform: scale(1.2);
    }

    .student-image-thumb {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      margin-left: 8px;
    }

    .edit-student-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      color: var(--primary-color);
      cursor: pointer;
      font-size: 16px;
      transition: var(--transition);
    }

    .edit-student-btn:hover {
      transform: scale(1.2);
    }

    .student-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .student-name {
      font-weight: 600;
      font-size: 16px;
    }

    .student-id {
      color: var(--text-light);
      font-size: 12px;
    }

    .student-grade {
      background: var(--primary-color);
      color: var(--white);
      padding: 5px 8px;
      border-radius: 8px;
      font-size: 12px;
    }

    .student-level {
      color: var(--text-light);
      font-size: 12px;
    }

    .student-detail-card {
      background: var(--white);
      padding: 15px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .student-detail-header {
      margin-bottom: 15px;
    }

    .student-info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 8px;
      background: var(--light-bg);
      border-radius: 8px;
    }

    .student-info-label {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 14px;
    }

    .student-info-value {
      color: var(--text-color);
      font-size: 14px;
    }

    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .fees-grid, .attendance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    .fee-item, .attendance-item {
      background: var(--light-bg);
      padding: 8px;
      border-radius: 8px;
      text-align: center;
    }

    .fee-item span, .attendance-item span {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 12px;
    }

    .no-students {
      text-align: center;
      padding: 15px;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .share-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .theme-toggle i.fa-moon::before {
      content: "\f185";
    }

    .theme-toggle.active i.fa-moon::before {
      content: "\f186";
    }

    .spinner {
      border: 4px solid var(--white);
      border-top: 4px solid var(--primary-dark);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .sidebar {
        width: 100%;
        max-width: none;
      }

      .modal-content {
        width: 95%;
        margin: 10px auto;
        max-height: 90vh;
      }

      .header h1 {
        font-size: 18px;
      }

      .btn {
        padding: 8px 15px;
        font-size: 12px;
      }

      .student-card {
        padding: 10px;
      }

      .stats-cards {
        grid-template-columns: 1fr;
      }

      .report-table th, .report-table td {
        font-size: 10px;
        padding: 8px;
      }

      .post {
        padding: 10px;
      }

      .post-image {
        max-width: 100%;
      }
    }

    @media (max-width: 480px) {
      .header-actions {
        flex-direction: column;
        gap: 8px;
      }

      .control-panel {
        flex-direction: column;
      }

      .btn-group {
        flex-direction: column;
      }

      .tabs {
        flex-direction: column;
      }

      .tab {
        width: 100%;
        text-align: center;
      }

      .student-name {
        font-size: 14px;
      }

      .student-id, .student-level {
        font-size: 11px;
      }

      .student-grade {
        font-size: 11px;
      }

      .image-preview {
        width: 100px;
        height: 100px;
      }
    }
  </style>
</head>
<body>
  <div id="imageModal" class="modal image-modal">
    <span class="close close-image" onclick="closeImageModal()">×</span>
    <div class="modal-content">
      <img class="image-modal-content" id="expandedImage" alt="صورة موسعة">
    </div>
  </div>

  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h2><i class="fas fa-lock"></i> تسجيل الدخول</h2>
      <input type="password" id="loginPassword" placeholder="أدخل كلمة المرور" required>
      <button class="btn btn-success" onclick="checkLogin()">
        <i class="fas fa-sign-in-alt"></i> دخول
      </button>
    </div>
  </div>

  <div class="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2 class="sidebar-title"><i class="fas fa-user-graduate"></i> القائمة الرئيسية</h2>
      <button class="btn btn-danger" onclick="toggleSidebar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#" onclick="showAddModal()"><i class="fas fa-user-plus"></i> إضافة طالب جديد</a></li>
      <li><a href="#" onclick="showDeleteModal(null)"><i class="fas fa-user-minus"></i> حذف طالب</a></li>
      <li><a href="#" onclick="showAllStudents()"><i class="fas fa-users"></i> عرض جميع الطلاب</a></li>
      <li><a href="#" onclick="showReports('fees')"><i class="fas fa-money-bill-wave"></i> تقرير المصروفات</a></li>
      <li><a href="#" onclick="showReports('attendance')"><i class="fas fa-calendar-check"></i> تقرير الحضور</a></li>
      <li><a href="#" onclick="showGradeModal()"><i class="fas fa-filter"></i> تصفية حسب الصف</a></li>
      <li><a href="#" onclick="showTrash()"><i class="fas fa-trash"></i> سلة المهملات</a></li>
      <li><a href="#" onclick="exportData('json')"><i class="fas fa-file-export"></i> تصدير البيانات</a></li>
      <li><a href="#" onclick="saveToGitHub()"><i class="fas fa-save"></i> حفظ البيانات</a></li>
      <li><a href="#" onclick="switchDataFile()"><i class="fas fa-file-alt"></i> تبديل ملف البيانات</a></li>
    </ul>
  </div>

  <div class="container">
    <div class="header">
      <h1><i class="fas fa-user-graduate"></i> لوحة تحكم الطلاب</h1>
      <div class="header-actions">
        <button class="btn" onclick="showGradeModal()">
          <i class="fas fa-filter"></i> تصفية حسب الصف
        </button>
        <button class="btn theme-toggle" id="themeToggle">
          <i class="fas fa-moon"></i> الوضع الليلي
        </button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('students')">
        <i class="fas fa-users"></i> الطلاب
      </div>
      <div class="tab" onclick="switchTab('posts')">
        <i class="fas fa-newspaper"></i> المنشوات
      </div>
      <div class="tab" onclick="switchTab('reports')">
        <i class="fas fa-chart-bar"></i> التقارير
      </div>
    </div>

    <div id="students-tab" class="tab-content active">
      <div class="file-info">
        <div><i class="fas fa-file-alt"></i> ملف البيانات الحالي: <span id="currentDataFile">students.json</span></div>
        <div><i class="fas fa-users"></i> عدد الطلاب: <span id="totalStudentsInFile">0</span></div>
      </div>

      <div class="control-panel">
        <input type="text" id="token" placeholder="🔑 GitHub Token" style="flex: 1;">
        <input type="text" id="searchId" placeholder="🔍 كود الطالب" style="flex: 1;">
        <button class="btn" onclick="searchStudent()">
          <i class="fas fa-search"></i> بحث
        </button>
        <div class="btn-group">
          <button class="btn btn-success" onclick="showAddModal()">
            <i class="fas fa-user-plus"></i> إضافة
          </button>
          <button class="btn btn-secondary" onclick="hideAllStudents()">
            <i class="fas fa-eye-slash"></i> إخفاء الكل
          </button>
          <button class="btn btn-secondary" onclick="showAllStudents()">
            <i class="fas fa-eye"></i> عرض الكل
          </button>
          <button class="btn btn-warning" onclick="saveToGitHub()">
            <i class="fas fa-save"></i> حفظ
          </button>
        </div>
      </div>

      <div id="studentsCount" style="background: var(--white); padding: 10px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 15px;">
        <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px;">
          <span><i class="fas fa-users"></i> عدد الطلاب المعروضين: <span id="studentsCountNumber">0</span></span>
          <span><i class="fas fa-calendar-alt"></i> تاريخ اليوم: <span id="currentDate"></span></span>
        </div>
      </div>

      <div id="studentsCards"></div>
    </div>

    <div id="posts-tab" class="tab-content">
      <div class="posts-container">
        <div class="posts-header">
          <h2><i class="fas fa-newspaper"></i> المنشورات</h2>
          <button class="btn btn-success" onclick="showPostModal()">
            <i class="fas fa-plus"></i> منشور جديد
          </button>
        </div>
        <div id="postsList"></div>
      </div>
    </div>

    <div id="reports-tab" class="tab-content">
      <div class="posts-container">
        <div class="posts-header">
          <h2><i class="fas fa-chart-bar"></i> التقارير</h2>
        </div>

        <div class="report-type-selector">
          <button class="btn report-type-btn" onclick="showReports('fees')">
            <i class="fas fa-money-bill-wave"></i> تقرير المصروفات
          </button>
          <button class="btn report-type-btn" onclick="showReports('attendance')">
            <i class="fas fa-calendar-check"></i> تقرير الحضور
          </button>
          <button class="btn report-type-btn" onclick="showReports('stats')">
            <i class="fas fa-chart-pie"></i> الإحصائيات
          </button>
        </div>

        <div id="statsReport" class="report-section">
          <div class="stats-cards">
            <div class="stat-card total">
              <h3><i class="fas fa-users"></i> إجمالي الطلاب</h3>
              <div class="value" id="totalStudentsCount">0</div>
              <div class="description">عدد الطلاب المسجلين</div>
            </div>
            <div class="stat-card present">
              <h3><i class="fas fa-user-check"></i> الحضور اليوم</h3>
              <div class="value" id="todayPresentCount">0</div>
              <div class="description">عدد الحاضرين اليوم</div>
            </div>
            <div class="stat-card absent">
              <h3><i class="fas fa-user-times"></i> الغياب اليوم</h3>
              <div class="value" id="todayAbsentCount">0</div>
              <div class="description">عدد الغائبين اليوم</div>
            </div>
            <div class="stat-card paid">
              <h3><i class="fas fa-check-circle"></i> مصروفات مسددة</h3>
              <div class="value" id="paidFeesCount">0</div>
              <div class="description">الطلاب الذين سددوا</div>
            </div>
            <div class="stat-card unpaid">
              <h3><i class="fas fa-exclamation-circle"></i> مصروفات غير مسددة</h3>
              <div class="value" id="unpaidFeesCount">0</div>
              <div class="description">الطلاب الذين لم يسددوا</div>
            </div>
          </div>
        </div>

        <div id="feesReport" class="report-section">
          <div class="report-header">
            <h3><i class="fas fa-money-bill-wave"></i> تقرير المصروفات</h3>
            <button class="btn btn-success" onclick="generateFeesReport()">
              <i class="fas fa-download"></i> تصدير التقرير
            </button>
          </div>
          <div class="report-filter">
            <select id="feesGradeFilter" style="flex: 1;">
              <option value="">جميع الصفوف</option>
            </select>
            <select id="feesMonthFilter" style="flex: 1;">
              <option value="">جميع الأشهر</option>
            </select>
            <select id="feesStatusFilter" style="flex: 1;">
              <option value="">جميع الحالات</option>
              <option value="paid">مسددة</option>
              <option value="unpaid">غير مسددة</option>
            </select>
            <button class="btn" onclick="filterFeesReport()">
              <i class="fas fa-filter"></i> تصفية
            </button>
          </div>
          <table class="report-table" id="feesReportTable">
            <thead>
              <tr>
                <th>كود الطالب</th>
                <th>الاسم</th>
                <th>الصف</th>
                <th>أغسطس</th>
                <th>سبتمبر</th>
                <th>أكتوبر</th>
                <th>نوفمبر</th>
                <th>ديسمبر</th>
                <th>يناير</th>
                <th>فبراير</th>
                <th>مارس</th>
                <th>أبريل</th>
              </tr>
            </thead>
            <tbody id="feesReportBody"></tbody>
          </table>
        </div>

        <div id="attendanceReport" class="report-section">
          <div class="report-header">
            <h3><i class="fas fa-calendar-check"></i> تقرير الحضور والغياب</h3>
            <button class="btn btn-success" onclick="generateAttendanceReport()">
              <i class="fas fa-download"></i> تصدير التقرير
            </button>
          </div>
          <div class="report-filter">
            <select id="attendanceGradeFilter" style="flex: 1;">
              <option value="">جميع الصفوف</option>
            </select>
            <select id="attendanceDayFilter" style="flex: 1;">
              <option value="">جميع الأيام</option>
            </select>
            <select id="attendanceStatusFilter" style="flex: 1;">
              <option value="">جميع الحالات</option>
              <option value="حاضر">حاضر</option>
              <option value="غائب">غائب</option>
            </select>
            <button class="btn" onclick="filterAttendanceReport()">
              <i class="fas fa-filter"></i> تصفية
            </button>
          </div>
          <table class="report-table" id="attendanceReportTable">
            <thead>
              <tr>
                <th>كود الطالب</th>
                <th>الاسم</th>
                <th>الصف</th>
                <th>السبت</th>
                <th>الأحد</th>
                <th>الإثنين</th>
                <th>الثلاثاء</th>
                <th>الأربعاء</th>
                <th>الخميس</th>
                <th>الجمعة</th>
              </tr>
            </thead>
            <tbody id="attendanceReportBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="studentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle"><i class="fas fa-user-plus"></i> إضافة طالب جديد</h3>
        <span class="close" onclick="closeModal()">×</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="studentId"><i class="fas fa-id-card"></i> كود الطالب</label>
          <input type="text" id="studentId" placeholder="سيتم توليد الكود تلقائياً" disabled>
        </div>
        <div class="form-group">
          <label for="studentName"><i class="fas fa-user"></i> اسم الطالب</label>
          <input type="text" id="studentName" placeholder="أدخل اسم الطالب" required>
        </div>
        <div class="form-group">
          <label for="studentGrade"><i class="fas fa-graduation-cap"></i> الصف</label>
          <select id="studentGrade" required>
            <option value="" disabled selected>اختر الصف</option>
          </select>
        </div>
        <div class="form-group">
          <label for="studentPhone"><i class="fas fa-phone"></i> رقم ولي الأمر (اختياري)</label>
          <input type="text" id="studentPhone" placeholder="أدخل رقم الهاتف">
        </div>
        <div class="form-group">
          <label for="studentLevel"><i class="fas fa-star"></i> المستوى الأكاديمي (اختياري)</label>
          <select id="studentLevel">
            <option value="">اختر المستوى</option>
            <option value="ضعيف">ضعيف</option>
            <option value="مقبول">مقبول</option>
            <option value="جيد">جيد</option>
            <option value="جيد جدا">جيد جدا</option>
            <option value="ممتاز">ممتاز</option>
          </select>
        </div>
        <div class="form-group">
          <label><i class="fas fa-image"></i> صورة الطالب (اختياري)</label>
          <div class="image-upload-container">
            <img id="studentImagePreview" class="image-preview" alt="معاينة الصورة" onclick="expandImage(this)">
            <div class="image-actions" id="imageActions" style="display: none;">
              <button class="btn btn-small btn-danger" onclick="removeImage()">
                <i class="fas fa-trash"></i> حذف
              </button>
              <button class="btn btn-small btn-success" onclick="document.getElementById('studentImage').click()">
                <i class="fas fa-sync"></i> تغيير
              </button>
            </div>
            <button class="btn upload-btn">
              <i class="fas fa-upload"></i> اختر صورة
              <input type="file" id="studentImage" accept="image/*" onchange="previewStudentImage()">
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> إلغاء
        </button>
        <button class="btn btn-success" id="saveStudentBtn" onclick="saveStudent()">
          <i class="fas fa-save"></i> حفظ الطالب
        </button>
      </div>
    </div>
  </div>

  <div id="studentDetailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-user"></i> تفاصيل الطالب</h3>
        <span class="close" onclick="closeModal()">×</span>
      </div>
      <div class="modal-body">
        <div class="student-detail-card">
          <div class="student-detail-header">
            <h3 id="detailStudentName"></h3>
            <div class="student-id" id="detailStudentId"></div>
            <div class="student-grade" id="detailStudentGrade"></div>
          </div>
          <img id="detailStudentImage" class="image-preview" alt="صورة الطالب" onclick="expandImage(this)">
          <div class="student-info-item">
            <span class="student-info-label">المستوى الأكاديمي</span>
            <span class="student-info-value" id="detailStudentLevel"></span>
          </div>
          <div class="student-info-item">
            <span class="student-info-label">رقم ولي الأمر</span>
            <span class="student-info-value" id="detailStudentPhone"></span>
          </div>
          <div class="student-info-item">
            <span class="student-info-label">ملاحظات</span>
            <span class="student-info-value" id="detailStudentNotes"></span>
          </div>
          <div class="qr-code-container">
            <div id="qrCode"></div>
          </div>
          <div class="action-buttons">
            <button class="btn btn-success" onclick="shareStudentDetails()">
              <i class="fas fa-share"></i> مشاركة البيانات
            </button>
            <button class="btn btn-primary" onclick="downloadStudentCard()">
              <i class="fas fa-download"></i> حفظ البطاقة
            </button>
            <button class="btn btn-warning" onclick="showNotesModal()">
              <i class="fas fa-sticky-note"></i> إضافة ملاحظة
            </button>
            <button class="btn btn-primary" onclick="showFeesModal()">
              <i class="fas fa-money-bill"></i> إدارة المصروفات
            </button>
            <button class="btn btn-primary" onclick="showAttendanceModal()">
              <i class="fas fa-calendar-check"></i> إدارة الحضور
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="notesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-sticky-note"></i> ملاحظات الطالب</h3>
        <span class="close" onclick="closeModal()">×</span>
      </div>
      <div class="modal-body">
        <textarea id="notesContent" rows="6" placeholder="أدخل ملاحظات عن الطالب..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> إلغاء
        </button>
        <button class="btn btn-success" onclick="saveNotes()">
          <i class="fas fa-save"></i> حفظ الملاحظات
        </button>
      </div>
    </div>
  </div>

  <div id="feesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-money-bill"></i> إدارة المصروفات</h3>
        <span class="close" onclick="closeModal()">×</span>
      </div>
      <div class="modal-body">
        <div class="fees-grid" id="feesGrid"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> إلغاء
        </button>
        <button class="btn btn-success" onclick="saveFees()">
          <i class="fas fa-save"></i> حفظ
        </button>
      </div>
    </div>
  </div>

  <div id="attendanceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-calendar-check"></i> إدارة الحضور</h3>
        <span class="close" onclick="closeModal()">×</span>
      </div>
      <div class="modal-body">
        <div class="attendance-grid" id="attendanceGrid"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> إلغاء
        </button>
        <button class="btn btn-success" onclick="saveAttendance()">
          <i class="fas fa-save"></i> حفظ
        </button>
      </div>
    </div>
  </div>

  <div id="postModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="postModalTitle"><i class="fas fa-plus"></i> منشور جديد</h3>
        <span class="close" onclick="closePostModal()">×</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="editPostTitle"><i class="fas fa-heading"></i> عنوان المنشور</label>
          <input type="text" id="editPostTitle" placeholder="أدخل عنوان المنشور" required>
        </div>
        <div class="form-group">
          <label for="editPostContent"><i class="fas fa-align-left"></i> محتوى المنشور</label>
          <textarea id="editPostContent" rows="5" placeholder="أدخل محتوى المنشور" required></textarea>
        </div>
        <div class="form-group">
          <label><i class="fas fa-image"></i> صورة المنشور (اختياري)</label>
          <div class="image-upload-container">
            <img id="postImagePreview" class="image-preview" alt="معاينة الصورة" onclick="expandImage(this)">
            <div class="image-actions" id="postImageActions" style="display: none;">
              <button class="btn btn-small btn-danger" onclick="removePostImage()">
                <i class="fas fa-trash"></i> حذف
              </button>
              <button class="btn btn-small btn-success" onclick="document.getElementById('postImageInput').click()">
                <i class="fas fa-sync"></i> تغيير
              </button>
            </div>
            <button class="btn upload-btn">
              <i class="fas fa-upload"></i> اختر صورة
              <input type="file" id="postImageInput" accept="image/*" onchange="previewPostImage()">
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closePostModal()">
          <i class="fas fa-times"></i> إلغاء
        </button>
        <button class="btn btn-success" id="savePostBtn" onclick="savePost()">
          <i class="fas fa-save"></i> حفظ المنشور
        </button>
      </div>
    </div>
  </div>

  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-user-minus"></i> حذف طالب</h3>
        <span class="close" onclick="closeModal()">×</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="deleteStudentId"><i class="fas fa-id-card"></i> كود الطالب</label>
          <input type="text" id="deleteStudentId" placeholder="أدخل كود الطالب">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> إلغاء
        </button>
        <button class="btn btn-danger" onclick="deleteStudent()">
          <i class="fas fa-trash"></i> حذف
        </button>
      </div>
    </div>
  </div>

  <div id="gradeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-filter"></i> تصفية حسب الصف</h3>
        <span class="close" onclick="closeModal()">×</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="filterGrade"><i class="fas fa-graduation-cap"></i> اختر الصف</label>
          <select id="filterGrade">
            <option value="">جميع الصفوف</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> إلغاء
        </button>
        <button class="btn btn-success" onclick="filterByGrade()">
          <i class="fas fa-filter"></i> تصفية
        </button>
      </div>
    </div>
  </div>

  <div id="trashModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-trash"></i> سلة المهملات</h3>
        <span class="close" onclick="closeModal()">×</span>
      </div>
      <div class="modal-body">
        <div id="trashList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> إلغاء
        </button>
      </div>
    </div>
  </div>

  <script>
   // Initialize jsPDF
const { jsPDF } = window.jspdf;

let students = {};
let posts = {};
let trash = {};
let sha = "";
const owner = "Devolepor";
const repo = "app";
const path = "students.json";
const postsPath = "posts.json";
const trashPath = "trash.json";
const branch = "main";
const PASSWORD = "010135685900122327731001150929598";
const MAX_FILE_SIZE = 500000; // Maximum file size (~50KB before encoding)
let currentStudentId = null;
let currentPostId = null;
let deleteStudentId = null;
let isLoading = false;
let originalButtonText = "";
let postImageFile = null;
let studentImageFile = null;
let allStudentsData = {};
let currentDataFile = "students.json";

const grades = [
  "الصف الأول الابتدائي", "الصف الثاني الابتدائي", "الصف الثالث الابتدائي",
  "الصف الرابع الابتدائي", "الصف الخامس الابتدائي", "الصف السادس الابتدائي",
  "الصف الأول الإعدادي", "الصف الثاني الإعدادي", "الصف الثالث الإعدادي",
  "الصف الأول الثانوي", "الصف الثاني الثانوي", "الصف الثالث الثانوي"
];

const levels = ["ضعيف", "مقبول", "جيد", "جيد جدا", "ممتاز"];
const weekDays = ["السبت", "الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];
const months = ["أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر", "يناير", "فبراير", "مارس", "أبريل"];

// Theme toggle initialization
if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark-mode");
  document.getElementById("themeToggle").innerHTML = '<i class="fas fa-sun"></i> الوضع النهاري';
}

if (localStorage.getItem("gh_token")) {
  document.getElementById("token").value = localStorage.getItem("gh_token");
}

document.getElementById("themeToggle").addEventListener("click", function() {
  document.body.classList.toggle("dark-mode");
  if (document.body.classList.contains("dark-mode")) {
    localStorage.setItem("theme", "dark");
    this.innerHTML = '<i class="fas fa-sun"></i> الوضع النهاري';
  } else {
    localStorage.setItem("theme", "light");
    this.innerHTML = '<i class="fas fa-moon"></i> الوضع الليلي';
  }
});

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

function generateStudentId() {
  let id;
  do {
    id = Math.floor(100000 + Math.random() * 900000).toString();
  } while (allStudentsData[id]);
  return id;
}

function checkLogin() {
  const pass = document.getElementById("loginPassword").value;
  if (pass === PASSWORD) {
    localStorage.setItem("isLoggedIn", "true");
    document.getElementById("loginScreen").style.display = "none";
    loadAllStudentsData();
    loadPosts();
    loadTrash();
    fillGradeSelects();
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ar-EG');
  } else {
    Swal.fire({
      title: 'خطأ!',
      text: 'كلمة مرور خاطئة!',
      icon: 'error',
      confirmButtonText: 'حسناً'
    });
  }
}

function fillGradeSelects() {
  const gradeSelects = [
    document.getElementById('studentGrade'),
    document.getElementById('filterGrade'),
    document.getElementById('feesGradeFilter'),
    document.getElementById('attendanceGradeFilter')
  ];

  gradeSelects.forEach(select => {
    if (select) {
      select.innerHTML = '<option value="" disabled selected>اختر الصف</option>';
      grades.forEach(grade => {
        select.innerHTML += `<option value="${grade}">${grade}</option>`;
      });
    }
  });

  const monthSelect = document.getElementById('feesMonthFilter');
  if (monthSelect) {
    monthSelect.innerHTML = '<option value="">جميع الأشهر</option>';
    months.forEach(month => {
      monthSelect.innerHTML += `<option value="${month}">${month}</option>`;
    });
  }

  const daySelect = document.getElementById('attendanceDayFilter');
  if (daySelect) {
    daySelect.innerHTML = '<option value="">جميع الأيام</option>';
    weekDays.forEach(day => {
      daySelect.innerHTML += `<option value="${day}">${day}</option>`;
    });
  }
}

async function loadAllStudentsData() {
  try {
    showLoading(true);
    allStudentsData = {};
    students = {};

    await loadStudentsFile("students.json");

    let fileNumber = 1;
    let moreFilesExist = true;

    while (moreFilesExist) {
      try {
        const fileName = `students_${fileNumber}.json`;
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${fileName}`);

        if (res.ok) {
          await loadStudentsFile(fileName);
          fileNumber++;
        } else {
          moreFilesExist = false;
        }
      } catch (error) {
        moreFilesExist = false;
      }
    }

    determineCurrentFile();
    renderStudentCards();
    updateStats();
  } catch (error) {
    console.error("Error loading students data:", error);
    showError("حدث خطأ أثناء تحميل بيانات الطلاب");
  } finally {
    showLoading(false);
  }
}

async function loadStudentsFile(fileName) {
  try {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${fileName}`);
    if (!res.ok) throw new Error('فشل في تحميل ملف الطلاب');

    const data = await res.json();
    const decodedContent = decodeURIComponent(escape(atob(data.content)));
    const fileData = JSON.parse(decodedContent);

    Object.assign(allStudentsData, fileData);

    if (fileName === currentDataFile) {
      students = fileData;
      sha = data.sha;
    }

    return true;
  } catch (error) {
    console.error(`Error loading file ${fileName}:`, error);
    return false;
  }
}

function determineCurrentFile() {
  const mainFileSize = calculateFileSize(allStudentsData);
  if (mainFileSize < MAX_FILE_SIZE) {
    currentDataFile = "students.json";
    students = allStudentsData;
    document.getElementById('currentDataFile').textContent = "students.json";
    document.getElementById('totalStudentsInFile').textContent = Object.keys(students).length;
    return;
  }

  let fileNumber = 1;
  let latestFile = null;
  let latestFileSize = 0;

  while (true) {
    const fileName = `students_${fileNumber}.json`;
    const fileData = {};

    for (const [id, student] of Object.entries(allStudentsData)) {
      if (student._file === fileName) {
        fileData[id] = student;
      }
    }

    const size = calculateFileSize(fileData);
    if (size > 0 && size < MAX_FILE_SIZE) {
      latestFile = fileName;
      latestFileSize = size;
    } else if (size === 0) {
      break;
    }

    fileNumber++;
  }

  if (latestFile) {
    currentDataFile = latestFile;
    students = {};
    for (const [id, student] of Object.entries(allStudentsData)) {
      if (student._file === latestFile) {
        students[id] = student;
      }
    }
    document.getElementById('currentDataFile').textContent = latestFile;
    document.getElementById('totalStudentsInFile').textContent = Object.keys(students).length;
  } else {
    createNewDataFile();
  }
}

function calculateFileSize(data) {
  try {
    const jsonString = JSON.stringify(data);
    return new Blob([jsonString]).size;
  } catch (error) {
    console.error("Error calculating file size:", error);
    return 0;
  }
}

function createNewDataFile() {
  let fileNumber = 1;
  while (true) {
    const fileName = `students_${fileNumber}.json`;
    let fileExists = false;

    for (const student of Object.values(allStudentsData)) {
      if (student._file === fileName) {
       fileExists = true;
        break;
      }
    }
    if (!fileExists) {
      currentDataFile = fileName;
      students = {};
      document.getElementById('currentDataFile').textContent = fileName;
      document.getElementById('totalStudentsInFile').textContent = '0';
      break;
    }
    fileNumber++;
  }
}

async function loadPosts() {
  try {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`);
    if (res.ok) {
      const data = await res.json();
      const decodedContent = decodeURIComponent(escape(atob(data.content)));
      posts = JSON.parse(decodedContent);
      renderPosts();
    }
  } catch (error) {
    console.error("Error loading posts:", error);
  }
}

async function loadTrash() {
  try {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${trashPath}`);
    if (res.ok) {
      const data = await res.json();
      const decodedContent = decodeURIComponent(escape(atob(data.content)));
      trash = JSON.parse(decodedContent);
    }
  } catch (error) {
    console.error("Error loading trash:", error);
  }
}

function showLoading(isLoading) {
  const saveButton = document.getElementById('saveStudentBtn');
  if (isLoading) {
    if (saveButton) {
      originalButtonText = saveButton.innerHTML;
      saveButton.innerHTML = '<span class="spinner"></span> جارٍ الحفظ...';
      saveButton.disabled = true;
    }
  } else {
    if (saveButton) {
      saveButton.innerHTML = originalButtonText;
      saveButton.disabled = false;
    }
  }
}

function showError(message) {
  Swal.fire({
    title: 'خطأ!',
    text: message,
    icon: 'error',
    confirmButtonText: 'حسناً'
  });
}

function showAddModal() {
  document.getElementById('studentModal').style.display = 'block';
  document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus"></i> إضافة طالب جديد';
  document.getElementById('studentId').value = generateStudentId();
  document.getElementById('studentName').value = '';
  document.getElementById('studentGrade').value = '';
  document.getElementById('studentPhone').value = '';
  document.getElementById('studentLevel').value = '';
  document.getElementById('studentImage').value = '';
  document.getElementById('studentImagePreview').src = '';
  document.getElementById('imageActions').style.display = 'none';
  studentImageFile = null;
}

function showEditModal(studentId) {
  currentStudentId = studentId;
  const student = allStudentsData[studentId];
  document.getElementById('studentModal').style.display = 'block';
  document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-edit"></i> تعديل بيانات الطالب';
  document.getElementById('studentId').value = studentId;
  document.getElementById('studentName').value = student.name || '';
  document.getElementById('studentGrade').value = student.grade || '';
  document.getElementById('studentPhone').value = student.phone || '';
  document.getElementById('studentLevel').value = student.level || '';
  document.getElementById('studentImagePreview').src = student.image || '';
  document.getElementById('imageActions').style.display = student.image ? 'block' : 'none';
  studentImageFile = student.image ? student.image : null;
}

function showStudentDetails(studentId) {
  currentStudentId = studentId;
  const student = allStudentsData[studentId];
  document.getElementById('studentDetailsModal').style.display = 'block';
  document.getElementById('detailStudentName').textContent = student.name || 'غير متوفر';
  document.getElementById('detailStudentId').textContent = `كود الطالب: ${studentId}`;
  document.getElementById('detailStudentGrade').textContent = student.grade || 'غير متوفر';
  document.getElementById('detailStudentLevel').textContent = student.level || 'غير متوفر';
  document.getElementById('detailStudentPhone').textContent = student.phone || 'غير متوفر';
  document.getElementById('detailStudentNotes').textContent = student.notes || 'لا توجد ملاحظات';
  document.getElementById('detailStudentImage').src = student.image || '';
  const qrCodeDiv = document.getElementById('qrCode');
  qrCodeDiv.innerHTML = '';
  new QRCode(qrCodeDiv, {
    text: JSON.stringify({ id: studentId, name: student.name, grade: student.grade }),
    width: 128,
    height: 128
  });
}

async function saveStudent() {
  const studentId = document.getElementById('studentId').value;
  const name = document.getElementById('studentName').value.trim();
  const grade = document.getElementById('studentGrade').value;
  const phone = document.getElementById('studentPhone').value.trim();
  const level = document.getElementById('studentLevel').value;

  if (!name || !grade) {
    showError('الاسم والصف مطلوبان');
    return;
  }

  showLoading(true);

  try {
    const studentData = {
      name,
      grade,
      phone: phone || null,
      level: level || null,
      image: studentImageFile,
      fees: allStudentsData[studentId]?.fees || months.reduce((acc, month) => ({ ...acc, [month]: false }), {}),
      attendance: allStudentsData[studentId]?.attendance || weekDays.reduce((acc, day) => ({ ...acc, [day]: [] }), {}),
      notes: allStudentsData[studentId]?.notes || '',
      _file: currentDataFile
    };

    allStudentsData[studentId] = studentData;
    students[studentId] = studentData;

    await saveToGitHub();
    renderStudentCards();
    updateStats();
    closeModal();

    // Show student details modal with QR code immediately after saving
    showStudentDetails(studentId);

    Swal.fire({
      title: 'تم!',
      text: currentStudentId ? 'تم تعديل بيانات الطالب بنجاح' : 'تم إضافة الطالب بنجاح',
      icon: 'success',
      confirmButtonText: 'حسناً'
    });

    currentStudentId = null;
  } catch (error) {
    console.error("Error saving student:", error);
    showError('ح حفظ بيانات الطالب');
  } finally {
    showLoading(false);
  }
}

function previewStudentImage() {
  const file = document.getElementById('studentImage').files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('studentImagePreview').src = e.target.result;
      studentImageFile = e.target.result;
      document.getElementById('imageActions').style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
}

function removeImage() {
  document.getElementById('studentImagePreview').src = '';
  document.getElementById('studentImage').value = '';
  studentImageFile = null;
  document.getElementById('imageActions').style.display = 'none';
}

function renderStudentCards(filteredStudents = students) {
  const container = document.getElementById('studentsCards');
  container.innerHTML = '';
  const studentCount = Object.keys(filteredStudents).length;
  document.getElementById('studentsCountNumber').textContent = studentCount;

  if (studentCount === 0) {
    container.innerHTML = '<div class="no-students"><i class="fas fa-exclamation-circle"></i> لا يوجد طلاب لعرضهم</div>';
    return;
  }

  Object.entries(filteredStudents).forEach(([id, student]) => {
    const card = document.createElement('div');
    card.className = 'student-card';
    card.innerHTML = `
      <div class="student-header" onclick="showStudentDetails('${id}')">
        ${student.image ? `<img src="${student.image}" class="student-image-thumb" alt="صورة ${student.name}">` : ''}
        <div>
          <div class="student-name">${student.name}</div>
          <div class="student-id">كود: ${id}</div>
        </div>
        <div class="student-grade">${student.grade}</div>
      </div>
      <div class="student-level">${student.level || 'غير محدد'}</div>
      <i class="fas fa-edit edit-student-btn" onclick="showEditModal('${id}')"></i>
    `;
    container.appendChild(card);
  });
}

function showDeleteModal(studentId) {
  document.getElementById('deleteModal').style.display = 'block';
  document.getElementById('deleteStudentId').value = studentId || '';
}

async function deleteStudent() {
  const studentId = document.getElementById('deleteStudentId').value;
  if (!studentId || !allStudentsData[studentId]) {
    showError('يرجى إدخال كود طالب صحيح');
    return;
  }

  showLoading(true);
  try {
    trash[studentId] = { ...allStudentsData[studentId], deletedAt: new Date().toISOString() };
    delete allStudentsData[studentId];
    delete students[studentId];

    await Promise.all([
      saveToGitHub(),
      saveTrash()
    ]);

    renderStudentCards();
    updateStats();
    closeModal();
    Swal.fire({
      title: 'تم!',
      text: 'تم حذف الطالب بنجاح',
      icon: 'success',
      confirmButtonText: 'حسناً'
    });
  } catch (error) {
    console.error("Error deleting student:", error);
    showError('حدث خطأ أثناء حذف الطالب');
  } finally {
    showLoading(false);
  }
}

function showTrash() {
  document.getElementById('trashModal').style.display = 'block';
  const trashList = document.getElementById('trashList');
  trashList.innerHTML = '';

  Object.entries(trash).forEach(([id, student]) => {
    const item = document.createElement('div');
    item.className = 'student-card';
    item.innerHTML = `
      <div class="student-header">
        ${student.image ? `<img src="${student.image}" class="student-image-thumb" alt="صورة ${student.name}">` : ''}
        <div>
          <div class="student-name">${student.name}</div>
          <div class="student-id">كود: ${id}</div>
        </div>
        <div class="student-grade">${student.grade}</div>
      </div>
      <div class="student-level">تاريخ الحذف: ${new Date(student.deletedAt).toLocaleDateString('ar-EG')}</div>
      <button class="btn btn-success" onclick="restoreStudent('${id}')">
        <i class="fas fa-undo"></i> استعادة
      </button>
    `;
    trashList.appendChild(item);
  });
}

async function restoreStudent(studentId) {
  showLoading(true);
  try {
    allStudentsData[studentId] = { ...trash[studentId], _file: currentDataFile };
    students[studentId] = allStudentsData[studentId];
    delete trash[studentId];

    await Promise.all([
      saveToGitHub(),
      saveTrash()
    ]);

    renderStudentCards();
    updateStats();
    showTrash();
    Swal.fire({
      title: 'تم!',
      text: 'تم استعادة الطالب بنجاح',
      icon: 'success',
      confirmButtonText: 'حسناً'
    });
  } catch (error) {
    console.error("Error restoring student:", error);
    showError('حدث خطأ أثناء استعادة الطالب');
  } finally {
    showLoading(false);
  }
}

async function saveToGitHub() {
  const token = document.getElementById('token').value;
  if (!token) {
    showError('يرجى إدخال رمز GitHub');
    return;
  }

  localStorage.setItem('gh_token', token);

  try {
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(students))));
    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${currentDataFile}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Update ${currentDataFile}`,
        content,
        sha,
        branch
      })
    });

    if (!response.ok) throw new Error(' في حفظ البيانات على GitHub');
    const data = await response.json();
    sha = data.content.sha;
  } catch (error) {
    console.error("Error saving to GitHub:", error);
    throw error;
  }
}

async function saveTrash() {
  const token = document.getElementById('token').value;
  if (!token) return;

  try {
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(trash))));
    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${trashPath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: 'Update trash.json',
        content,
        branch
      })
    });

    if (!response.ok) throw new Error('فشل في حفظ بيانات سلة المهملات');
  } catch (error) {
    console.error("Error saving trash:", error);
    throw error;
  }
}

function switchDataFile() {
  Swal.fire({
    title: 'تبديل ملف البيانات',
    input: 'select',
    inputOptions: Object.keys(allStudentsData).reduce((acc, id) => {
      const file = allStudentsData[id]._file;
      if (!acc[file]) acc[file] = file;
      return acc;
    }, {}),
    inputPlaceholder: 'اختر ملف البيانات',
    showCancelButton: true,
    confirmButtonText: 'تبديل',
    cancelButtonText: 'إلغاء'
  }).then(async (result) => {
    if (result.isConfirmed && result.value) {
      currentDataFile = result.value;
      students = {};
      for (const [id, student] of Object.entries(allStudentsData)) {
        if (student._file === currentDataFile) {
          students[id] = student;
        }
      }
      document.getElementById('currentDataFile').textContent = currentDataFile;
      document.getElementById('totalStudentsInFile').textContent = Object.keys(students).length;
      renderStudentCards();
      updateStats();

      try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${currentDataFile}`);
        if (res.ok) {
          const data = await res.json();
          sha = data.sha;
        }
      } catch (error) {
        console.error("Error loading file SHA:", error);
      }
    }
  });
}

function searchStudent() {
  const studentId = document.getElementById('searchId').value.trim();
  if (!studentId) {
    renderStudentCards();
    return;
  }

  const student = allStudentsData[studentId];
  if (student) {
    renderStudentCards({ [studentId]: student });
  } else {
    showError('لم يتم العثور على طالب بهذا الكود');
    renderStudentCards({});
  }
}

function showGradeModal() {
  document.getElementById('gradeModal').style.display = 'block';
}

function filterByGrade() {
  const grade = document.getElementById('filterGrade').value;
  if (!grade) {
    renderStudentCards();
  } else {
    const filteredStudents = Object.fromEntries(
      Object.entries(allStudentsData).filter(([_, student]) => student.grade === grade)
    );
    renderStudentCards(filteredStudents);
  }
  closeModal();
}

function showAllStudents() {
  renderStudentCards();
}

function hideAllStudents() {
  renderStudentCards({});
}

function closeModal() {
  document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
  currentStudentId = null;
  currentPostId = null;
}

function closeImageModal() {
  document.getElementById('imageModal').style.display = 'none';
}

function expandImage(imgElement) {
  document.getElementById('expandedImage').src = imgElement.src;
  document.getElementById('imageModal').style.display = 'block';
}

function showPostModal(postId = null) {
  currentPostId = postId;
  document.getElementById('postModal').style.display = 'block';
  document.getElementById('postModalTitle').innerHTML = postId
    ? '<i class="fas fa-edit"></i> تعديل المنشور'
    : '<i class="fas fa-plus"></i> منشور جديد';
  document.getElementById('editPostTitle').value = postId ? posts[postId].title : '';
  document.getElementById('editPostContent').value = postId ? posts[postId].content : '';
  document.getElementById('postImagePreview').src = postId ? posts[postId].image || '' : '';
  document.getElementById('postImageActions').style.display = postId && posts[postId].image ? 'block' : 'none';
  postImageFile = postId ? posts[postId].image : null;
}

function previewPostImage() {
  const file = document.getElementById('postImageInput').files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('postImagePreview').src = e.target.result;
      postImageFile = e.target.result;
      document.getElementById('postImageActions').style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
}

function removePostImage() {
  document.getElementById('postImagePreview').src = '';
  document.getElementById('postImageInput').value = '';
  postImageFile = null;
  document.getElementById('postImageActions').style.display = 'none';
}

async function savePost() {
  const title = document.getElementById('editPostTitle').value.trim();
  const content = document.getElementById('editPostContent').value.trim();

  if (!title || !content) {
    showError('عنوان ومحتوى المنشور مطلوبان');
    return;
  }

  showLoading(true);
  try {
    const postId = currentPostId || Date.now().toString();
    posts[postId] = {
      title,
      content,
      image: postImageFile,
      date: new Date().toISOString(),
      likes: posts[postId]?.likes || 0,
      comments: posts[postId]?.comments || []
    };

    const token = document.getElementById('token').value;
    if (!token) {
      showError('يرجى إدخال رمز GitHub');
      return;
    }

    const contentEncoded = btoa(unescape(encodeURIComponent(JSON.stringify(posts))));
    const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Update ${postsPath}`,
        content: contentEncoded,
        branch
      })
    });

    if (!response.ok) throw new Error('فشل في حفظ المنشور');
    renderPosts();
    closePostModal();
    Swal.fire({
      title: 'تم!',
      text: currentPostId ? 'تم تعديل المنشور بنجاح' : 'تم إضافة المنشور بنجاح',
      icon: 'success',
      confirmButtonText: 'حسناً'
    });
    currentPostId = null;
  } catch (error) {
    console.error("Error saving post:", error);
    showError('حدث خطأ أثناء حفظ المنشور');
  } finally {
    showLoading(false);
  }
}

function renderPosts() {
  const container = document.getElementById('postsList');
  container.innerHTML = '';

  Object.entries(posts).sort((a, b) => new Date(b[1].date) - new Date(a[1].date)).forEach(([id, post]) => {
    const postElement = document.createElement('div');
    postElement.className = 'post';
    postElement.innerHTML = `
      <div class="post-header">
        <div class="post-avatar">${post.title.charAt(0)}</div>
        <div>
          <div class="post-author">${post.title}</div>
          <div class="post-date">${new Date(post.date).toLocaleString('ar-EG')}</div>
        </div>
      </div>
      <div class="post-content">${post.content}</div>
      ${post.image ? `<img src="${post.image}" class="post-image" alt="صورة المنشور" onclick="expandImage(this)">` : ''}
      <div class="post-actions">
        <span class="post-action ${post.liked ? 'liked' : ''}" onclick="toggleLike('${id}')">
          <i class="fas fa-heart"></i> ${post.likes || 0}
        </span>
        <span class="post-action" onclick="showComments('${id}')">
          <i class="fas fa-comment"></i> ${post.comments?.length || 0}
        </span>
      </div>
      <i class="fas fa-trash post-delete" onclick="deletePost('${id}')"></i>
    `;
    container.appendChild(postElement);
  });
}

async function deletePost(postId) {
  Swal.fire({
    title: 'هل أنت متأكد؟',
    text: 'لن تتمكن من استعادة هذا المنشور!',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'نعم، احذف!',
    cancelButtonText: 'إلغاء'
  }).then(async (result) => {
    if (result.isConfirmed) {
      delete posts[postId];
      try {
        await savePosts();
        renderPosts();
        Swal.fire({
          title: 'تم!',
          text: 'تم حذف المنشور بنجاح',
          icon: 'success',
          confirmButtonText: 'حسناً'
        });
      } catch (error) {
        console.error("Error deleting post:", error);
        showError('حدث خطأ أثناء حذف المنشور');
      }
    }
  });
}

async function savePosts() {
  const token = document.getElementById('token').value;
  if (!token) {
    showError('يرجى إدخال رمز GitHub');
    return;
  }

  const content = btoa(unescape(encodeURIComponent(JSON.stringify(posts))));
  const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`, {
    method: 'PUT',
    headers: {
      'Authorization': `token ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: `Update ${postsPath}`,
      content,
      branch
    })
  });

  if (!response.ok) throw new Error('فشل في حفظ المنشورات');
}

function toggleLike(postId) {
  posts[postId].likes = posts[postId].likes ? posts[postId].likes + 1 : 1;
  posts[postId].liked = !posts[postId].liked;
  renderPosts();
  savePosts();
}

function showComments(postId) {
  Swal.fire({
    title: 'التعليقات',
    text: 'هذه الميزة قيد التطوير',
    icon: 'info',
    confirmButtonText: 'حسناً'
  });
}

function showFeesModal() {
  document.getElementById('feesModal').style.display = 'block';
  const feesGrid = document.getElementById('feesGrid');
  feesGrid.innerHTML = '';

  const student = allStudentsData[currentStudentId];
  months.forEach(month => {
    const feeItem = document.createElement('div');
    feeItem.className = 'fee-item';
    feeItem.innerHTML = `
      <span>${month}</span>
      <input type="checkbox" ${student.fees[month] ? 'checked' : ''} onchange="updateFee('${month}', this.checked)">
    `;
    feesGrid.appendChild(feeItem);
  });
}

function updateFee(month, isPaid) {
  allStudentsData[currentStudentId].fees[month] = isPaid;
  students[currentStudentId].fees[month] = isPaid;
}

async function saveFees() {
  showLoading(true);
  try {
    await saveToGitHub();
    closeModal();
    Swal.fire({
      title: 'تم!',
      text: 'تم حفظ بيانات المصروفات بنجاح',
      icon: 'success',
      confirmButtonText: 'حسناً'
    });
    updateStats();
  } catch (error) {
    console.error("Error saving fees:", error);
    showError('حدث خطأ أثناء حفظ بيانات المصروفات');
  } finally {
    showLoading(false);
  }
}

function showAttendanceModal() {
  document.getElementById('attendanceModal').style.display = 'block';
  const attendanceGrid = document.getElementById('attendanceGrid');
  attendanceGrid.innerHTML = '';

  const student = allStudentsData[currentStudentId];
  weekDays.forEach(day => {
    const attendanceItem = document.createElement('div');
    attendanceItem.className = 'attendance-item';
    attendanceItem.innerHTML = `
      <span>${day}</span>
      <input type="checkbox" ${student.attendance[day].includes(new Date().toISOString().split('T')[0]) ? 'checked' : ''} onchange="updateAttendance('${day}', this.checked)">
    `;
    attendanceGrid.appendChild(attendanceItem);
  });
}

function updateAttendance(day, isPresent) {
  const today = new Date().toISOString().split('T')[0];
  const student = allStudentsData[currentStudentId];
  if (isPresent) {
    if (!student.attendance[day].includes(today)) {
      student.attendance[day].push(today);
    }
  } else {
    student.attendance[day] = student.attendance[day].filter(date => date !== today);
  }
  students[currentStudentId].attendance[day] = student.attendance[day];
}

async function saveAttendance() {
  showLoading(true);
  try {
    await saveToGitHub();
    closeModal();
    Swal.fire({
      title: 'تم!',
      text: 'تم حفظ بيانات الحضور بنجاح',
      icon: 'success',
      confirmButtonText: 'حسناً'
    });
    updateStats();
  } catch (error) {
    console.error("Error saving attendance:", error);
    showError('حدث خطأ أثناء حفظ بيانات الحضور');
  } finally {
    showLoading(false);
  }
}

function showNotesModal() {
  document.getElementById('notesModal').style.display = 'block';
  document.getElementById('notesContent').value = allStudentsData[currentStudentId].notes || '';
}

async function saveNotes() {
  const notes = document.getElementById('notesContent').value.trim();
  allStudentsData[currentStudentId].notes = notes;
  students[currentStudentId].notes = notes;

  showLoading(true);
  try {
    await saveToGitHub();
    closeModal();
    showStudentDetails(currentStudentId);
    Swal.fire({
      title: 'تم!',
      text: 'تم حفظ الملاحظات بنجاح',
      icon: 'success',
      confirmButtonText: 'حسناً'
    });
  } catch (error) {
    console.error("Error saving notes:", error);
    showError('حدث خطأ أثناء حفظ الملاحظات');
  } finally {
    showLoading(false);
  }
}

function updateStats() {
  const totalStudents = Object.keys(allStudentsData).length;
  const today = new Date().toISOString().split('T')[0];
  let todayPresent = 0;
  let paidFees = 0;

  Object.values(allStudentsData).forEach(student => {
    const todayAttendance = Object.values(student.attendance).some(dates => dates.includes(today));
    if (todayAttendance) todayPresent++;
    const hasPaid = Object.values(student.fees).some(paid => paid);
    if (hasPaid) paidFees++;
  });

  document.getElementById('totalStudentsCount').textContent = totalStudents;
  document.getElementById('todayPresentCount').textContent = todayPresent;
  document.getElementById('todayAbsentCount').textContent = totalStudents - todayPresent;
  document.getElementById('paidFeesCount').textContent = paidFees;
  document.getElementById('unpaidFeesCount').textContent = totalStudents - paidFees;
}

function showReports(type) {
  switchTab('reports');
  document.querySelectorAll('.report-section').forEach(section => section.style.display = 'none');
  document.getElementById(`${type}Report`).style.display = 'block';

  if (type === 'fees') {
    filterFeesReport();
  } else if (type === 'attendance') {
    filterAttendanceReport();
  } else if (type === 'stats') {
    updateStats();
  }
}

function filterFeesReport() {
  const grade = document.getElementById('feesGradeFilter').value;
  const month = document.getElementById('feesMonthFilter').value;
  const status = document.getElementById('feesStatusFilter').value;
  const tbody = document.getElementById('feesReportBody');
  tbody.innerHTML = '';

  Object.entries(allStudentsData).forEach(([id, student]) => {
    if (grade && student.grade !== grade) return;
    if (month && status) {
      if (status === 'paid' && !student.fees[month]) return;
      if (status === 'unpaid' && student.fees[month]) return;
    }

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${id}</td>
      <td>${student.name}</td>
      <td>${student.grade}</td>
      ${months.map(m => `<td>${student.fees[m] ? '✅' : '❌'}</td>`).join('')}
    `;
    tbody.appendChild(row);
  });
}

function filterAttendanceReport() {
  const grade = document.getElementById('attendanceGradeFilter').value;
  const day = document.getElementById('attendanceDayFilter').value;
  const status = document.getElementById('attendanceStatusFilter').value;
  const tbody = document.getElementById('attendanceReportBody');
  tbody.innerHTML = '';

  Object.entries(allStudentsData).forEach(([id, student]) => {
    if (grade && student.grade !== grade) return;
    if (day && status) {
      const today = new Date().toISOString().split('T')[0];
      const isPresent = student.attendance[day].includes(today);
      if (status === 'حاضر' && !isPresent) return;
      if (status === 'غائب' && isPresent) return;
    }

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${id}</td>
      <td>${student.name}</td>
      <td>${student.grade}</td>
      ${weekDays.map(d => `<td>${student.attendance[d].includes(new Date().toISOString().split('T')[0]) ? '✅' : '❌'}</td>`).join('')}
    `;
    tbody.appendChild(row);
  });
}

function generateFeesReport() {
  const grade = document.getElementById('feesGradeFilter').value;
  const month = document.getElementById('feesMonthFilter').value;
  const status = document.getElementById('feesStatusFilter').value;

  const ws_data = [['كود الطالب', 'الاسم', 'الصف', ...months]];
  Object.entries(allStudentsData).forEach(([id, student]) => {
    if (grade && student.grade !== grade) return;
    if (month && status) {
      if (status === 'paid' && !student.fees[month]) return;
      if (status === 'unpaid' && student.fees[month]) return;
    }
    ws_data.push([id, student.name, student.grade, ...months.map(m => student.fees[m] ? 'مسدد' : 'غير مسدد')]);
  });

  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'تقرير المصروفات');
  XLSX.writeFile(wb, 'تقرير_المصروفات.xlsx');
}

function generateAttendanceReport() {
  const grade = document.getElementById('attendanceGradeFilter').value;
  const day = document.getElementById('attendanceDayFilter').value;
  const status = document.getElementById('attendanceStatusFilter').value;

  const ws_data = [['كود الطالب', 'الاسم', 'الصف', ...weekDays]];
  Object.entries(allStudentsData).forEach(([id, student]) => {
    if (grade && student.grade !== grade) return;
    if (day && status) {
      const today = new Date().toISOString().split('T')[0];
      const isPresent = student.attendance[day].includes(today);
      if (status === 'حاضر' && !isPresent) return;
      if (status === 'غائب' && isPresent) return;
    }
    ws_data.push([id, student.name, student.grade, ...weekDays.map(d => student.attendance[d].includes(new Date().toISOString().split('T')[0]) ? 'حاضر' : 'غائب')]);
  });

  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'تقرير الحضور');
  XLSX.writeFile(wb, 'تقرير_الحضور.xlsx');
}

function downloadStudentCard() {
  const student = allStudentsData[currentStudentId];
  const doc = new jsPDF();
  doc.setFont('Amiri', 'normal');
  doc.setFontSize(16);
  doc.text(`بطاقة الطالب: ${student.name}`, 105, 20, { align: 'center' });
  doc.setFontSize(12);
  doc.text(`كود الطالب: ${currentStudentId}`, 105, 40, { align: 'center' });
  doc.text(`الصف: ${student.grade}`, 105, 50, { align: 'center' });
  doc.text(`المستوى الأكاديمي: ${student.level || 'غير محدد'}`, 105, 60, { align: 'center' });
  doc.text(`رقم ولي الأمر: ${student.phone || 'غير متوفر'}`, 105, 70, { align: 'center' });

  const qrCodeCanvas = document.querySelector('#qrCode canvas');
  if (qrCodeCanvas) {
    const qrCodeDataURL = qrCodeCanvas.toDataURL('image/png');
    doc.addImage(qrCodeDataURL, 'PNG', 85, 80, 40, 40);
  }

  if (student.image) {
    doc.addImage(student.image, 'JPEG', 80, 130, 50, 50);
  }

  doc.save(`بطاقة_${student.name}.pdf`);
}

function shareStudentDetails() {
  const student = allStudentsData[currentStudentId];
  const text = `بيانات الطالب\nالاسم: ${student.name}\nكود الطالب: ${currentStudentId}\nالصف: ${student.grade}\nالمستوى: ${student.level || 'غير محدد'}\nرقم ولي الأمر: ${student.phone || 'غير متوفر'}\nملاحظات: ${student.notes || 'لا توجد ملاحظات'}`;
  
  if (navigator.share) {
    navigator.share({
      title: `بطاقة ${student.name}`,
      text,
      url: window.location.href
    }).catch(error => console.error('Error sharing:', error));
  } else {
    navigator.clipboard.writeText(text).then(() => {
      Swal.fire({
        title: 'تم!',
        text: 'تم نسخ بيانات الطالب إلى الحافظة',
        icon: 'success',
        confirmButtonText: 'حسناً'
      });
    });
  }
}

function exportData(format) {
  if (format === 'json') {
    const dataStr = JSON.stringify(allStudentsData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'students_data.json';
    a.click();
    URL.revokeObjectURL(url);
  }
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
  document.getElementById(`${tab}-tab`).classList.add('active');
}

if (localStorage.getItem('isLoggedIn') === 'true') {
  document.getElementById('loginScreen').style.display = 'none';
  loadAllStudentsData();
  loadPosts();
  loadTrash();
  fillGradeSelects();
  document.getElementById('currentDate').textContent = new Date().toLocaleDateString('ar-EG');
}
  </script>
</body>
</html>
