<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #1976d2;
      --primary-dark: #125ea5;
      --danger-color: #e53935;
      --warning-color: #ff9800;
      --success-color: #43a047;
      --text-color: #2d3748;
      --text-light: #4a5568;
      --light-bg: #f8fafc;
      --white: #ffffff;
      --gray-light: #e2e8f0;
      --gray-dark: #cbd5e0;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .dark-mode {
      --primary-color: #4299e1;
      --primary-dark: #3182ce;
      --danger-color: #fc8181;
      --warning-color: #f6ad55;
      --success-color: #68d391;
      --text-color: #e2e8f0;
      --text-light: #a0aec0;
      --light-bg: #1a202c;
      --white: #2d3748;
      --gray-light: #4a5568;
      --gray-dark: #2d3748;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--light-bg);
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      transition: var(--transition);
    }
    
    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      transition: var(--transition);
    }
    
    .sidebar {
      position: fixed;
      right: -100%;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: var(--white);
      box-shadow: var(--shadow);
      transition: var(--transition);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }
    
    .sidebar.open {
      right: 0;
    }
    
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .sidebar-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .sidebar-menu {
      list-style: none;
    }
    
    .sidebar-menu li {
      margin-bottom: 10px;
    }
    
    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 15px;
      border-radius: var(--radius);
      color: var(--text-color);
      text-decoration: none;
      transition: var(--transition);
      font-weight: 500;
      background-color: var(--light-bg);
    }
    
    .sidebar-menu a:hover {
      background-color: var(--primary-color);
      color: var(--white);
      transform: translateX(-5px);
    }
    
    .sidebar-menu a i {
      margin-left: 10px;
      font-size: 18px;
    }
    
    .sidebar-toggle {
      position: fixed;
      right: 20px;
      top: 20px;
      background-color: var(--primary-color);
      color: var(--white);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1001;
      box-shadow: var(--shadow);
      font-size: 20px;
      transition: var(--transition);
    }
    
    .sidebar-toggle:hover {
      transform: scale(1.1);
    }
    
    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 15px 0;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .header h1 {
      color: var(--primary-color);
      font-size: 24px;
      font-weight: 700;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .grade-select {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    input, button, select, textarea {
      padding: 12px 15px;
      border-radius: var(--radius);
      border: 1px solid var(--gray-light);
      font-family: 'Tajawal', sans-serif;
      font-size: 16px;
      transition: var(--transition);
      width: 100%;
      background-color: var(--white);
      color: var(--text-color);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }
    
    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .btn {
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      transition: var(--transition);
      box-shadow: var(--shadow);
      padding: 12px 20px;
      border-radius: 8px;
    }
    
    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-danger {
      background-color: var(--danger-color);
    }
    
    .btn-danger:hover {
      background-color: #c62828;
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-success:hover {
      background-color: #2e7d32;
    }
    
    .btn-warning {
      background-color: var(--warning-color);
    }
    
    .btn-warning:hover {
      background-color: #e65100;
    }
    
    .btn-secondary {
      background-color: var(--gray-light);
      color: var(--text-color);
    }
    
    .btn-secondary:hover {
      background-color: var(--gray-dark);
    }
    
    .btn-small {
      padding: 8px 15px;
      font-size: 14px;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn-group .btn {
      flex: 1;
      min-width: 120px;
    }
    
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--white) 0%, var(--light-bg) 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      animation: fadeIn 0.5s ease;
    }
    
    .login-box {
      background: var(--white);
      padding: 30px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 400px;
      text-align: center;
      transform: scale(0.9);
      animation: popIn 0.4s ease forwards;
    }
    
    @keyframes popIn {
      0% { transform: scale(0.9); opacity: 0; }
      80% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .login-box h2 {
      margin-bottom: 25px;
      color: var(--primary-color);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .login-box input {
      margin-bottom: 20px;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      overflow-y: auto;
      padding: 0;
      box-sizing: border-box;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background-color: var(--white);
      padding: 25px;
      border-radius: 0;
      width: 100%;
      min-height: 100vh;
      box-shadow: none;
      margin: 0;
      position: relative;
      animation: slideIn 0.3s ease forwards;
      z-index: 1051;
    }
    
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .modal-title {
      margin: 0;
      color: var(--primary-color);
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close {
      color: var(--text-light);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
      background: var(--light-bg);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .close:hover {
      color: var(--danger-color);
      background: rgba(229, 57, 53, 0.1);
      transform: rotate(90deg);
    }
    
    .modal-body {
      padding: 15px 0;
    }
    
    .modal-footer {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-top: 20px;
      border-top: 1px solid var(--gray-light);
      margin-top: 20px;
      position: sticky;
      bottom: 0;
      background: var(--white);
      padding-bottom: 20px;
    }
    
    .modal-footer button {
      width: 100%;
    }
    
    .image-upload-container {
      background: var(--light-bg);
      padding: 20px;
      border-radius: 12px;
      margin-top: 10px;
    }
    
    .image-preview-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .image-preview {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px dashed var(--gray-light);
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow);
      display: none;
    }
    
    .image-preview:hover {
      transform: scale(1.03);
      border-color: var(--primary-color);
    }
    
    .image-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      width: 100%;
      margin-top: 10px;
      display: none;
    }
    
    .upload-btn {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    
    .upload-btn input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .image-modal .modal-content {
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      padding: 20px;
    }
    
    .image-modal-content {
      max-width: 100%;
      max-height: 80vh;
      border-radius: 8px;
      box-shadow: 0 5px 30px rgba(0,0,0,0.3);
      animation: zoomIn 0.3s ease;
    }
    
    @keyframes zoomIn {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    
    .close-image {
      position: fixed;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1002;
      background: rgba(0,0,0,0.5);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
    }
    
    .close-image:hover {
      transform: rotate(90deg);
      background: rgba(0,0,0,0.8);
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--gray-light);
      overflow-x: auto;
      padding-bottom: 5px;
    }
    
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: var(--transition);
      white-space: nowrap;
      font-weight: 500;
    }
    
    .tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    #studentsCards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    
    .student-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 15px;
      transition: var(--transition);
      position: relative;
    }
    
    .student-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    
    .student-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
      cursor: pointer;
    }
    
    .student-id {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 16px;
    }
    
    .student-name {
      font-weight: bold;
      font-size: 18px;
    }
    
    .student-grade {
      color: var(--text-light);
      font-size: 14px;
    }
    
    .student-level {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .level-weak {
      background-color: #ffebee;
      color: #c62828;
    }
    
    .level-acceptable {
      background-color: #fff8e1;
      color: #e65100;
    }
    
    .level-good {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    
    .level-very-good {
      background-color: #e3f2fd;
      color: #1565c0;
    }
    
    .level-excellent {
      background-color: #f3e5f5;
      color: #6a1b9a;
    }
    
    .student-image-thumb {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--gray-light);
    }
    
    .posts-container {
      margin-top: 30px;
    }
    
    .posts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .post {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
      transition: var(--transition);
    }
    
    .post:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .post-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-left: 15px;
    }
    
    .post-author {
      font-weight: bold;
    }
    
    .post-date {
      color: var(--text-light);
      font-size: 14px;
    }
    
    .post-content {
      margin-bottom: 15px;
      line-height: 1.6;
    }
    
    .post-image {
      max-width: 100%;
      border-radius: 8px;
      margin: 10px 0;
      display: block;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .post-image:hover {
      transform: scale(1.02);
    }
    
    .post-actions {
      display: flex;
      gap: 15px;
      border-top: 1px solid var(--gray-light);
      padding-top: 15px;
      flex-wrap: wrap;
    }
    
    .post-action {
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--text-light);
      cursor: pointer;
      transition: var(--transition);
      padding: 8px 12px;
      border-radius: 20px;
      background-color: var(--light-bg);
    }
    
    .post-action:hover {
      color: var(--primary-color);
      background-color: rgba(25, 118, 210, 0.1);
    }
    
    .post-action.liked {
      color: var(--danger-color);
      background-color: rgba(229, 57, 53, 0.1);
    }
    
    .post-delete {
      position: absolute;
      top: 15px;
      left: 15px;
      color: var(--danger-color);
      cursor: pointer;
      opacity: 0.7;
      transition: var(--transition);
    }
    
    .post-delete:hover {
      opacity: 1;
      transform: scale(1.2);
    }
    
    .student-detail-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }
    
    .student-detail-header {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .student-detail-title {
      color: var(--primary-color);
      font-size: 22px;
      margin: 0;
    }
    
    .student-info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding: 10px;
      background-color: var(--light-bg);
      border-radius: var(--radius);
    }
    
    .student-info-label {
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .student-info-value {
      color: var(--text-color);
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }
    
    .qr-code-container {
      margin: 20px 0;
      text-align: center;
    }
    
    .qr-code {
      margin: 0 auto;
      padding: 10px;
      background: white;
      border-radius: var(--radius);
      display: inline-block;
    }
    
    .attendance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .attendance-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: var(--light-bg);
      border-radius: var(--radius);
    }
    
    .fees-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }
    
    .fee-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: var(--light-bg);
      border-radius: var(--radius);
    }
    
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .report-table th, .report-table td {
      padding: 12px;
      text-align: right;
      border: 1px solid var(--gray-light);
    }
    
    .report-table th {
      background-color: var(--primary-color);
      color: white;
    }
    
    .report-table tr:nth-child(even) {
      background-color: var(--light-bg);
    }
    
    .report-table tr:hover {
      background-color: rgba(25, 118, 210, 0.1);
    }
    
    .report-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .report-filter select {
      flex: 1;
      min-width: 150px;
    }
    
    .trash-list {
      margin-top: 20px;
    }
    
    .trash-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 10px;
      transition: var(--transition);
    }
    
    .trash-item:hover {
      transform: translateY(-2px);
    }
    
    .trash-info {
      flex: 1;
    }
    
    .trash-actions {
      display: flex;
      gap: 10px;
    }
    
    .no-students {
      text-align: center;
      padding: 40px;
      background: var(--white);
      border-radius: 12px;
      box-shadow: var(--shadow);
    }
    
    .no-students h3 {
      color: var(--text-light);
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .report-type-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .report-type-btn {
      flex: 1;
      min-width: 200px;
    }
    
    .report-section {
      display: none;
    }
    
    .report-section.active {
      display: block;
    }
    
    .stats-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      text-align: center;
      transition: var(--transition);
    }
    
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .stat-card h3 {
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .stat-card .description {
      color: var(--text-light);
      font-size: 14px;
    }
    
    .stat-card.present {
      border-top: 4px solid var(--success-color);
    }
    
    .stat-card.absent {
      border-top: 4px solid var(--danger-color);
    }
    
    .stat-card.paid {
      border-top: 4px solid var(--success-color);
    }
    
    .stat-card.unpaid {
      border-top: 4px solid var(--danger-color);
    }
    
    .stat-card.total {
      border-top: 4px solid var(--primary-color);
    }
    
    .edit-student-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      color: var(--warning-color);
      cursor: pointer;
      opacity: 0.7;
      transition: var(--transition);
    }
    
    .edit-student-btn:hover {
      opacity: 1;
      transform: scale(1.2);
    }
    
    .file-info {
      background: var(--light-bg);
      padding: 15px;
      border-radius: var(--radius);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .file-info span {
      font-weight: bold;
      color: var(--primary-color);
    }
    
    /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
    .student-id-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 20px;
      max-width: 400px;
      margin: 20px auto;
      text-align: center;
      border: 1px solid #eee;
    }
    
    .student-id-card-header {
      background: var(--primary-color);
      color: white;
      padding: 15px;
      border-radius: 8px 8px 0 0;
      margin: -20px -20px 20px -20px;
    }
    
    .student-id-card-title {
      font-size: 18px;
      font-weight: bold;
      margin: 0;
    }
    
    .student-id-card-body {
      padding: 10px 0;
    }
    
    .student-id-card-photo {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary-color);
      margin: 0 auto 15px;
    }
    
    .student-id-card-info {
      text-align: right;
      margin-bottom: 15px;
    }
    
    .student-id-card-info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #eee;
    }
    
    .student-id-card-info-label {
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .student-id-card-footer {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    
    .share-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .share-btn {
      padding: 10px 15px;
      border-radius: 8px;
      color: white;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .share-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    
    .whatsapp {
      background-color: #25D366;
    }
    
    .telegram {
      background-color: #0088cc;
    }
    
    .download-card {
      background-color: var(--primary-color);
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‡Ø§ØªÙ */
    @media (min-width: 768px) {
      .sidebar {
        width: 300px;
        right: -300px;
      }
      
      .modal-content {
        width: 90%;
        max-width: 600px;
        min-height: auto;
        border-radius: 16px;
        margin: 30px auto;
      }
      
      .modal-footer {
        flex-direction: row;
        justify-content: flex-end;
      }
      
      .modal-footer button {
        width: auto;
      }
      
      .action-buttons {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }
    
    @media (max-width: 480px) {
      .header h1 {
        font-size: 20px;
      }
      
      .control-panel {
        grid-template-columns: 1fr;
      }
      
      .sidebar-menu a {
        padding: 12px;
        font-size: 15px;
      }
      
      .modal-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .modal-title {
        font-size: 20px;
      }
      
      .student-card {
        padding: 12px;
      }
      
      .student-name {
        font-size: 16px;
      }
      
      .student-id {
        font-size: 14px;
      }
      
      .share-buttons {
        flex-direction: column;
      }
    }
    
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--gray-light);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      z-index: 1100;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .popup-content {
      background-color: var(--white);
      border-radius: var(--radius);
      padding: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow);
      animation: popIn 0.3s ease;
    }

    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
    }

    .popup-title {
      font-size: 18px;
      font-weight: bold;
      color: var(--primary-color);
    }

    .popup-close {
      cursor: pointer;
      font-size: 24px;
      color: var(--danger-color);
    }

    .popup-body {
      margin-bottom: 20px;
    }

    .popup-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .status-select {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--gray-light);
      width: 100%;
      margin-bottom: 10px;
    }

    .status-option {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 5px;
      cursor: pointer;
      transition: var(--transition);
    }

    .status-option:hover {
      background-color: var(--light-bg);
    }

    .status-option.present {
      background-color: #e8f5e9;
      color: #2e7d32;
    }

    .status-option.absent {
      background-color: #ffebee;
      color: #c62828;
    }

    .status-option.paid {
      background-color: #e8f5e9;
      color: #2e7d32;
    }

    .status-option.unpaid {
      background-color: #fff8e1;
      color: #e65100;
    }

    .status-icon {
      margin-left: 10px;
      font-size: 18px;
    }

    .status-label {
      flex: 1;
    }

    .month-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .month-item {
      padding: 10px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--gray-light);
    }

    .month-item.selected {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-dark);
    }

    .month-item.paid {
      background-color: #e8f5e9;
      border-color: #a5d6a7;
    }

    .month-item.unpaid {
      background-color: #ffebee;
      border-color: #ef9a9a;
    }

    .day-selector {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
    }

    .day-item {
      padding: 10px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--gray-light);
    }

    .day-item.selected {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-dark);
    }

    .day-item.present {
      background-color: #e8f5e9;
      border-color: #a5d6a7;
    }

    .day-item.absent {
      background-color: #ffebee;
      border-color: #ef9a9a;
    }

    .excel-btn {
      background-color: #1d6f42;
    }

    .excel-btn:hover {
      background-color: #165834;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
    .modal-stack {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1050;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-stack .modal {
      position: absolute;
      z-index: inherit;
    }

    .modal-stack .modal:nth-child(1) {
      z-index: 1051;
    }

    .modal-stack .modal:nth-child(2) {
      z-index: 1052;
      transform: scale(0.95);
    }

    .modal-stack .modal:nth-child(3) {
      z-index: 1053;
      transform: scale(0.9);
    }

    .modal-stack .modal-content {
      min-height: auto;
      max-height: 90vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <!-- Modal Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù…Ù„ -->
  <div id="imageModal" class="modal image-modal">
    <span class="close-image" onclick="closeImageModal()">&times;</span>
    <div class="modal-content">
      <img class="image-modal-content" id="expandedImage">
    </div>
  </div>

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h2><i class="fas fa-lock"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <input type="password" id="loginPassword" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <button class="btn btn-success" onclick="checkLogin()"><i class="fas fa-sign-in-alt"></i> Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
  <div class="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </div>
  
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2 class="sidebar-title"><i class="fas fa-user-graduate"></i> Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
      <button class="btn btn-danger" onclick="toggleSidebar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <ul class="sidebar-menu">
      <li><a href="#" onclick="showAddModal()"><i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</a></li>
      <li><a href="#" onclick="showDeleteModal(null)"><i class="fas fa-user-minus"></i> Ø­Ø°Ù Ø·Ø§Ù„Ø¨</a></li>
      <li><a href="#" onclick="showAllStudents()"><i class="fas fa-users"></i> Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</a></li>
      <li><a href="#" onclick="showReports('fees')"><i class="fas fa-money-bill-wave"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</a></li>
      <li><a href="#" onclick="showReports('attendance')"><i class="fas fa-calendar-check"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±</a></li>
      <li><a href="#" onclick="showGradeModal()"><i class="fas fa-filter"></i> ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØµÙ</a></li>
      <li><a href="#" onclick="showTrash()"><i class="fas fa-trash"></i> Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª</a></li>
      <li><a href="#" onclick="exportData('json')"><i class="fas fa-file-export"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a></li>
      <li><a href="#" onclick="saveToGitHub()"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a></li>
    </ul>
  </div>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <div class="container">
    <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
    <div class="header">
      <h1><i class="fas fa-user-graduate"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
      <div class="header-actions">
        <div class="grade-select">
          <button class="btn" onclick="showGradeModal()"><i class="fas fa-filter"></i> ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØµÙ</button>
        </div>
        <button class="btn theme-toggle" id="themeToggle">
          <i class="fas fa-moon"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
        </button>
      </div>
    </div>

    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ØµÙØ­Ø© -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('students')">
        <i class="fas fa-users"></i> Ø§Ù„Ø·Ù„Ø§Ø¨
      </div>
      <div class="tab" onclick="switchTab('posts')">
        <i class="fas fa-newspaper"></i> Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
      </div>
      <div class="tab" onclick="switchTab('reports')">
        <i class="fas fa-chart-bar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
      </div>
    </div>

    <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø·Ù„Ø§Ø¨ -->
    <div id="students-tab" class="tab-content active">
      <div class="file-info">
        <div><i class="fas fa-file-alt"></i> Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentDataFile">students.json</span></div>
        <div><i class="fas fa-users"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨: <span id="totalStudentsInFile">0</span></div>
      </div>

      <div class="control-panel">
        <input type="text" id="token" placeholder="ğŸ”‘ GitHub Token">
        <input type="text" id="searchId" placeholder="ğŸ” ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨">
        <button class="btn" onclick="searchStudent()"><i class="fas fa-search"></i> Ø¨Ø­Ø«</button>
        <div class="btn-group">
          <button class="btn btn-success" onclick="showAddModal()"><i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ©</button>
          <button class="btn btn-secondary" onclick="hideAllStudents()"><i class="fas fa-eye-slash"></i> Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
          <button class="btn btn-secondary" onclick="showAllStudents()"><i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
          <button class="btn btn-warning" onclick="saveToGitHub()"><i class="fas fa-save"></i> Ø­ÙØ¸</button>
        </div>
      </div>

      <div id="studentsCount" style="background: var(--white); padding: 15px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span><i class="fas fa-users"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ÙŠÙ†: <span id="studentsCountNumber">0</span></span>
          <span><i class="fas fa-calendar-alt"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…: <span id="currentDate"></span></span>
        </div>
      </div>
      
      <div id="studentsCards"></div>
    </div>

    <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª -->
    <div id="posts-tab" class="tab-content">
      <div class="posts-container">
        <div class="posts-header">
          <h2><i class="fas fa-newspaper"></i> Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h2>
          <button class="btn btn-success" onclick="showPostModal()">
            <i class="fas fa-plus"></i> Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯
          </button>
        </div>

        <div id="postsList"></div>
      </div>
    </div>

    <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
    <div id="reports-tab" class="tab-content">
      <div class="posts-container">
        <div class="posts-header">
          <h2><i class="fas fa-chart-bar"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
        </div>

        <div class="report-type-selector">
          <button class="btn report-type-btn" onclick="showReports('fees')">
            <i class="fas fa-money-bill-wave"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
          </button>
          <button class="btn report-type-btn" onclick="showReports('attendance')">
            <i class="fas fa-calendar-check"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±
          </button>
          <button class="btn report-type-btn" onclick="showReports('stats')">
            <i class="fas fa-chart-pie"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          </button>
        </div>

        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
        <div id="statsReport" class="report-section">
          <div class="stats-cards">
            <div class="stat-card total">
              <h3><i class="fas fa-users"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
              <div class="value" id="totalStudentsCount">0</div>
              <div class="description">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
            </div>
            
            <div class="stat-card present">
              <h3><i class="fas fa-user-check"></i> Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</h3>
              <div class="value" id="todayPresentCount">0</div>
              <div class="description">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</div>
            </div>
            
            <div class="stat-card absent">
              <h3><i class="fas fa-user-times"></i> Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</h3>
              <div class="value" id="todayAbsentCount">0</div>
              <div class="description">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</div>
            </div>
            
            <div class="stat-card paid">
              <h3><i class="fas fa-check-circle"></i> Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¯Ø¯Ø©</h3>
              <div class="value" id="paidFeesCount">0</div>
              <div class="description">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ø³Ø¯Ø¯ÙˆØ§ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
            </div>
            
            <div class="stat-card unpaid">
              <h3><i class="fas fa-exclamation-circle"></i> Ù…ØµØ±ÙˆÙØ§Øª ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©</h3>
              <div class="value" id="unpaidFeesCount">0</div>
              <div class="description">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠØ³Ø¯Ø¯ÙˆØ§ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
            </div>
          </div>
        </div>

        <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
        <div id="feesReport" class="report-section">
          <div class="report-header">
            <h3><i class="fas fa-money-bill-wave"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
            <button class="btn btn-success excel-btn" onclick="exportToExcel()">
              <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
            </button>
          </div>
          
          <div class="report-filter">
            <select id="feesGradeFilter" style="flex: 1;">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
            </select>
            <select id="feesMonthFilter" style="flex: 1;">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø±</option>
            </select>
            <select id="feesStatusFilter" style="flex: 1;">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
              <option value="paid">Ù…Ø³Ø¯Ø¯Ø©</option>
              <option value="unpaid">ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©</option>
            </select>
            <button class="btn" onclick="filterFeesReport()">
              <i class="fas fa-filter"></i> ØªØµÙÙŠØ©
            </button>
          </div>
          
          <div class="table-responsive">
            <table class="report-table" id="feesReportTable">
              <thead>
                <tr>
                  <th>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„ØµÙ</th>
                  <th>Ø£ØºØ³Ø·Ø³</th>
                  <th>Ø³Ø¨ØªÙ…Ø¨Ø±</th>
                  <th>Ø£ÙƒØªÙˆØ¨Ø±</th>
                  <th>Ù†ÙˆÙÙ…Ø¨Ø±</th>
                  <th>Ø¯ÙŠØ³Ù…Ø¨Ø±</th>
                  <th>ÙŠÙ†Ø§ÙŠØ±</th>
                  <th>ÙØ¨Ø±Ø§ÙŠØ±</th>
                  <th>Ù…Ø§Ø±Ø³</th>
                  <th>Ø£Ø¨Ø±ÙŠÙ„</th>
                </tr>
              </thead>
              <tbody id="feesReportBody"></tbody>
            </table>
          </div>
        </div>

        <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± -->
        <div id="attendanceReport" class="report-section">
          <div class="report-header">
            <h3><i class="fas fa-calendar-check"></i> ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h3>
            <button class="btn btn-success excel-btn" onclick="exportAttendanceToExcel()">
              <i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
            </button>
          </div>
          
          <div class="report-filter">
            <select id="attendanceGradeFilter" style="flex: 1;">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
            </select>
            <select id="attendanceDayFilter" style="flex: 1;">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù…</option>
            </select>
            <select id="attendanceStatusFilter" style="flex: 1;">
              <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
              <option value="Ø­Ø§Ø¶Ø±">Ø­Ø§Ø¶Ø±</option>
              <option value="ØºØ§Ø¦Ø¨">ØºØ§Ø¦Ø¨</option>
            </select>
            <button class="btn" onclick="filterAttendanceReport()">
              <i class="fas fa-filter"></i> ØªØµÙÙŠØ©
            </button>
          </div>
          
          <div class="table-responsive">
            <table class="report-table" id="attendanceReportTable">
              <thead>
                <tr>
                  <th>ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„ØµÙ</th>
                  <th>Ø§Ù„Ø³Ø¨Øª</th>
                  <th>Ø§Ù„Ø£Ø­Ø¯</th>
                  <th>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</th>
                  <th>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</th>
                  <th>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</th>
                  <th>Ø§Ù„Ø®Ù…ÙŠØ³</th>
                  <th>Ø§Ù„Ø¬Ù…Ø¹Ø©</th>
                </tr>
              </thead>
              <tbody id="attendanceReportBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨ -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle"><i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="studentId"><i class="fas fa-id-card"></i> ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</label>
          <input type="text" id="studentId" placeholder="Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" disabled>
        </div>
        
        <div class="form-group">
          <label for="studentName"><i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
          <input type="text" id="studentName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">
        </div>
        
        <div class="form-group">
          <label for="studentGrade"><i class="fas fa-graduation-cap"></i> Ø§Ù„ØµÙ</label>
          <select id="studentGrade">
            <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="studentPhone"><i class="fas fa-phone"></i> Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input type="text" id="studentPhone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        </div>
        
        <div class="form-group">
          <label for="studentLevel"><i class="fas fa-star"></i> Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="studentLevel">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰</option>
            <option value="Ø¶Ø¹ÙŠÙ">Ø¶Ø¹ÙŠÙ</option>
            <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ù…Ù‚Ø¨ÙˆÙ„</option>
            <option value="Ø¬ÙŠØ¯">Ø¬ÙŠØ¯</option>
            <option value="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§">Ø¬ÙŠØ¯ Ø¬Ø¯Ø§</option>
            <option value="Ù…Ù…ØªØ§Ø²">Ù…Ù…ØªØ§Ø²</option>
          </select>
        </div>
        
        <div class="form-group">
          <label><i class="fas fa-image"></i> ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <div class="image-upload-container">
            <div class="image-preview-wrapper">
              <img id="studentImagePreview" class="image-preview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©" onclick="expandImage(this)">
              <div class="image-actions" id="imageActions">
                <button class="btn btn-small btn-danger" onclick="removeImage()">
                  <i class="fas fa-trash"></i> Ø­Ø°Ù
                </button>
                <button class="btn btn-small btn-success" onclick="document.getElementById('studentImage').click()">
                  <i class="fas fa-sync"></i> ØªØºÙŠÙŠØ±
                </button>
              </div>
            </div>
            <button class="btn upload-btn">
              <i class="fas fa-upload"></i> Ø§Ø®ØªØ± ØµÙˆØ±Ø©
              <input type="file" id="studentImage" accept="image/*" onchange="previewStudentImage()">
            </button>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
        </button>
        <button class="btn btn-success" id="saveStudentBtn">
          <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Ø­Ø°Ù Ø·Ø§Ù„Ø¨ -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-trash-alt"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      
      <div class="modal-body">
        <div style="background: #fde8e8; color: var(--danger-color); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>ØªØ­Ø°ÙŠØ±:</strong> Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!
        </div>
        
        <div id="deleteStudentInfo" style="display: none;">
          <div class="student-card" style="background: var(--light-bg); padding: 15px; border-radius: 8px;">
            <div class="student-header">
              <div>
                <div class="student-name" id="deleteStudentName"></div>
                <div class="student-id" id="deleteStudentId"></div>
              </div>
              <div class="student-grade" id="deleteStudentGrade"></div>
            </div>
          </div>
        </div>
        
        <div id="deleteStudentSelectContainer" style="margin-top: 15px;">
          <select id="deleteStudentSelect" style="width: 100%;">
            <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø­Ø°Ù</option>
          </select>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
        </button>
        <button class="btn btn-danger" onclick="confirmDelete()">
          <i class="fas fa-trash"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
  <div id="notesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <textarea id="notesContent" rows="8" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨..." 
                    style="width: 100%; border-radius: 8px; padding: 15px; border: 1px solid var(--gray-light);"></textarea>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
        </button>
        <button class="btn btn-success" onclick="saveNotes()">
          <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª -->
  <div id="postModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="postModalTitle"><i class="fas fa-plus"></i> Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</h3>
        <span class="close" onclick="closePostModal()">&times;</span>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label for="editPostTitle"><i class="fas fa-heading"></i> Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±</label>
          <input type="text" id="editPostTitle" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ±">
        </div>
        
        <div class="form-group">
          <label for="editPostContent"><i class="fas fa-align-left"></i> Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</label>
          <textarea id="editPostContent" rows="6" placeholder="Ø§ÙƒØªØ¨ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù‡Ù†Ø§..."></textarea>
        </div>
        
        <div class="form-group">
          <label><i class="fas fa-image"></i> ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <div class="image-upload-container">
            <div class="image-preview-wrapper">
              <img id="postImagePreview" class="image-preview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©" onclick="expandImage(this)">
              <div class="image-actions" id="postImageActions">
                <button class="btn btn-small btn-danger" onclick="removePostImage()">
                  <i class="fas fa-trash"></i> Ø­Ø°Ù
                </button>
                <button class="btn btn-small btn-success" onclick="document.getElementById('postImageInput').click()">
                  <i class="fas fa-sync"></i> ØªØºÙŠÙŠØ±
                </button>
              </div>
            </div>
            <button class="btn upload-btn">
              <i class="fas fa-upload"></i> Ø§Ø®ØªØ± ØµÙˆØ±Ø©
              <input type="file" id="postImageInput" accept="image/*" onchange="previewPostImage()">
            </button>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn" onclick="closePostModal()">
          <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
        </button>
        <button class="btn btn-success" id="savePostBtn">
          <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
        </button>
      </div>
    </div>
  </div>

  <!-- Modal ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ -->
  <div id="studentDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-user"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-body" id="studentDetailContent"></div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª -->
  <div id="trashModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title"><i class="fas fa-trash"></i> Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª</h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div id="trashContent"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">
          <i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚
        </button>
      </div>
    </div>
  </div>

  <!-- Popup for Attendance -->
  <div id="attendancePopup" class="popup-overlay" style="display: none;">
    <div class="popup-content">
      <div class="popup-header">
        <h3 class="popup-title"><i class="fas fa-calendar-check"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h3>
        <span class="popup-close" onclick="closeAttendancePopup()">&times;</span>
      </div>
      <div class="popup-body" id="attendancePopupBody">
        <!-- Content will be added dynamically -->
      </div>
      <div class="popup-footer">
        <button class="btn" onclick="closeAttendancePopup()">
          <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
        </button>
        <button class="btn btn-success" onclick="saveAttendance()">
          <i class="fas fa-save"></i> Ø­ÙØ¸
        </button>
      </div>
    </div>
  </div>

  <!-- Popup for Fees -->
  <div id="feesPopup" class="popup-overlay" style="display: none;">
    <div class="popup-content">
      <div class="popup-header">
        <h3 class="popup-title"><i class="fas fa-money-bill-wave"></i> ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
        <span class="popup-close" onclick="closeFeesPopup()">&times;</span>
      </div>
      <div class="popup-body" id="feesPopupBody">
        <!-- Content will be added dynamically -->
      </div>
      <div class="popup-footer">
        <button class="btn" onclick="closeFeesPopup()">
          <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
        </button>
        <button class="btn btn-success" onclick="saveFees()">
          <i class="fas fa-save"></i> Ø­ÙØ¸
        </button>
      </div>
    </div>
  </div>

<script>
// Initialize jsPDF
const { jsPDF } = window.jspdf;

let students = {};
let posts = {};
let trash = {};
let sha = "";
const owner = "Devolepor";
const repo = "app";
const path = "students.json";
const postsPath = "posts.json";
const trashPath = "trash.json";
const branch = "main";
const PASSWORD = "010135685900122327731001150929598";
const MAX_FILE_SIZE = 500000; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (Ø­ÙˆØ§Ù„ÙŠ 50KB Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ÙÙŠØ±)
let currentStudentId = null;
let currentPostId = null;
let deleteStudentId = null;
let isLoading = false;
let originalButtonText = "";
let postImageFile = null;
let studentImageFile = null;
let allStudentsData = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
let currentDataFile = "students.json"; // Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ®Ø²ÙŠÙ†
let currentPopupStudentId = null;

const grades = [
  "Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",
  "Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ"
];

const levels = ["Ø¶Ø¹ÙŠÙ", "Ù…Ù‚Ø¨ÙˆÙ„", "Ø¬ÙŠØ¯", "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§", "Ù…Ù…ØªØ§Ø²"];

// Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ£Ø´Ù‡Ø± Ø§Ù„Ø³Ù†Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
const weekDays = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©"];
const months = ["Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±", "ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„"];

// Check for saved theme preference
if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark-mode");
  document.getElementById("themeToggle").innerHTML = '<i class="fas fa-sun"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ';
}

if (localStorage.getItem("gh_token")) {
  document.getElementById("token").value = localStorage.getItem("gh_token");
}

// Theme toggle functionality
document.getElementById("themeToggle").addEventListener("click", function() {
  document.body.classList.toggle("dark-mode");
  if (document.body.classList.contains("dark-mode")) {
    localStorage.setItem("theme", "dark");
    this.innerHTML = '<i class="fas fa-sun"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ';
  } else {
    localStorage.setItem("theme", "light");
    this.innerHTML = '<i class="fas fa-moon"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ';
  }
});

// Toggle sidebar
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

// Ø¯Ø§Ù„Ø© Ù„ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø·Ø§Ù„Ø¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…ÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…
function generateStudentId() {
  let id;
  do {
    id = Math.floor(100000 + Math.random() * 900000).toString();
  } while (allStudentsData[id]); // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø£ÙŠ Ù…Ù„Ù
  return id;
}

function checkLogin() {
  const pass = document.getElementById("loginPassword").value;
  if (pass === PASSWORD) {
    localStorage.setItem("isLoggedIn", "true");
    document.getElementById("loginScreen").style.display = "none";
    loadAllStudentsData();
    loadPosts();
    loadTrash();
    
    // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙˆÙ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    fillGradeSelects();
    
    // Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
    const today = new Date();
    document.getElementById('currentDate').textContent = today.toLocaleDateString('ar-EG');
  } else {
    Swal.fire({
      title: 'Ø®Ø·Ø£!',
      text: 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!',
      icon: 'error',
      confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
    });
  }
}

// ØªØ¹Ø¨Ø¦Ø© Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ØµÙÙˆÙ ÙÙŠ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
function fillGradeSelects() {
  const gradeSelects = [
    document.getElementById('studentGrade'),
    document.getElementById('gradeSelect'),
    document.getElementById('feesGradeFilter'),
    document.getElementById('attendanceGradeFilter')
  ];
  
  gradeSelects.forEach(select => {
    if (select) {
      select.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>';
      grades.forEach(grade => {
        select.innerHTML += `<option value="${grade}">${grade}</option>`;
      });
    }
  });
  
  // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´Ù‡Ø± Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
  const monthSelect = document.getElementById('feesMonthFilter');
  if (monthSelect) {
    monthSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø±</option>';
    months.forEach(month => {
      monthSelect.innerHTML += `<option value="${month}">${month}</option>`;
    });
  }
  
  // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙŠØ§Ù… Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±
  const daySelect = document.getElementById('attendanceDayFilter');
  if (daySelect) {
    daySelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù…</option>';
    weekDays.forEach(day => {
      daySelect.innerHTML += `<option value="${day}">${day}</option>`;
    });
  }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
async function loadAllStudentsData() {
  try {
    showLoading(true);
    allStudentsData = {};
    students = {};
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø£ÙˆÙ„Ø§Ù‹
    await loadStudentsFile("students.json");
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„ÙØ§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    let fileNumber = 1;
    let moreFilesExist = true;
    
    while (moreFilesExist) {
      try {
        const fileName = `students_${fileNumber}.json`;
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${fileName}`);
        
        if (res.ok) {
          await loadStudentsFile(fileName);
          fileNumber++;
        } else {
          moreFilesExist = false;
        }
      } catch (error) {
        moreFilesExist = false;
      }
    }
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø¬Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    determineCurrentFile();
    renderStudentCards();
    updateStats();
  } catch (error) {
    console.error("Error loading students data:", error);
    showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨");
  } finally {
    showLoading(false);
  }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø·Ù„Ø§Ø¨ Ù…Ø¹ÙŠÙ†
async function loadStudentsFile(fileName) {
  try {
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${fileName}`);
    if (!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø·Ù„Ø§Ø¨');
    
    const data = await res.json();
    const decodedContent = decodeURIComponent(escape(atob(data.content)));
    const fileData = JSON.parse(decodedContent);
    
    // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    Object.assign(allStudentsData, fileData);
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    if (fileName === currentDataFile) {
      students = fileData;
      sha = data.sha;
    }
    
    return true;
  } catch (error) {
    console.error(`Error loading file ${fileName}:`, error);
    return false;
  }
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ®Ø²ÙŠÙ†
function determineCurrentFile() {
  // ØªØ­Ù‚Ù‚ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
  const mainFileSize = calculateFileSize(allStudentsData);
  if (mainFileSize < MAX_FILE_SIZE) {
    currentDataFile = "students.json";
    students = allStudentsData;
    document.getElementById('currentDataFile').textContent = "students.json";
    document.getElementById('totalStudentsInFile').textContent = Object.keys(students).length;
    return;
  }
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ØŒ Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£Ø­Ø¯Ø« Ù…Ù„Ù Ø¥Ø¶Ø§ÙÙŠ
  let fileNumber = 1;
  let latestFile = null;
  let latestFileSize = 0;
  
  while (true) {
    const fileName = `students_${fileNumber}.json`;
    const fileData = {};
    
    // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù…Ù† allStudentsData
    for (const [id, student] of Object.entries(allStudentsData)) {
      if (student._file === fileName) {
        fileData[id] = student;
      }
    }
    
    const size = calculateFileSize(fileData);
    if (size > 0 && size < MAX_FILE_SIZE) {
      latestFile = fileName;
      latestFileSize = size;
    } else if (size === 0) {
      break; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª
    }
    
    fileNumber++;
  }
  
  if (latestFile) {
    currentDataFile = latestFile;
    students = {};
    for (const [id, student] of Object.entries(allStudentsData)) {
      if (student._file === latestFile) {
        students[id] = student;
      }
    }
    document.getElementById('currentDataFile').textContent = latestFile;
    document.getElementById('totalStudentsInFile').textContent = Object.keys(students).length;
  } else {
    // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ù…Ù„ÙØ§Ù‹ Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹ØŒ Ø£Ù†Ø´Ø¦ Ù…Ù„ÙØ§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹
    createNewDataFile();
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ù…Ù„Ù
function calculateFileSize(data) {
  try {
    const jsonString = JSON.stringify(data);
    return new Blob([jsonString]).size;
  } catch (error) {
    console.error("Error calculating file size:", error);
    return 0;
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯
function createNewDataFile() {
  // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
  let fileNumber = 1;
  while (true) {
    const fileName = `students_${fileNumber}.json`;
    let fileExists = false;
    
    for (const student of Object.values(allStudentsData)) {
      if (student._file === fileName) {
        fileExists = true;
        break;
      }
    }
    
    if (!fileExists) {
      currentDataFile = fileName;
      students = {};
      document.getElementById('currentDataFile').textContent = fileName;
      document.getElementById('totalStudentsInFile').textContent = 0;
      break;
    }
    
    fileNumber++;
  }
}

async function loadPosts() {
  try {
    showLoading(true);
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`);
    if (!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª');
    
    let data = await res.json();
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    posts = JSON.parse(decodedContent);
    renderPosts();
  } catch (error) {
    console.error("Error loading posts:", error);
    posts = {};
    renderPosts();
    Swal.fire({
      title: 'ØªØ­Ø°ÙŠØ±',
      text: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø­Ø§Ù„ÙŠØ©ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸',
      icon: 'warning'
    });
  } finally {
    showLoading(false);
  }
}

async function loadTrash() {
  try {
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${trashPath}`);
    if (!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª');
    
    let data = await res.json();
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    trash = JSON.parse(decodedContent);
  } catch (error) {
    console.error("Error loading trash:", error);
    trash = {};
  }
}

function renderStudentCards(filterGrade = null) {
  let html = '';
  let studentCount = 0;
  
  for (let id in students) {
    let s = students[id];
    if (filterGrade && s.main.trim() !== filterGrade.trim()) continue;

    studentCount++;
    
    // ØªØ­Ø¯ÙŠØ¯ ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶
    let levelClass = '';
    if (s.info === "Ø¶Ø¹ÙŠÙ") levelClass = "level-weak";
    else if (s.info === "Ù…Ù‚Ø¨ÙˆÙ„") levelClass = "level-acceptable";
    else if (s.info === "Ø¬ÙŠØ¯") levelClass = "level-good";
    else if (s.info === "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§") levelClass = "level-very-good";
    else if (s.info === "Ù…Ù…ØªØ§Ø²") levelClass = "level-excellent";
    
    // Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    let imageThumb = '';
    if (s.image) {
      imageThumb = `<img src="${s.image}" class="student-image-thumb" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨">`;
    }
    
    html += `
      <div class="student-card" id="student-card-${id}">
        ${imageThumb}
        <i class="fas fa-edit edit-student-btn" onclick="showEditModal('${id}')"></i>
        <div class="student-header" onclick="showStudentDetails('${id}')">
          <div>
            <div class="student-name">${s.name}</div>
            <div class="student-id">ÙƒÙˆØ¯: ${id}</div>
          </div>
          <div>
            <div class="student-grade">${s.main}</div>
            ${s.info ? `<span class="student-level ${levelClass}">${s.info}</span>` : ''}
          </div>
        </div>
      </div>
    `;
  }
  
  document.getElementById('studentsCards').innerHTML = studentCount > 0 ? html : `
    <div class="no-students">
      <h3><i class="fas fa-info-circle"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
    </div>
  `;
  
  document.getElementById('studentsCountNumber').textContent = studentCount;
  updateStats();
}

function hideAllStudents() {
  document.getElementById('studentsCards').innerHTML = `
    <div class="no-students">
      <h3><i class="fas fa-eye-slash"></i> ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
      <button class="btn btn-success" onclick="showAllStudents()">
        <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨
      </button>
    </div>
  `;
}

function showAllStudents() {
  renderStudentCards();
}

function showStudentDetails(id) {
  const student = students[id];
  
  // Generate QR code if phone number exists
  let qrCodeHtml = '';
  if (student.phone) {
    qrCodeHtml = `
      <div class="qr-code-container">
        <div id="qr-code-${id}" class="qr-code"></div>
        <p>QR Code Ù„Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</p>
      </div>
    `;
  }
  
  // Generate image if exists
  let imageHtml = '';
  if (student.image) {
    imageHtml = `
      <div class="image-upload">
        <img src="${student.image}" class="image-preview" style="display: block; max-width: 200px;" onclick="expandImage(this)">
      </div>
    `;
  }
  
  // Generate student ID card
  let studentCardHtml = generateStudentIdCard(id, student);
  
  // Generate notes section
  let notesHtml = `
    <div class="notes-container">
      <div class="notes-header">
        <h3><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
        <button class="btn btn-small" onclick="showNotesModal('${id}')">
          <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
        </button>
      </div>
      <div class="notes-content" id="notes-display-${id}">
        ${student.notes || '<p style="color: var(--text-light); text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>'}
      </div>
    </div>
  `;
  
  let html = `
    <div class="student-detail-card">
      <div class="student-detail-header">
        <h2 class="student-detail-title"><i class="fas fa-user"></i> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
      </div>
      
      <div class="student-detail-body">
        <div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-id-card"></i> ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨:</span>
            <span class="student-info-value">${id}</span>
          </div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù…:</span>
            <span class="student-info-value">${student.name}</span>
          </div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-graduation-cap"></i> Ø§Ù„ØµÙ:</span>
            <span class="student-info-value">${student.main}</span>
          </div>
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-star"></i> Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</span>
            <span class="student-info-value">${student.info || '-'}</span>
          </div>
          ${student.phone ? `
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-phone"></i> Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</span>
            <span class="student-info-value">${student.phone}</span>
          </div>
          ` : ''}
          ${student.group ? `
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-users"></i> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</span>
            <span class="student-info-value">${student.group}</span>
          </div>
          ` : ''}
          ${student._file ? `
          <div class="student-info-item">
            <span class="student-info-label"><i class="fas fa-file-alt"></i> Ù…Ù„Ù Ø§Ù„ØªØ®Ø²ÙŠÙ†:</span>
            <span class="student-info-value">${student._file}</span>
          </div>
          ` : ''}
        </div>
        
        ${imageHtml}
        ${qrCodeHtml}
      </div>
      
      <div class="action-buttons">
        <button class="btn" onclick="showAttendancePopup('${id}')">
          <i class="fas fa-calendar-check"></i> Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
        </button>
        <button class="btn" onclick="showFeesPopup('${id}')">
          <i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
        </button>
        <button class="btn" onclick="showNotesModal('${id}')">
          <i class="fas fa-sticky-note"></i> Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
        </button>
        <button class="btn" onclick="scanQRCode('${id}')">
          <i class="fas fa-qrcode"></i> Ù…Ø³Ø­ QR Code
        </button>
        ${student.phone ? `
        <button class="btn btn-success" onclick="generateQRCode('${id}', '${student.phone}')">
          <i class="fas fa-qrcode"></i> Ø¥Ù†Ø´Ø§Ø¡ QR Code
        </button>
        ` : ''}
        <button class="btn btn-warning" onclick="showEditModal('${id}')">
          <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
        <button class="btn btn-secondary" onclick="shareStudent('${id}')">
          <i class="fas fa-share"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
        <button class="btn btn-primary" onclick="downloadStudentCard('${id}')">
          <i class="fas fa-download"></i> Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        </button>
      </div>
      
      ${notesHtml}
      
      <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ -->
      ${studentCardHtml}
    </div>
  `;
  
  document.getElementById('studentDetailContent').innerHTML = html;
  
  // Initialize QR code if phone exists
  if (student.phone) {
    new QRCode(document.getElementById(`qr-code-${id}`), {
      text: JSON.stringify({
        id: id,
        phone: student.phone,
        action: 'attendance',
        group: student.group || 'default'
      }),
      width: 150,
      height: 150,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });
    
    // QR code for the card
    const cardQrCodeDiv = document.getElementById(`qr-code-card-${id}`);
    if (cardQrCodeDiv) {
      new QRCode(cardQrCodeDiv, {
        text: JSON.stringify({
          id: id,
          phone: student.phone,
          action: 'attendance',
          group: student.group || 'default'
        }),
        width: 100,
        height: 100,
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    }
  }
  
  document.getElementById('studentDetailModal').style.display = 'block';
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
function generateStudentIdCard(id, student) {
  let photoHtml = student.image ? 
    `<img src="${student.image}" class="student-id-card-photo" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨">` : 
    `<div class="student-id-card-photo" style="background: #eee; display: flex; align-items: center; justify-content: center;">
      <i class="fas fa-user" style="font-size: 40px; color: #999;"></i>
    </div>`;
  
  return `
    <div class="student-id-card" id="student-card-${id}">
      <div class="student-id-card-header">
        <h3 class="student-id-card-title">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
      </div>
      <div class="student-id-card-body">
        ${photoHtml}
        <div class="student-id-card-info">
          <div class="student-id-card-info-item">
            <span class="student-id-card-info-label">Ø§Ù„Ø§Ø³Ù…:</span>
            <span>${student.name}</span>
          </div>
          <div class="student-id-card-info-item">
            <span class="student-id-card-info-label">Ø§Ù„ÙƒÙˆØ¯:</span>
            <span>${id}</span>
          </div>
          <div class="student-id-card-info-item">
            <span class="student-id-card-info-label">Ø§Ù„ØµÙ:</span>
            <span>${student.main}</span>
          </div>
          ${student.phone ? `
          <div class="student-id-card-info-item">
            <span class="student-id-card-info-label">Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±:</span>
            <span>${student.phone}</span>
          </div>
          ` : ''}
          ${student.group ? `
          <div class="student-id-card-info-item">
            <span class="student-id-card-info-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</span>
            <span>${student.group}</span>
          </div>
          ` : ''}
        </div>
        ${student.phone ? `
        <div class="qr-code-container">
          <div id="qr-code-card-${id}" class="qr-code"></div>
          <p>QR Code Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ±</p>
        </div>
        ` : ''}
      </div>
      <div class="student-id-card-footer">
        <div class="share-buttons">
          <a href="#" class="share-btn whatsapp" onclick="shareStudentViaWhatsapp('${id}')">
            <i class="fab fa-whatsapp"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
          </a>
          <a href="#" class="share-btn telegram" onclick="shareStudentViaTelegram('${id}')">
            <i class="fab fa-telegram-plane"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± Ù…Ø§Ø³Ù†Ø¬Ø±
          </a>
          <a href="#" class="share-btn download-card" onclick="downloadStudentCard('${id}')">
            <i class="fas fa-download"></i> Ø­ÙØ¸ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
          </a>
        </div>
      </div>
    </div>
  `;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ QR Code
function scanQRCode(studentId = null) {
  Swal.fire({
    title: 'Ù…Ø³Ø­ QR Code',
    html: `
      <div style="text-align:center;">
        <p>ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù…Ø³Ø­ QR Code</p>
        <video id="qr-scanner" style="width:100%; max-width:400px; margin:10px auto; background:#000;"></video>
        <canvas id="qr-canvas" style="display:none;"></canvas>
        <p>Ø£Ùˆ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠØ¯ÙˆÙŠØ§Ù‹:</p>
        <input type="text" id="manualStudentId" class="swal2-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨" value="${studentId || ''}">
      </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­',
    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
    didOpen: () => {
      const videoElement = document.getElementById('qr-scanner');
      const canvasElement = document.getElementById('qr-canvas');
      const canvas = canvasElement.getContext('2d');
      
      // Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(function(stream) {
          videoElement.srcObject = stream;
          videoElement.play();
          
          // Ø¨Ø¯Ø¡ Ù…Ø³Ø­ QR Code (Ù‡Ù†Ø§ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ù…ÙƒØªØ¨Ø© Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±)
          startQRScan(videoElement, canvasElement, canvas);
        })
        .catch(function(err) {
          console.error("Ø®Ø·Ø£ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ", err);
          Swal.fire('Ø®Ø·Ø£', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err.message, 'error');
          document.getElementById('manualStudentId').focus();
        });
    },
    willClose: () => {
      const videoElement = document.getElementById('qr-scanner');
      if (videoElement.srcObject) {
        videoElement.srcObject.getTracks().forEach(track => track.stop());
      }
    }
  });
}


// Ø¯Ø§Ù„Ø© Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø³Ø­ QR Code
function mockQRScan() {
  // Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©
  const studentIds = Object.keys(students);
  if (studentIds.length === 0) {
    Swal.fire('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…', 'warning');
    return;
  }
  
  const randomId = studentIds[Math.floor(Math.random() * studentIds.length)];
  processQRCodeScan(randomId);
  Swal.close();
}

// Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø³Ø­ QR Code
function processQRCodeScan(studentId) {
  if (!students[studentId]) {
    Swal.fire('Ø®Ø·Ø£', 'ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
    return;
  }

  const student = students[studentId];
  const today = new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
  const currentDate = new Date().toLocaleDateString('ar-EG');
  
  // ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ø§Ù„Ø¨
  if (!student.attendance) {
    student.attendance = {};
  }
  student.attendance[today] = 'Ø­Ø§Ø¶Ø±';
  
  // ØªØ³Ø¬ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¶ÙˆØ±
  if (!student.attendanceDates) {
    student.attendanceDates = [];
  }
  if (!student.attendanceDates.includes(currentDate)) {
    student.attendanceDates.push(currentDate);
  }
  
  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø®Ø§ØµÙŠØ© group)
  const group = student.group || 'default';
  
  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ØºØ§Ø¦Ø¨ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  let absentStudents = [];
  for (const [id, s] of Object.entries(students)) {
    if (id !== studentId && s.group === group && (!s.attendance || s.attendance[today] !== 'Ø­Ø§Ø¶Ø±')) {
      if (!s.attendance) {
        s.attendance = {};
      }
      s.attendance[today] = 'ØºØ§Ø¦Ø¨';
      
      // ØªØ³Ø¬ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØºÙŠØ§Ø¨
      if (!s.absenceDates) {
        s.absenceDates = [];
      }
      if (!s.absenceDates.includes(currentDate)) {
        s.absenceDates.push(currentDate);
      }
      
      absentStudents.push(s.name);
    }
  }
  
  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
  if (student.phone) {
    sendAttendanceSMS(student.phone, student.name, today, 'Ø­Ø§Ø¶Ø±');
  }
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
  let message = `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ø§Ù„Ø¨ ${student.name} (${studentId})`;
  if (absentStudents.length > 0) {
    message += `<br><br>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ØªØ§Ù„ÙŠÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (${group}):<br>`;
    message += absentStudents.join('<br>');
  }
  
  Swal.fire({
    title: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±',
    html: message,
    icon: 'success'
  });
  
  // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  saveToGitHub();
  updateStats();
  renderStudentCards();
}

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© SMS (Ù…Ø­Ø§ÙƒØ§Ø©)
function sendAttendanceSMS(phone, studentName, day, status) {
  // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© Ù…Ø«Ù„ Twilio Ø£Ùˆ Ø£ÙŠ Ù…Ø²ÙˆØ¯ SMS
  console.log(`Ø¥Ø±Ø³Ø§Ù„ SMS Ø¥Ù„Ù‰ ${phone}:`);
  console.log(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${status} Ù„Ù„Ø·Ø§Ù„Ø¨ ${studentName} ÙŠÙˆÙ… ${day}`);
  
  // Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨
  const whatsappLink = `https://wa.me/${phone}?text=ØªÙ…%20ØªØ³Ø¬ÙŠÙ„%20${encodeURIComponent(status)}%20Ù„Ù„Ø·Ø§Ù„Ø¨%20${encodeURIComponent(studentName)}%20ÙŠÙˆÙ…%20${encodeURIComponent(day)}`;
  
  // ÙŠÙ…ÙƒÙ† ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (ÙÙŠ Ø¨ÙŠØ¦Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©)
  // window.open(whatsappLink, '_blank');
}

// Ù…Ø´Ø§Ø±ÙƒØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
function shareStudentViaWhatsapp(id) {
  const student = students[id];
  let shareText = `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:\n\n`;
  shareText += `Ø§Ù„Ø§Ø³Ù…: ${student.name}\n`;
  shareText += `Ø§Ù„ÙƒÙˆØ¯: ${id}\n`;
  shareText += `Ø§Ù„ØµÙ: ${student.main}\n`;
  if (student.phone) shareText += `Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${student.phone}\n`;
  if (student.group) shareText += `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${student.group}\n`;
  if (student.info) shareText += `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${student.info}\n`;
  
  const encodedText = encodeURIComponent(shareText);
  window.open(`https://wa.me/?text=${encodedText}`, '_blank');
}

// Ù…Ø´Ø§Ø±ÙƒØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ø¨Ø± Ù…Ø§Ø³Ù†Ø¬Ø±
function shareStudentViaTelegram(id) {
  const student = students[id];
  let shareText = `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:\n\n`;
  shareText += `Ø§Ù„Ø§Ø³Ù…: ${student.name}\n`;
  shareText += `Ø§Ù„ÙƒÙˆØ¯: ${id}\n`;
  shareText += `Ø§Ù„ØµÙ: ${student.main}\n`;
  if (student.phone) shareText += `Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${student.phone}\n`;
  if (student.group) shareText += `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${student.group}\n`;
  if (student.info) shareText += `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${student.info}\n`;
  
  const encodedText = encodeURIComponent(shareText);
  window.open(`https://t.me/share/url?url=&text=${encodedText}`, '_blank');
}

// Ù…Ø´Ø§Ø±ÙƒØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
function shareStudent(id) {
  const student = students[id];
  
  let shareText = `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:\n\n`;
  shareText += `Ø§Ù„Ø§Ø³Ù…: ${student.name}\n`;
  shareText += `Ø§Ù„ÙƒÙˆØ¯: ${id}\n`;
  shareText += `Ø§Ù„ØµÙ: ${student.main}\n`;
  if (student.phone) shareText += `Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±: ${student.phone}\n`;
  if (student.group) shareText += `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${student.group}\n`;
  if (student.info) shareText += `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${student.info}\n`;
  
  Swal.fire({
    title: 'Ù…Ø´Ø§Ø±ÙƒØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨',
    html: `
      <div style="text-align: right;">
        <p>Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:</p>
        <div class="share-buttons">
          <a href="https://wa.me/?text=${encodeURIComponent(shareText)}" 
             target="_blank" class="share-btn whatsapp">
            <i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨
          </a>
          <a href="https://t.me/share/url?url=&text=${encodeURIComponent(shareText)}" 
             target="_blank" class="share-btn telegram">
            <i class="fab fa-telegram-plane"></i> Ù…Ø§Ø³Ù†Ø¬Ø±
          </a>
        </div>
      </div>
    `,
    showConfirmButton: false
  });
}

// ØªØ­Ù…ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙƒØµÙˆØ±Ø©
function downloadStudentCard(id) {
  const element = document.getElementById(`student-card-${id}`);
  if (!element) {
    showError('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨');
    return;
  }
  
  showLoading(true);
  
  html2canvas(element, {
    scale: 2,
    logging: false,
    useCORS: true,
    allowTaint: true
  }).then(canvas => {
    const link = document.createElement('a');
    link.download = `Ø¨Ø·Ø§Ù‚Ø©_Ø§Ù„Ø·Ø§Ù„Ø¨_${id}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    showLoading(false);
  }).catch(err => {
    showLoading(false);
    showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©: ' + err.message);
  });
}

// ÙˆØ¸Ø§Ø¦Ù Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
function showAttendancePopup(id) {
  currentPopupStudentId = id;
  const student = students[id];
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
  let html = `
    <h4 style="margin-bottom: 15px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ù„Ù„Ø·Ø§Ù„Ø¨: ${student.name}</h4>
    <p style="margin-bottom: 15px;">Ø§Ø®ØªØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙƒÙ„ ÙŠÙˆÙ…:</p>
    
    <div class="day-selector">
  `;
  
  // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù…
  weekDays.forEach(day => {
    const status = student.attendance?.[day] || '-';
    html += `
      <div class="day-item ${status === 'Ø­Ø§Ø¶Ø±' ? 'present' : ''} ${status === 'ØºØ§Ø¦Ø¨' ? 'absent' : ''}" 
           onclick="selectDayStatus('${day}', this)">
        <div>${day}</div>
        <div>
          ${status === 'Ø­Ø§Ø¶Ø±' ? '<i class="fas fa-check-circle"></i> Ø­Ø§Ø¶Ø±' : ''}
          ${status === 'ØºØ§Ø¦Ø¨' ? '<i class="fas fa-times-circle"></i> ØºØ§Ø¦Ø¨' : ''}
          ${status === '-' ? '<i class="fas fa-minus-circle"></i> ØºÙŠØ± Ù…Ø­Ø¯Ø¯' : ''}
        </div>
      </div>
    `;
  });
  
  html += `</div>`;
  
  document.getElementById('attendancePopupBody').innerHTML = html;
  document.getElementById('attendancePopup').style.display = 'flex';
}

function selectDayStatus(day, element) {
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
  document.querySelectorAll('.day-item').forEach(item => {
    item.classList.remove('selected');
  });
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø±
  element.classList.add('selected');
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ù…ÙƒÙ†Ø©
  const statuses = ['Ø­Ø§Ø¶Ø±', 'ØºØ§Ø¦Ø¨', '-'];
  let currentIndex = 0;
  
  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  if (element.classList.contains('present')) {
    currentIndex = 0;
  } else if (element.classList.contains('absent')) {
    currentIndex = 1;
  } else {
    currentIndex = 2;
  }
  
  // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
  const nextIndex = (currentIndex + 1) % statuses.length;
  const nextStatus = statuses[nextIndex];
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¸Ù‡Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  element.classList.remove('present', 'absent');
  element.innerHTML = `
    <div>${day}</div>
    <div>
      ${nextStatus === 'Ø­Ø§Ø¶Ø±' ? '<i class="fas fa-check-circle"></i> Ø­Ø§Ø¶Ø±' : ''}
      ${nextStatus === 'ØºØ§Ø¦Ø¨' ? '<i class="fas fa-times-circle"></i> ØºØ§Ø¦Ø¨' : ''}
      ${nextStatus === '-' ? '<i class="fas fa-minus-circle"></i> ØºÙŠØ± Ù…Ø­Ø¯Ø¯' : ''}
    </div>
  `;
  
  if (nextStatus === 'Ø­Ø§Ø¶Ø±') {
    element.classList.add('present');
  } else if (nextStatus === 'ØºØ§Ø¦Ø¨') {
    element.classList.add('absent');
  }
  
  // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ø³Ù…Ø© Ù…Ø®ØµØµØ©
  element.dataset.status = nextStatus;
}

function saveAttendance() {
  if (!currentPopupStudentId) return;
  
  // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
  const attendanceData = {};
  const currentDate = new Date().toLocaleDateString('ar-EG');
  
  document.querySelectorAll('.day-item').forEach(item => {
    const day = item.querySelector('div:first-child').textContent;
    const status = item.dataset.status || item.classList.contains('present') ? 'Ø­Ø§Ø¶Ø±' : 
                  item.classList.contains('absent') ? 'ØºØ§Ø¦Ø¨' : '-';
    attendanceData[day] = status;
    
    // ØªØ³Ø¬ÙŠÙ„ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¶ÙˆØ±/Ø§Ù„ØºÙŠØ§Ø¨
    if (status === 'Ø­Ø§Ø¶Ø±') {
      if (!students[currentPopupStudentId].attendanceDates) {
        students[currentPopupStudentId].attendanceDates = [];
      }
      if (!students[currentPopupStudentId].attendanceDates.includes(currentDate)) {
        students[currentPopupStudentId].attendanceDates.push(currentDate);
      }
    } else if (status === 'ØºØ§Ø¦Ø¨') {
      if (!students[currentPopupStudentId].absenceDates) {
        students[currentPopupStudentId].absenceDates = [];
      }
      if (!students[currentPopupStudentId].absenceDates.includes(currentDate)) {
        students[currentPopupStudentId].absenceDates.push(currentDate);
      }
    }
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
  students[currentPopupStudentId].attendance = attendanceData;
  allStudentsData[currentPopupStudentId].attendance = attendanceData;
  
  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
  closeAttendancePopup();
  
  // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
  showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  updateStats();
}

function closeAttendancePopup() {
  document.getElementById('attendancePopup').style.display = 'none';
  currentPopupStudentId = null;
}

function showFeesPopup(id) {
  currentPopupStudentId = id;
  const student = students[id];
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
  let html = `
    <h4 style="margin-bottom: 15px;">ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù„Ù„Ø·Ø§Ù„Ø¨: ${student.name}</h4>
    <p style="margin-bottom: 15px;">Ø­Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø³Ø¯Ø¯Ø©:</p>
    
    <div class="month-selector">
  `;
  
  // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø´Ù‡Ø±
  months.forEach(month => {
    const isPaid = student.fees?.[month] || false;
    html += `
      <div class="month-item ${isPaid ? 'paid' : 'unpaid'}" 
           onclick="toggleMonthPayment('${month}', this)">
        ${month}
        ${isPaid ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>'}
      </div>
    `;
  });
  
  html += `</div>`;
  
  document.getElementById('feesPopupBody').innerHTML = html;
  document.getElementById('feesPopup').style.display = 'flex';
}

function toggleMonthPayment(month, element) {
  // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
  const isPaid = element.classList.contains('paid');
  
  if (isPaid) {
    element.classList.remove('paid');
    element.classList.add('unpaid');
    element.innerHTML = `${month} <i class="fas fa-times"></i>`;
  } else {
    element.classList.remove('unpaid');
    element.classList.add('paid');
    element.innerHTML = `${month} <i class="fas fa-check"></i>`;
  }
}

function saveFees() {
  if (!currentPopupStudentId) return;
  
  // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
  const feesData = {};
  document.querySelectorAll('.month-item').forEach(item => {
    const month = item.textContent.replace('<i class="fas fa-check"></i>', '').replace('<i class="fas fa-times"></i>', '').trim();
    const isPaid = item.classList.contains('paid');
    feesData[month] = isPaid;
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
  students[currentPopupStudentId].fees = feesData;
  allStudentsData[currentPopupStudentId].fees = feesData;
  
  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
  closeFeesPopup();
  
  // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
  showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­');
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  updateStats();
}

function closeFeesPopup() {
  document.getElementById('feesPopup').style.display = 'none';
  currentPopupStudentId = null;
}

function showTrash() {
  let html = `
    <div class="trash-list">
      <h3><i class="fas fa-trash"></i> Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª</h3>
      <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ†: ${Object.keys(trash).length}</p>
  `;

  if (Object.keys(trash).length === 0) {
    html += `
      <div class="no-students">
        <h3><i class="fas fa-trash-restore"></i> Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª ÙØ§Ø±ØºØ©</h3>
      </div>
    `;
  } else {
    for (let id in trash) {
      const student = trash[id];
      html += `
        <div class="trash-item">
          <div class="trash-info">
            <div><strong>${student.name}</strong></div>
            <div>ÙƒÙˆØ¯: ${id} | Ø§Ù„ØµÙ: ${student.main}</div>
            <div><small>ØªÙ… Ø§Ù„Ø­Ø°Ù ÙÙŠ: ${student.deletedAt || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</small></div>
          </div>
          <div class="trash-actions">
            <button class="btn btn-success btn-small" onclick="restoreStudent('${id}')">
              <i class="fas fa-trash-restore"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø©
            </button>
            <button class="btn btn-danger btn-small" onclick="permanentDelete('${id}')">
              <i class="fas fa-trash-alt"></i> Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
            </button>
          </div>
        </div>
      `;
    }
  }

  html += `</div>`;
  document.getElementById('trashContent').innerHTML = html;
  document.getElementById('trashModal').style.display = 'block';
  toggleSidebar();
}

function restoreStudent(id) {
  if (trash[id]) {
    students[id] = trash[id];
    delete trash[id];
    saveToGitHub();
    saveTrashToGitHub();
    showTrash();
    renderStudentCards();
    showSuccess('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
  }
}

function permanentDelete(id) {
  Swal.fire({
    title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
    text: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡!',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
  }).then((result) => {
    if (result.isConfirmed) {
      delete trash[id];
      saveTrashToGitHub();
      showTrash();
      showSuccess('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨');
    }
  });
}

function searchStudent() {
  const id = document.getElementById('searchId').value.trim();
  if (!id) {
    Swal.fire({
      title: 'ØªÙ†Ø¨ÙŠÙ‡',
      text: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø¨Ø­Ø«',
      icon: 'warning'
    });
    return;
  }

  if (students[id]) {
    showStudentDetails(id);
  } else if (allStudentsData[id]) {
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ù…Ù„Ù Ø¢Ø®Ø±
    Swal.fire({
      title: 'ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨',
      text: `Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…Ù„Ù ${allStudentsData[id]._file || 'students.json'}`,
      icon: 'info',
      confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
    });
  } else {
    Swal.fire({
      title: 'âš ï¸ ØªÙ†Ø¨ÙŠÙ‡',
      text: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨',
      confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
    });
  }
}

function showGradeModal() {
  document.getElementById('studentDetailModal').style.display = 'block';
  document.getElementById('studentDetailContent').innerHTML = `
    <div style="padding: 20px;">
      <h3 style="margin-bottom: 20px;"><i class="fas fa-filter"></i> Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
      <select id="gradeSelect" style="width: 100%; margin-bottom: 20px;">
        <option value="">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</option>
      </select>
      <div class="modal-footer">
        <button class="btn" onclick="document.getElementById('studentDetailModal').style.display = 'none'">
          <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
        </button>
        <button class="btn" onclick="filterByGrade()">
          <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
        </button>
      </div>
    </div>
  `;
  
  // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙˆÙ
  const select = document.getElementById('gradeSelect');
  select.innerHTML = '<option value="">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</option>';
  grades.forEach(grade => {
    select.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
}

function filterByGrade() {
  const gradeSelect = document.getElementById('gradeSelect');
  const selectedGrade = gradeSelect.value;
  renderStudentCards(selectedGrade);
  document.getElementById('studentDetailModal').style.display = 'none';
}

function showAddModal() {
  currentStudentId = null;
  document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
  
  // ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ù‚Ù„
  const studentIdField = document.getElementById('studentId');
  studentIdField.value = generateStudentId();
  studentIdField.disabled = true;
  
  document.getElementById('studentName').value = '';
  document.getElementById('studentPhone').value = '';
  document.getElementById('studentLevel').value = '';
  document.getElementById('studentImagePreview').style.display = 'none';
  document.getElementById('imageActions').style.display = 'none';
  studentImageFile = null;
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
  toggleSidebar();
  
  // Focus Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù…
  setTimeout(() => {
    document.getElementById('studentName').focus();
  }, 100);
}

function showEditModal(id) {
  currentStudentId = id;
  const student = students[id];
  
  document.getElementById('modalTitle').innerHTML = `<i class="fas fa-user-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ${id}`;
  
  // ØªÙ…ÙƒÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  const studentIdField = document.getElementById('studentId');
  studentIdField.value = id;
  studentIdField.disabled = false;
  
  document.getElementById('studentName').value = student.name;
  document.getElementById('studentPhone').value = student.phone || '';
  document.getElementById('studentLevel').value = student.info || '';
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}" ${grade === student.main ? 'selected' : ''}>${grade}</option>`;
  });
  
  // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
  const preview = document.getElementById('studentImagePreview');
  const actions = document.getElementById('imageActions');
  if (student.image) {
    preview.src = student.image;
    preview.style.display = 'block';
    actions.style.display = 'flex';
  } else {
    preview.style.display = 'none';
    actions.style.display = 'none';
  }
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
}

function previewStudentImage() {
  const fileInput = document.getElementById('studentImage');
  const preview = document.getElementById('studentImagePreview');
  const actions = document.getElementById('imageActions');
  
  if (fileInput.files && fileInput.files[0]) {
    studentImageFile = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
      actions.style.display = 'flex';
    }
    
    reader.readAsDataURL(fileInput.files[0]);
  }
}

function removeImage() {
  const preview = document.getElementById('studentImagePreview');
  const actions = document.getElementById('imageActions');
  const fileInput = document.getElementById('studentImage');
  
  preview.src = '';
  preview.style.display = 'none';
  actions.style.display = 'none';
  fileInput.value = '';
  studentImageFile = null;
}

function showNotesModal(id) {
  currentStudentId = id;
  const student = students[id];
  
  document.getElementById('notesContent').value = student.notes || '';
  document.getElementById('notesModal').style.display = 'block';
  
  // Focus Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
  setTimeout(() => {
    document.getElementById('notesContent').focus();
  }, 100);
}

function saveNotes() {
  const notes = document.getElementById('notesContent').value.trim();
  if (currentStudentId) {
    students[currentStudentId].notes = notes;
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
    const notesDisplay = document.getElementById(`notes-display-${currentStudentId}`);
    if (notesDisplay) {
      notesDisplay.innerHTML = notes || '<p style="color: var(--text-light); text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>';
    }
    closeModal();
    showSuccess('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
  }
}

function showDeleteModal(id) {
  if (id) {
    deleteStudentId = id;
    const student = students[id];
    document.getElementById('deleteStudentInfo').style.display = 'block';
    document.getElementById('deleteStudentSelectContainer').style.display = 'none';
    
    document.getElementById('deleteStudentName').textContent = student.name;
    document.getElementById('deleteStudentId').textContent = `ÙƒÙˆØ¯: ${id}`;
    document.getElementById('deleteStudentGrade').textContent = student.main;
  } else {
    deleteStudentId = null;
    document.getElementById('deleteStudentInfo').style.display = 'none';
    document.getElementById('deleteStudentSelectContainer').style.display = 'block';
    
    const select = document.getElementById('deleteStudentSelect');
    select.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù„Ø­Ø°Ù</option>';
    
    for (let id in students) {
      const student = students[id];
      select.innerHTML += `<option value="${id}">${id} - ${student.name} (${student.main})</option>`;
    }
  }
  
  document.getElementById('deleteModal').style.display = 'block';
  toggleSidebar();
}

function closeModal() {
  document.getElementById('studentModal').style.display = 'none';
  document.getElementById('deleteModal').style.display = 'none';
  document.getElementById('notesModal').style.display = 'none';
  document.getElementById('studentDetailModal').style.display = 'none';
  document.getElementById('trashModal').style.display = 'none';
}

function closePostModal() {
  document.getElementById('postModal').style.display = 'none';
}

function closeImageModal() {
  document.getElementById('imageModal').style.display = 'none';
}

function expandImage(img) {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('expandedImage');
  modal.style.display = 'block';
  modalImg.src = img.src;
}

function saveStudent() {
  const id = document.getElementById('studentId').value.trim();
  const name = document.getElementById('studentName').value.trim();
  const grade = document.getElementById('studentGrade').value;
  const phone = document.getElementById('studentPhone').value.trim();
  const level = document.getElementById('studentLevel').value;
  
  if (!id) {
    showError('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨');
    document.getElementById('studentId').focus();
    return;
  }
  
  if (!name) {
    showError('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨');
    document.getElementById('studentName').focus();
    return;
  }
  
  if (!grade) {
    showError('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ');
    document.getElementById('studentGrade').focus();
    return;
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ø·Ø§Ù„Ø¨
  const student = {
    name: name,
    main: grade,
    info: level || '',
    phone: phone || '',
    group: grade, // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙ ÙƒÙ…Ø¬Ù…ÙˆØ¹Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    _file: currentDataFile
  };
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
  if (studentImageFile) {
    const reader = new FileReader();
    reader.onload = function(e) {
      student.image = e.target.result;
      completeStudentSave(id, student);
    };
    reader.readAsDataURL(studentImageFile);
  } else {
    completeStudentSave(id, student);
  }
}

function completeStudentSave(id, student) {
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø·Ø§Ù„Ø¨Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ Ø£Ùˆ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙˆØ¯
  if (!currentStudentId || currentStudentId !== id) {
    if (students[id] && !confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ${id}ØŸ`)) {
      return;
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø·Ø§Ù„Ø¨ Ù‚Ø¯ÙŠÙ… Ø¨Ø­Ø§Ø¬Ø© Ù„Ù„Ø­Ø°Ù
    if (currentStudentId && students[currentStudentId]) {
      delete students[currentStudentId];
    }
  }
  
  // Ø­ÙØ¸ Ø§Ù„Ø·Ø§Ù„Ø¨
  students[id] = student;
  allStudentsData[id] = student;
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨
  renderStudentCards();
  
  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
  closeModal();
  
  // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
  showSuccess(`ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ${id} Ø¨Ù†Ø¬Ø§Ø­`);
  
  // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù„Ù‰ GitHub
  saveToGitHub();
  
  // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
  setTimeout(() => {
    showStudentDetails(id);
  }, 500);
}

function confirmDelete() {
  if (!deleteStudentId) {
    deleteStudentId = document.getElementById('deleteStudentSelect').value;
  }
  
  if (!deleteStudentId) {
    showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ Ù„Ù„Ø­Ø°Ù');
    return;
  }
  
  const student = students[deleteStudentId];
  if (!student) {
    showError('Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    return;
  }
  
  Swal.fire({
    title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
    text: `Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ ${deleteStudentId} - ${student.name} Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª`,
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
  }).then((result) => {
    if (result.isConfirmed) {
      // Ù†Ù‚Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª
      trash[deleteStudentId] = {
        ...student,
        deletedAt: new Date().toLocaleString()
      };
      
      // Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      delete students[deleteStudentId];
      delete allStudentsData[deleteStudentId];
      
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨
      renderStudentCards();
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
      closeModal();
      
      // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
      showSuccess(`ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨ ${deleteStudentId} Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª`);
      
      // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù„Ù‰ GitHub
      saveToGitHub();
      saveTrashToGitHub();
    }
  });
}

function renderPosts() {
  let html = '';
  
  for (let id in posts) {
    let post = posts[id];
    html += `
      <div class="post" id="post-${id}">
        <i class="fas fa-trash post-delete" onclick="deletePost('${id}')"></i>
        <div class="post-header">
          <div class="post-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div>
            <div class="post-author">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
            <div class="post-date">${post.date}</div>
          </div>
        </div>
        <div class="post-content">
          <h3>${post.title}</h3>
          <p>${post.content}</p>
          ${post.image ? `<img src="${post.image}" class="post-image" onclick="expandImage(this)">` : ''}
        </div>
        <div class="post-actions">
          <div class="post-action" onclick="toggleLike('${id}')">
            <i class="fas fa-thumbs-up"></i> Ø£Ø¹Ø¬Ø¨Ù†ÙŠ
          </div>
          <div class="post-action">
            <i class="fas fa-comment"></i> ØªØ¹Ù„ÙŠÙ‚
          </div>
          <div class="post-action">
            <i class="fas fa-share"></i> Ù…Ø´Ø§Ø±ÙƒØ©
          </div>
        </div>
      </div>
    `;
  }
  
  document.getElementById('postsList').innerHTML = html || `
    <div class="no-students">
      <h3><i class="fas fa-info-circle"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
    </div>
  `;
}

function showPostModal(id = null) {
  currentPostId = id;
  
  if (id) {
    const post = posts[id];
    document.getElementById('postModalTitle').innerHTML = '<i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±';
    document.getElementById('editPostTitle').value = post.title;
    document.getElementById('editPostContent').value = post.content;
    
    const preview = document.getElementById('postImagePreview');
    const actions = document.getElementById('postImageActions');
    if (post.image) {
      preview.src = post.image;
      preview.style.display = 'block';
      actions.style.display = 'flex';
    } else {
      preview.style.display = 'none';
      actions.style.display = 'none';
    }
  } else {
    document.getElementById('postModalTitle').innerHTML = '<i class="fas fa-plus"></i> Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯';
    document.getElementById('editPostTitle').value = '';
    document.getElementById('editPostContent').value = '';
    document.getElementById('postImagePreview').style.display = 'none';
    document.getElementById('postImageActions').style.display = 'none';
    postImageFile = null;
  }
  
  document.getElementById('postModal').style.display = 'block';
}

function previewPostImage() {
  const fileInput = document.getElementById('postImageInput');
  const preview = document.getElementById('postImagePreview');
  const actions = document.getElementById('postImageActions');
  
  if (fileInput.files && fileInput.files[0]) {
    postImageFile = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
      actions.style.display = 'flex';
    }
    
    reader.readAsDataURL(fileInput.files[0]);
  }
}

function removePostImage() {
  const preview = document.getElementById('postImagePreview');
  const actions = document.getElementById('postImageActions');
  const fileInput = document.getElementById('postImageInput');
  
  preview.src = '';
  preview.style.display = 'none';
  actions.style.display = 'none';
  fileInput.value = '';
  postImageFile = null;
}

function savePost() {
  const title = document.getElementById('editPostTitle').value.trim();
  const content = document.getElementById('editPostContent').value.trim();
  
  if (!title) {
    showError('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ù„Ù„Ù…Ù†Ø´ÙˆØ±');
    document.getElementById('editPostTitle').focus();
    return;
  }
  
  if (!content) {
    showError('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø­ØªÙˆÙ‰ Ù„Ù„Ù…Ù†Ø´ÙˆØ±');
    document.getElementById('editPostContent').focus();
    return;
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø´ÙˆØ±
  const id = currentPostId || Date.now().toString();
  const post = {
    title: title,
    content: content,
    date: new Date().toLocaleString(),
    likes: currentPostId ? posts[currentPostId].likes || 0 : 0
  };
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
  if (postImageFile) {
    const reader = new FileReader();
    reader.onload = function(e) {
      post.image = e.target.result;
      completePostSave(id, post);
    };
    reader.readAsDataURL(postImageFile);
  } else {
    // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
    if (currentPostId && posts[currentPostId].image) {
      post.image = posts[currentPostId].image;
    }
    completePostSave(id, post);
  }
}

function completePostSave(id, post) {
  // Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
  posts[id] = post;
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
  renderPosts();
  
  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
  closePostModal();
  
  // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
  showSuccess(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­`);
  
  // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¹Ù„Ù‰ GitHub
  savePostsToGitHub();
}

function deletePost(id) {
  Swal.fire({
    title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
    text: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡!',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
    cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
  }).then((result) => {
    if (result.isConfirmed) {
      delete posts[id];
      renderPosts();
      savePostsToGitHub();
      showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
    }
  });
}

function toggleLike(id) {
  if (!posts[id].likes) {
    posts[id].likes = 0;
  }
  
  const action = document.querySelector(`#post-${id} .post-action`);
  if (action.classList.contains('liked')) {
    posts[id].likes--;
    action.classList.remove('liked');
    action.innerHTML = '<i class="fas fa-thumbs-up"></i> Ø£Ø¹Ø¬Ø¨Ù†ÙŠ';
  } else {
    posts[id].likes++;
    action.classList.add('liked');
    action.innerHTML = '<i class="fas fa-thumbs-up"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨';
  }
  
  savePostsToGitHub();
}

function switchTab(tabName) {
  // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Ø¥Ù„ØºØ§Ø¡ ØªÙ†Ø´ÙŠØ· Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // ØªÙ†Ø´ÙŠØ· Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
  document.getElementById(`${tabName}-tab`).classList.add('active');
  
  // ØªÙ†Ø´ÙŠØ· Ø²Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
  document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù‡Ùˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
  if (tabName === 'reports') {
    showReports('stats');
  }
}

function showReports(reportType) {
  // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
  document.querySelectorAll('.report-section').forEach(section => {
    section.classList.remove('active');
  });
  
  // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯
  document.getElementById(`${reportType}Report`).classList.add('active');
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù‡Ùˆ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø£Ùˆ Ø§Ù„Ø­Ø¶ÙˆØ±ØŒ Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  if (reportType === 'fees') {
    loadFeesReport();
  } else if (reportType === 'attendance') {
    loadAttendanceReport();
  } else if (reportType === 'stats') {
    updateStats();
  }
}

function loadFeesReport() {
  let html = '';
  
  for (let id in students) {
    const student = students[id];
    html += `
      <tr>
        <td>${id}</td>
        <td>${student.name}</td>
        <td>${student.main}</td>
    `;
    
    // Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù„ÙƒÙ„ Ø´Ù‡Ø±
    months.forEach(month => {
      const isPaid = student.fees?.[month] || false;
      html += `<td>${isPaid ? 'âœ…' : 'âŒ'}</td>`;
    });
    
    html += `</tr>`;
  }
  
  document.getElementById('feesReportBody').innerHTML = html || `
    <tr>
      <td colspan="12" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</td>
    </tr>
  `;
}

function loadAttendanceReport() {
  let html = '';
  
  for (let id in students) {
    const student = students[id];
    html += `
      <tr>
        <td>${id}</td>
        <td>${student.name}</td>
        <td>${student.main}</td>
    `;
    
    // Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙƒÙ„ ÙŠÙˆÙ…
    weekDays.forEach(day => {
      const status = student.attendance?.[day] || '-';
      html += `<td>${status === 'Ø­Ø§Ø¶Ø±' ? 'âœ…' : status === 'ØºØ§Ø¦Ø¨' ? 'âŒ' : '-'}</td>`;
    });
    
    html += `</tr>`;
  }
  
  document.getElementById('attendanceReportBody').innerHTML = html || `
    <tr>
      <td colspan="10" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</td>
    </tr>
  `;
}

function filterFeesReport() {
  const grade = document.getElementById('feesGradeFilter').value;
  const month = document.getElementById('feesMonthFilter').value;
  const status = document.getElementById('feesStatusFilter').value;
  
  let filteredStudents = {};
  
  // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØµÙ
  if (grade) {
    for (let id in students) {
      if (students[id].main === grade) {
        filteredStudents[id] = students[id];
      }
    }
  } else {
    filteredStudents = {...students};
  }
  
  // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ø§
  if (month && status) {
    const temp = {};
    for (let id in filteredStudents) {
      const student = filteredStudents[id];
      const isPaid = student.fees?.[month] || false;
      if ((status === 'paid' && isPaid) || (status === 'unpaid' && !isPaid)) {
        temp[id] = student;
      }
    }
    filteredStudents = temp;
  }
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  let html = '';
  for (let id in filteredStudents) {
    const student = filteredStudents[id];
    html += `
      <tr>
        <td>${id}</td>
        <td>${student.name}</td>
        <td>${student.main}</td>
    `;
    
    months.forEach(m => {
      const isPaid = student.fees?.[m] || false;
      html += `<td>${isPaid ? 'âœ…' : 'âŒ'}</td>`;
    });
    
    html += `</tr>`;
  }
  
  document.getElementById('feesReportBody').innerHTML = html || `
    <tr>
      <td colspan="12" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«</td>
    </tr>
  `;
}

function filterAttendanceReport() {
  const grade = document.getElementById('attendanceGradeFilter').value;
  const day = document.getElementById('attendanceDayFilter').value;
  const status = document.getElementById('attendanceStatusFilter').value;
  
  let filteredStudents = {};
  
  // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØµÙ
  if (grade) {
    for (let id in students) {
      if (students[id].main === grade) {
        filteredStudents[id] = students[id];
      }
    }
  } else {
    filteredStudents = {...students};
  }
  
  // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ø§
  if (day && status) {
    const temp = {};
    for (let id in filteredStudents) {
      const student = filteredStudents[id];
      const attendanceStatus = student.attendance?.[day] || '-';
      if ((status === 'Ø­Ø§Ø¶Ø±' && attendanceStatus === 'Ø­Ø§Ø¶Ø±') || 
          (status === 'ØºØ§Ø¦Ø¨' && attendanceStatus === 'ØºØ§Ø¦Ø¨')) {
        temp[id] = student;
      }
    }
    filteredStudents = temp;
  }
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  let html = '';
  for (let id in filteredStudents) {
    const student = filteredStudents[id];
    html += `
      <tr>
        <td>${id}</td>
        <td>${student.name}</td>
        <td>${student.main}</td>
    `;
    
    weekDays.forEach(d => {
      const attendanceStatus = student.attendance?.[d] || '-';
      html += `<td>${attendanceStatus === 'Ø­Ø§Ø¶Ø±' ? 'âœ…' : attendanceStatus === 'ØºØ§Ø¦Ø¨' ? 'âŒ' : '-'}</td>`;
    });
    
    html += `</tr>`;
  }
  
  document.getElementById('attendanceReportBody').innerHTML = html || `
    <tr>
      <td colspan="10" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«</td>
    </tr>
  `;
}

function updateStats() {
  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨
  document.getElementById('totalStudentsCount').textContent = Object.keys(students).length;
  
  // Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…
  const today = new Date().toLocaleDateString('ar-EG', { weekday: 'long' });
  let presentCount = 0;
  let absentCount = 0;
  
  for (let id in students) {
    const status = students[id].attendance?.[today];
    if (status === 'Ø­Ø§Ø¶Ø±') presentCount++;
    else if (status === 'ØºØ§Ø¦Ø¨') absentCount++;
  }
  
  document.getElementById('todayPresentCount').textContent = presentCount;
  document.getElementById('todayAbsentCount').textContent = absentCount;
  
  // Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
  let paidCount = 0;
  let unpaidCount = 0;
  
  for (let id in students) {
    const fees = students[id].fees || {};
    const currentMonth = new Date().toLocaleDateString('ar-EG', { month: 'long' });
    
    if (fees[currentMonth]) {
      paidCount++;
    } else {
      unpaidCount++;
    }
  }
  
  document.getElementById('paidFeesCount').textContent = paidCount;
  document.getElementById('unpaidFeesCount').textContent = unpaidCount;
}

function exportToExcel() {
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙ†Ù Excel
  const wb = XLSX.utils.book_new();
  
  // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
  const feesData = [];
  
  // Ø¥Ø¶Ø§ÙØ© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
  feesData.push(['ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„ØµÙ', ...months]);
  
  // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
  for (let id in students) {
    const student = students[id];
    const row = [id, student.name, student.main];
    
    months.forEach(month => {
      row.push(student.fees?.[month] ? 'Ù…Ø³Ø¯Ø¯Ø©' : 'ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©');
    });
    
    feesData.push(row);
  }
  
  const feesWS = XLSX.utils.aoa_to_sheet(feesData);
  XLSX.utils.book_append_sheet(wb, feesWS, "Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª");
  
  // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø­Ø¶ÙˆØ±
  const attendanceData = [];
  
  // Ø¥Ø¶Ø§ÙØ© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
  attendanceData.push(['ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„ØµÙ', ...weekDays]);
  
  // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
  for (let id in students) {
    const student = students[id];
    const row = [id, student.name, student.main];
    
    weekDays.forEach(day => {
      row.push(student.attendance?.[day] || '-');
    });
    
    attendanceData.push(row);
  }
  
  const attendanceWS = XLSX.utils.aoa_to_sheet(attendanceData);
  XLSX.utils.book_append_sheet(wb, attendanceWS, "Ø§Ù„Ø­Ø¶ÙˆØ±");
  
  // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
  XLSX.writeFile(wb, 'ØªÙ‚Ø§Ø±ÙŠØ±_Ø§Ù„Ø·Ù„Ø§Ø¨.xlsx');
}

function exportAttendanceToExcel() {
  // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙ†Ù Excel
  const wb = XLSX.utils.book_new();
  
  // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„Ø­Ø¶ÙˆØ±
  const attendanceData = [];
  
  // Ø¥Ø¶Ø§ÙØ© Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
  attendanceData.push(['ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„ØµÙ', ...weekDays]);
  
  // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
  for (let id in students) {
    const student = students[id];
    const row = [id, student.name, student.main];
    
    weekDays.forEach(day => {
      row.push(student.attendance?.[day] || '-');
    });
    
    attendanceData.push(row);
  }
  
  const attendanceWS = XLSX.utils.aoa_to_sheet(attendanceData);
  XLSX.utils.book_append_sheet(wb, attendanceWS, "Ø§Ù„Ø­Ø¶ÙˆØ±");
  
  // ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
  XLSX.writeFile(wb, 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø­Ø¶ÙˆØ±.xlsx');
}

async function saveToGitHub() {
  const token = document.getElementById('token').value.trim();
  if (!token) {
    showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ GitHub Token');
    document.getElementById('token').focus();
    return;
  }
  
  // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ localStorage
  localStorage.setItem('gh_token', token);
  
  try {
    showLoading(true, document.getElementById('saveStudentBtn'));
    
    // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const content = JSON.stringify(students, null, 2);
    const contentEncoded = btoa(unescape(encodeURIComponent(content)));
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø·Ù„Ø¨ API
    let url = `https://api.github.com/repos/${owner}/${repo}/contents/${currentDataFile}`;
    let method = 'PUT';
    
    const body = {
      message: `Update students data - ${new Date().toISOString()}`,
      content: contentEncoded,
      branch: branch
    };
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø£Ø¶Ù SHA Ù„Ù„ØªØ­Ø¯ÙŠØ«
    if (sha) {
      body.sha = sha;
    }
    
    const res = await fetch(url, {
      method: method,
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
    
    // ØªØ­Ø¯ÙŠØ« SHA Ù„Ù„Ù…Ù„Ù
    sha = data.content.sha;
    
    showSuccess('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ GitHub');
  } catch (error) {
    console.error('Error saving to GitHub:', error);
    showError(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: ${error.message}`);
  } finally {
    showLoading(false, document.getElementById('saveStudentBtn'));
  }
}

async function savePostsToGitHub() {
  const token = document.getElementById('token').value.trim();
  if (!token) return;
  
  try {
    showLoading(true);
    
    // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const content = JSON.stringify(posts, null, 2);
    const contentEncoded = btoa(unescape(encodeURIComponent(content)));
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø·Ù„Ø¨ API
    let url = `https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`;
    let method = 'PUT';
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ SHA Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    let sha = '';
    try {
      const res = await fetch(url, {
        headers: {
          'Authorization': `token ${token}`
        }
      });
      
      if (res.ok) {
        const data = await res.json();
        sha = data.sha;
      }
    } catch (e) {
      console.log('File does not exist or cannot be accessed');
    }
    
    const body = {
      message: `Update posts data - ${new Date().toISOString()}`,
      content: contentEncoded,
      branch: branch
    };
    
    if (sha) {
      body.sha = sha;
    }
    
    const res = await fetch(url, {
      method: method,
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª');
    }
    
    console.log('Posts saved successfully:', data);
  } catch (error) {
    console.error('Error saving posts to GitHub:', error);
    showError(`Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª: ${error.message}`);
  } finally {
    showLoading(false);
  }
}

async function saveTrashToGitHub() {
  const token = document.getElementById('token').value.trim();
  if (!token) return;
  
  try {
    showLoading(true);
    
    // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const content = JSON.stringify(trash, null, 2);
    const contentEncoded = btoa(unescape(encodeURIComponent(content)));
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø·Ù„Ø¨ API
    let url = `https://api.github.com/repos/${owner}/${repo}/contents/${trashPath}`;
    let method = 'PUT';
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ SHA Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    let sha = '';
    try {
      const res = await fetch(url, {
        headers: {
          'Authorization': `token ${token}`
        }
      });
      
      if (res.ok) {
        const data = await res.json();
        sha = data.sha;
      }
    } catch (e) {
      console.log('Trash file does not exist or cannot be accessed');
    }
    
    const body = {
      message: `Update trash data - ${new Date().toISOString()}`,
      content: contentEncoded,
      branch: branch
    };
    
    if (sha) {
      body.sha = sha;
    }
    
    const res = await fetch(url, {
      method: method,
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    
    const data = await res.json();
    
    if (!res.ok) {
      throw new Error(data.message || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª');
    }
    
    console.log('Trash saved successfully:', data);
  } catch (error) {
    console.error('Error saving trash to GitHub:', error);
  } finally {
    showLoading(false);
  }
}

function exportData(format) {
  let data, filename, mimeType;
  
  if (format === 'json') {
    data = JSON.stringify(students, null, 2);
    filename = 'students_data.json';
    mimeType = 'application/json';
  } else if (format === 'csv') {
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ CSV
    let csv = 'ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„ØµÙ,Ø§Ù„Ù…Ø³ØªÙˆÙ‰,Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±,Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©\n';
    
    for (let id in students) {
      const s = students[id];
      csv += `"${id}","${s.name}","${s.main}","${s.info || ''}","${s.phone || ''}","${s.group || ''}"\n`;
    }
    
    data = csv;
    filename = 'students_data.csv';
    mimeType = 'text/csv';
  } else {
    showError('ØµÙŠØºØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©');
    return;
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± ØªÙ†Ø²ÙŠÙ„
  const blob = new Blob([data], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function generateQRCode(id, phone) {
  const student = students[id];
  const group = student.group || 'default';
  
  // Ø¥Ù†Ø´Ø§Ø¡ QR Code ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  const qrCodeDiv = document.getElementById(`qr-code-${id}`);
  qrCodeDiv.innerHTML = '';
  
  new QRCode(qrCodeDiv, {
    text: JSON.stringify({
      id: id,
      phone: phone,
      action: 'attendance',
      group: group
    }),
    width: 150,
    height: 150,
    colorDark: "#000000",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });
  
  // Ø¥Ù†Ø´Ø§Ø¡ QR Code Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
  const cardQrCodeDiv = document.getElementById(`qr-code-card-${id}`);
  if (cardQrCodeDiv) {
    cardQrCodeDiv.innerHTML = '';
    new QRCode(cardQrCodeDiv, {
      text: JSON.stringify({
        id: id,
        phone: phone,
        action: 'attendance',
        group: group
      }),
      width: 100,
      height: 100,
      colorDark: "#000000",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });
  }
  
  showSuccess('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ QR Code Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©');
}

function showLoading(show, element = null) {
  if (element) {
    if (show) {
      originalButtonText = element.innerHTML;
      element.innerHTML = '<div class="spinner"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
      element.disabled = true;
    } else {
      element.innerHTML = originalButtonText;
      element.disabled = false;
    }
  } else {
    isLoading = show;
    document.body.style.cursor = show ? 'wait' : 'default';
  }
}

function showError(message) {
  Swal.fire({
    title: 'Ø®Ø·Ø£!',
    text: message,
    icon: 'error',
    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
  });
}

function showSuccess(message) {
  Swal.fire({
    title: 'Ù†Ø¬Ø§Ø­!',
    text: message,
    icon: 'success',
    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
  });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹
if (localStorage.getItem('isLoggedIn') === 'true') {
  document.getElementById('loginScreen').style.display = 'none';
  loadAllStudentsData();
  loadPosts();
  loadTrash();
  
  // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙÙˆÙ
  fillGradeSelects();
  
  // Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
  const today = new Date();
  document.getElementById('currentDate').textContent = today.toLocaleDateString('ar-EG');
}
</script>
</body>
</html> 
