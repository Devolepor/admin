<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لوحة تحكم الطلاب والمنشورات</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #1976d2;
      --primary-dark: #125ea5;
      --danger-color: #e53935;
      --warning-color: #ff9800;
      --success-color: #43a047;
      --text-color: #2d3748;
      --text-light: #4a5568;
      --light-bg: #f8fafc;
      --white: #ffffff;
      --gray-light: #e2e8f0;
      --gray-dark: #cbd5e0;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --transition: all 0.3s ease;
    }

    /* Dark Mode Variables */
    .dark-mode {
      --primary-color: #4299e1;
      --primary-dark: #3182ce;
      --danger-color: #fc8181;
      --warning-color: #f6ad55;
      --success-color: #68d391;
      --text-color: #e2e8f0;
      --text-light: #a0aec0;
      --light-bg: #1a202c;
      --white: #2d3748;
      --gray-light: #4a5568;
      --gray-dark: #2d3748;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Tajawal', sans-serif;
      background-color: var(--light-bg);
      color: var(--text-color);
      line-height: 1.6;
      padding: 0;
      margin: 0;
      min-height: 100vh;
      transition: var(--transition);
    }
    
    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 15px 0;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .header h1 {
      color: var(--primary-color);
      font-size: 28px;
      font-weight: 700;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .grade-select {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    input, button, select, textarea {
      padding: 12px 15px;
      border-radius: var(--radius);
      border: 1px solid var(--gray-light);
      font-family: 'Tajawal', sans-serif;
      font-size: 16px;
      transition: var(--transition);
      width: 100%;
      background-color: var(--white);
      color: var(--text-color);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
    }
    
    .control-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    th, td {
      border: 1px solid var(--gray-light);
      padding: 12px 15px;
      text-align: center;
      font-size: 15px;
    }
    
    th {
      background-color: var(--primary-color);
      color: var(--white);
      font-weight: 500;
    }
    
    tr:nth-child(even) {
      background-color: rgba(0, 0, 0, 0.02);
    }
    
    tr:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    .btn {
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      transition: var(--transition);
    }
    
    .btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-danger {
      background-color: var(--danger-color);
    }
    
    .btn-danger:hover {
      background-color: #c62828;
    }
    
    .btn-success {
      background-color: var(--success-color);
    }
    
    .btn-success:hover {
      background-color: #2e7d32;
    }
    
    .btn-warning {
      background-color: var(--warning-color);
    }
    
    .btn-warning:hover {
      background-color: #e65100;
    }
    
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--white) 0%, var(--light-bg) 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .login-box {
      background: var(--white);
      padding: 40px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    
    .login-box h2 {
      margin-bottom: 25px;
      color: var(--primary-color);
      font-size: 24px;
    }
    
    .login-box input {
      margin-bottom: 20px;
    }
    
    #studentsCount {
      text-align: center;
      font-weight: bold;
      margin: 20px 0;
      color: var(--text-color);
      font-size: 18px;
      background: var(--white);
      padding: 15px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(3px);
    }
    
    .modal-content {
      background-color: var(--white);
      margin: 5% auto;
      padding: 25px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 600px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      position: relative;
      bottom: 80px;
    }
    
    .close {
      color: var(--text-light);
      position: absolute;
      right: 20px;
      top: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .close:hover {
      color: var(--text-color);
    }
    
    .modal-body {
      padding: 20px 0;
    }
    
    .modal-footer {
      text-align: left;
      padding-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .modal-title {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 22px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-color);
    }
    
    .attendance-select, .fee-checkbox {
      margin: 5px 0;
    }
    
    /* Dark mode toggle */
    .theme-toggle {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-color);
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    
    .theme-toggle:hover {
      background-color: rgba(0,0,0,0.1);
    }
    
    /* Export dropdown */
    .export-dropdown {
      position: relative;
      display: inline-block;
    }
    
    .export-btn {
      background-color: var(--warning-color);
    }
    
    .export-btn:hover {
      background-color: #e65100;
    }
    
    .export-content {
      display: none;
      position: absolute;
      background-color: var(--white);
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: var(--radius);
      overflow: hidden;
      right: 0;
      margin-top: 5px;
    }
    
    .export-content a {
      color: var(--text-color);
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      text-align: right;
      transition: var(--transition);
    }
    
    .export-content a:hover {
      background-color: var(--gray-light);
    }
    
    .export-dropdown:hover .export-content {
      display: block;
    }
    
    /* Social Share Buttons */
    .share-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .share-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 15px;
      border-radius: 5px;
      color: white;
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
      min-width: 120px;
    }
    
    .share-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .share-btn i {
      margin-left: 5px;
    }
    
    .facebook {
      background-color: #3b5998;
    }
    
    .whatsapp {
      background-color: #25D366;
    }
    
    .telegram {
      background-color: #0088cc;
    }
    
    .twitter {
      background-color: #1DA1F2;
    }
    
    .link {
      background-color: var(--primary-color);
    }
    
    /* أنماط جديدة للمنشورات */
    .posts-container {
      margin-top: 40px;
      border-top: 2px solid var(--gray-light);
      padding-top: 30px;
    }
    
    .posts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .post-form {
      background: var(--white);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }
    
    .post-form textarea {
      width: 100%;
      padding: 15px;
      border-radius: var(--radius);
      border: 1px solid var(--gray-light);
      font-family: 'Tajawal', sans-serif;
      font-size: 16px;
      margin-bottom: 15px;
      resize: vertical;
      min-height: 100px;
      background-color: var(--white);
      color: var(--text-color);
    }
    
    .post {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
    }
    
    .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .post-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-left: 15px;
    }
    
    .post-author {
      font-weight: bold;
    }
    
    .post-date {
      color: var(--text-light);
      font-size: 14px;
    }
    
    .post-content {
      margin-bottom: 15px;
      line-height: 1.6;
    }
    
    .post-image {
      max-width: 150px;
      max-height: 150px;
      border-radius: 8px;
      margin: 10px 0;
      display: block;
      cursor: pointer;
      transition: transform 0.3s;
    }
    
    .post-image:hover {
      transform: scale(1.5);
      z-index: 10;
      position: relative;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    
    .post-actions {
      display: flex;
      gap: 15px;
      border-top: 1px solid var(--gray-light);
      padding-top: 15px;
      flex-wrap: wrap;
    }
    
    .post-action {
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--text-light);
      cursor: pointer;
      transition: var(--transition);
      padding: 8px 12px;
      border-radius: 20px;
      background-color: var(--light-bg);
    }
    
    .post-action:hover {
      color: var(--primary-color);
      background-color: rgba(25, 118, 210, 0.1);
    }
    
    .post-action.liked {
      color: var(--danger-color);
      background-color: rgba(229, 57, 53, 0.1);
    }
    
    .post-delete {
      position: absolute;
      top: 15px;
      left: 15px;
      color: var(--danger-color);
      cursor: pointer;
      opacity: 0.7;
      transition: var(--transition);
    }
    
    .post-delete:hover {
      opacity: 1;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: var(--transition);
    }
    
    .tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }

    /* أنماط جديدة لقسم الملاحظات */
    .notes-section {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .notes-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .notes-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .notes-content {
      min-height: 100px;
      padding: 10px;
      border: 1px solid var(--gray-light);
      border-radius: var(--radius);
      background-color: var(--white);
      color: var(--text-color);
    }
    
    .notes-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }

    /* أنماط جديدة لواجهة إضافة الطالب */
    .add-student-section {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .add-student-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .add-student-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .add-student-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }
    
    .form-actions {
      grid-column: 1 / -1;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }

    /* أنماط لتحميل الصور */
    .image-upload {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
    }
    
    .image-preview {
      max-width: 150px;
      max-height: 150px;
      border-radius: 8px;
      display: none;
      cursor: pointer;
    }
    
    .upload-btn {
      position: relative;
      overflow: hidden;
      display: inline-block;
    }
    
    .upload-btn input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    /* نمط لعرض الصورة بالحجم الكامل */
    .image-modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      text-align: center;
    }
    
    .image-modal-content {
      max-width: 90%;
      max-height: 90%;
      margin: auto;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    .close-image {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 35px;
      font-weight: bold;
      cursor: pointer;
    }

    /* أنماط جديدة للمشاركة */
    .share-image-container {
      text-align: center;
      margin: 15px 0;
    }
    
    .share-image {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid var(--gray-light);
      box-shadow: var(--shadow);
    }

    /* أنماط جديدة للأزرار على الهواتف */
    .mobile-actions {
      display: none;
    }

    /* أنماط جديدة لعرض الطلاب على الهواتف */
    .student-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 15px;
      margin-bottom: 15px;
      transition: var(--transition);
    }
    
    .student-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    
    .student-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .student-id {
      font-weight: bold;
      color: var(--primary-color);
      font-size: 16px;
    }
    
    .student-name {
      font-weight: bold;
      font-size: 18px;
    }
    
    .student-grade {
      color: var(--text-light);
      font-size: 14px;
    }
    
    .student-level {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      margin-top: 5px;
    }
    
    .level-weak {
      background-color: #ffebee;
      color: #c62828;
    }
    
    .level-acceptable {
      background-color: #fff8e1;
      color: #e65100;
    }
    
    .level-good {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    
    .level-very-good {
      background-color: #e3f2fd;
      color: #1565c0;
    }
    
    .level-excellent {
      background-color: #f3e5f5;
      color: #6a1b9a;
    }
    
    .student-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .student-actions .btn {
      flex: 1;
      padding: 8px;
      font-size: 14px;
    }
    
    .student-details {
      display: none;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--gray-light);
    }
    
    .student-details.active {
      display: block;
    }
    
    .details-section {
      margin-bottom: 15px;
    }
    
    .details-title {
      font-weight: bold;
      margin-bottom: 8px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .attendance-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    
    .attendance-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px;
      background: var(--light-bg);
      border-radius: 5px;
    }
    
    .fees-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    
    .fee-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px;
      background: var(--light-bg);
      border-radius: 5px;
    }
    
    .notes-content {
      background: var(--light-bg);
      padding: 10px;
      border-radius: 5px;
      min-height: 50px;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .header-actions {
        width: 100%;
      }
      
      .grade-select {
        width: 100%;
      }
      
      .grade-select button {
        width: 100%;
      }
      
      .modal-content {
        width: 95%;
        margin: 10% auto;
      }
      
      table {
        display: none;
      }
      
      #studentsTable {
        display: block;
      }
      
      .control-panel {
        grid-template-columns: 1fr;
      }
      
      .export-content {
        right: auto;
        left: 0;
      }
      
      .share-buttons {
        flex-direction: column;
        align-items: center;
      }
      
      .share-btn {
        width: 100%;
      }

      .posts-header {
        flex-direction: column;
        gap: 15px;
      }

      .post-actions {
        flex-direction: column;
        gap: 10px;
      }
      
      .add-student-form {
        grid-template-columns: 1fr;
      }
      
      .post-image {
        max-width: 100%;
        max-height: 200px;
      }

      /* إظهار أزرار الهاتف */
      .mobile-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .desktop-actions {
        display: none;
      }
      
      /* تحسينات لعرض الطلاب على الهواتف */
      .student-card {
        padding: 12px;
      }
      
      .student-name {
        font-size: 16px;
      }
      
      .student-id {
        font-size: 14px;
      }
      
      .student-actions .btn {
        font-size: 12px;
        padding: 6px;
      }
      
      .attendance-grid,
      .fees-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 480px) {
      .login-box {
        padding: 30px 20px;
      }
      
      .modal-footer {
        flex-direction: column;
      }
      
      .modal-footer button {
        width: 100%;
      }

      .tabs {
        flex-direction: column;
      }

      .tab {
        text-align: center;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .form-actions button {
        width: 100%;
      }
      
      .post-image {
        max-width: 100%;
        max-height: 150px;
      }
      
      .student-actions {
        flex-direction: column;
        gap: 8px;
      }
      
      .student-actions .btn {
        width: 100%;
      }
    }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--white);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--gray-light);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
  </style>
</head>
<body>
  <!-- Modal لعرض الصورة بالحجم الكامل -->
  <div id="imageModal" class="image-modal">
    <span class="close-image" onclick="closeImageModal()">&times;</span>
    <img class="image-modal-content" id="expandedImage">
  </div>

  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <h2><i class="fas fa-lock"></i> تسجيل الدخول</h2>
      <input type="password" id="loginPassword" placeholder="ادخل كلمة المرور">
      <button class="btn btn-success" onclick="checkLogin()"><i class="fas fa-sign-in-alt"></i> دخول</button>
    </div>
  </div>

  <div class="container">
    <!-- Modal for Add/Edit Student -->
    <div id="studentModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 class="modal-title" id="modalTitle"><i class="fas fa-user-plus"></i> إضافة طالب</h3>
        <div class="modal-body">
          <div class="form-group">
            <label for="studentId"><i class="fas fa-id-card"></i> كود الطالب</label>
            <input type="text" id="studentId" placeholder="سيتم توليد الكود تلقائياً" disabled>
          </div>
          <div class="form-group">
            <label for="studentName"><i class="fas fa-user"></i> اسم الطالب</label>
            <input type="text" id="studentName" placeholder="أدخل اسم الطالب">
          </div>
          <div class="form-group">
            <label for="studentGrade"><i class="fas fa-graduation-cap"></i> الصف</label>
            <select id="studentGrade">
              <option value="" disabled selected>اختر الصف</option>
            </select>
          </div>
          <div class="form-group">
            <label for="studentLevel"><i class="fas fa-star"></i> المستوى</label>
            <select id="studentLevel">
              <option value="" disabled selected>اختر المستوى</option>
              <option value="ضعيف">ضعيف</option>
              <option value="مقبول">مقبول</option>
              <option value="جيد">جيد</option>
              <option value="جيد جدا">جيد جدا</option>
              <option value="ممتاز">ممتاز</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal()"><i class="fas fa-times"></i> إلغاء</button>
          <button class="btn btn-success" id="saveStudentBtn"><i class="fas fa-save"></i> حفظ</button>
        </div>
      </div>
    </div>

    <!-- Modal for Grade Selection -->
    <div id="gradeModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 class="modal-title"><i class="fas fa-filter"></i> اختر الصف لعرض الطلاب</h3>
        <div class="modal-body">
          <select id="gradeSelect">
            <option value="">عرض جميع الطلاب</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal()"><i class="fas fa-times"></i> إلغاء</button>
          <button class="btn" onclick="filterByGrade()"><i class="fas fa-eye"></i> عرض</button>
        </div>
      </div>
    </div>

    <!-- Modal for Delete Confirmation -->
    <div id="deleteModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 class="modal-title"><i class="fas fa-trash-alt"></i> تأكيد الحذف</h3>
        <div class="modal-body">
          <p id="deleteMessage">هل أنت متأكد من حذف هذا الطالب؟</p>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal()"><i class="fas fa-times"></i> إلغاء</button>
          <button class="btn btn-danger" onclick="confirmDelete()"><i class="fas fa-trash"></i> نعم، احذف</button>
        </div>
      </div>
    </div>

    <!-- Modal for Add/Edit Post -->
    <div id="postModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closePostModal()">&times;</span>
        <h3 class="modal-title" id="postModalTitle"><i class="fas fa-plus"></i> منشور جديد</h3>
        <div class="modal-body">
          <div class="form-group">
            <label for="editPostTitle"><i class="fas fa-heading"></i> عنوان المنشور</label>
            <input type="text" id="editPostTitle" placeholder="أدخل عنوان المنشور">
          </div>
          <div class="form-group">
            <label for="editPostContent"><i class="fas fa-align-left"></i> محتوى المنشور</label>
            <textarea id="editPostContent" placeholder="اكتب محتوى المنشور هنا..." rows="6"></textarea>
          </div>
          <div class="form-group">
            <label><i class="fas fa-image"></i> صورة المنشور (اختياري)</label>
            <div class="image-upload">
              <button class="btn upload-btn">
                <i class="fas fa-upload"></i> اختر صورة
                <input type="file" id="postImageInput" accept="image/*" onchange="previewPostImage()">
              </button>
              <img id="postImagePreview" class="image-preview" alt="معاينة الصورة" onclick="expandImage(this)">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closePostModal()"><i class="fas fa-times"></i> إلغاء</button>
          <button class="btn btn-success" id="savePostBtn"><i class="fas fa-save"></i> حفظ</button>
        </div>
      </div>
    </div>
    
    <!-- Modal for Edit Notes -->
    <div id="notesModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 class="modal-title"><i class="fas fa-sticky-note"></i> تعديل الملاحظات</h3>
        <div class="modal-body">
          <div class="form-group">
            <label for="notesContent"><i class="fas fa-edit"></i> ملاحظات الطالب</label>
            <textarea id="notesContent" rows="6" placeholder="أدخل ملاحظات عن الطالب"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn" onclick="closeModal()"><i class="fas fa-times"></i> إلغاء</button>
          <button class="btn btn-success" onclick="saveNotes()"><i class="fas fa-save"></i> حفظ</button>
        </div>
      </div>
    </div>

    <div class="header">
      <h1><i class="fas fa-user-graduate"></i> لوحة تحكم الطلاب والمنشورات</h1>
      <div class="header-actions">
        <div class="grade-select">
          <button onclick="showGradeModal()"><i class="fas fa-filter"></i> اختر الصف</button>
          <button onclick="renderTable()"><i class="fas fa-list"></i> عرض الكل</button>
        </div>
        <button class="theme-toggle" id="themeToggle" title="تبديل الوضع الليلي">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('students')">
        <i class="fas fa-users"></i> الطلاب
      </div>
      <div class="tab" onclick="switchTab('posts')">
        <i class="fas fa-newspaper"></i> المنشورات
      </div>
    </div>

    <!-- Students Tab -->
    <div id="students-tab" class="tab-content active">
      <!-- قسم إضافة طالب جديد -->
      <div class="add-student-section">
        <div class="add-student-header">
          <h2 class="add-student-title"><i class="fas fa-user-plus"></i> إضافة طالب جديد</h2>
        </div>
        <div class="add-student-form">
          <div class="form-group">
            <label for="newStudentId"><i class="fas fa-id-card"></i> كود الطالب</label>
            <input type="text" id="newStudentId" placeholder="سيتم توليد الكود تلقائياً" disabled>
          </div>
          <div class="form-group">
            <label for="newStudentName"><i class="fas fa-user"></i> اسم الطالب</label>
            <input type="text" id="newStudentName" placeholder="أدخل اسم الطالب">
          </div>
          <div class="form-group">
            <label for="newStudentGrade"><i class="fas fa-graduation-cap"></i> الصف</label>
            <select id="newStudentGrade">
              <option value="" disabled selected>اختر الصف</option>
            </select>
          </div>
          <div class="form-group">
            <label for="newStudentLevel"><i class="fas fa-star"></i> المستوى</label>
            <select id="newStudentLevel">
              <option value="" disabled selected>اختر المستوى</option>
              <option value="ضعيف">ضعيف</option>
              <option value="مقبول">مقبول</option>
              <option value="جيد">جيد</option>
              <option value="جيد جدا">جيد جدا</option>
              <option value="ممتاز">ممتاز</option>
            </select>
          </div>
          <div class="form-actions">
            <button class="btn" onclick="clearAddForm()"><i class="fas fa-broom"></i> مسح النموذج</button>
            <button class="btn btn-success" onclick="addStudentFromForm()"><i class="fas fa-plus"></i> إضافة طالب</button>
          </div>
        </div>
      </div>
      
      <div class="control-panel">
        <input type="text" id="token" placeholder="🔑 GitHub Token">
        <input type="text" id="searchId" placeholder="🔍 كود الطالب">
        <button class="btn" onclick="searchStudent()"><i class="fas fa-search"></i> بحث</button>
        <button class="btn" onclick="openFile()"><i class="fas fa-folder-open"></i> فتح ملف</button>
        <button class="btn" onclick="saveToGitHub()"><i class="fas fa-save"></i> حفظ</button>
        <div class="export-dropdown">
          <button class="btn export-btn"><i class="fas fa-file-export"></i> تصدير البيانات</button>
          <div class="export-content">
            <a href="#" onclick="exportData('pdf')"><i class="fas fa-file-pdf"></i> تصدير PDF</a>
            <a href="#" onclick="exportData('excel')"><i class="fas fa-file-excel"></i> تصدير Excel</a>
            <a href="#" onclick="exportData('word')"><i class="fas fa-file-word"></i> تصدير Word</a>
            <a href="#" onclick="exportData('json')"><i class="fas fa-file-code"></i> تصدير JSON</a>
          </div>
        </div>
      </div>

      <div id="studentsCount"></div>
      <div id="studentsTable"></div>
      <div id="studentsCards"></div>
    </div>

    <!-- Posts Tab -->
    <div id="posts-tab" class="tab-content">
      <div class="posts-container">
        <div class="posts-header">
          <h2><i class="fas fa-newspaper"></i> المنشورات</h2>
          <button class="btn btn-success" onclick="showPostModal()">
            <i class="fas fa-plus"></i> منشور جديد
          </button>
        </div>

        <div id="postsList"></div>
      </div>
    </div>
  </div>

<script>
// Initialize jsPDF
const { jsPDF } = window.jspdf;

let students = {};
let posts = {};
let sha = "";
const owner = "Devolepor";
const repo = "app";
const path = "students.json";
const postsPath = "posts.json";
const branch = "main";
const PASSWORD = "0101356859001223277310";
let githubFileUrl = `https://github.com/${owner}/${repo}/blob/${branch}/${path}`;
let currentStudentId = null;
let currentPostId = null;
let deleteStudentId = null;
let isLoading = false;
let originalButtonText = "";
let postImageFile = null;

const grades = [
  "الصف الأول الابتدائي", "الصف الثاني الابتدائي", "الصف الثالث الابتدائي",
  "الصف الرابع الابتدائي", "الصف الخامس الابتدائي", "الصف السادس الابتدائي",
  "الصف الأول الإعدادي", "الصف الثاني الإعدادي", "الصف الثالث الإعدادي",
  "الصف الأول الثانوي", "الصف الثاني الثانوي", "الصف الثالث الثانوي"
];

const levels = ["ضعيف", "مقبول", "جيد", "جيد جدا", "ممتاز"];

// أيام الأسبوع وأشهر السنة للاستخدام في الجدول
const weekDays = ["السبت", "الأحد", "الاثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة"];
const months = ["أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر", "يناير", "فبراير", "مارس", "أبريل"];

// Check for saved theme preference
if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark-mode");
  document.getElementById("themeToggle").innerHTML = '<i class="fas fa-sun"></i>';
}

if (localStorage.getItem("gh_token")) {
  document.getElementById("token").value = localStorage.getItem("gh_token");
}

// Theme toggle functionality
document.getElementById("themeToggle").addEventListener("click", function() {
  document.body.classList.toggle("dark-mode");
  if (document.body.classList.contains("dark-mode")) {
    localStorage.setItem("theme", "dark");
    this.innerHTML = '<i class="fas fa-sun"></i>';
  } else {
    localStorage.setItem("theme", "light");
    this.innerHTML = '<i class="fas fa-moon"></i>';
  }
});

// دالة لتوليد كود طالب عشوائي مكون من 6 أرقام
function generateStudentId() {
  let id;
  do {
    id = Math.floor(100000 + Math.random() * 900000).toString();
  } while (students[id]); // تأكد من أن الكود غير موجود مسبقاً
  return id;
}

function checkLogin() {
  const pass = document.getElementById("loginPassword").value;
  if (pass === PASSWORD) {
    localStorage.setItem("isLoggedIn", "true");
    document.getElementById("loginScreen").style.display = "none";
    loadStudents();
    loadPosts();
    
    // تعبئة قائمة الصفوف عند تسجيل الدخول
    fillGradeSelects();
  } else {
    Swal.fire({
      title: 'خطأ!',
      text: 'كلمة مرور خاطئة!',
      icon: 'error',
      confirmButtonText: 'حسناً'
    });
  }
}

// تعبئة قوائم الصفوف في النماذج
function fillGradeSelects() {
  const gradeSelects = [
    document.getElementById('studentGrade'),
    document.getElementById('newStudentGrade'),
    document.getElementById('gradeSelect')
  ];
  
  gradeSelects.forEach(select => {
    if (select) {
      select.innerHTML = '<option value="" disabled selected>اختر الصف</option>';
      grades.forEach(grade => {
        select.innerHTML += `<option value="${grade}">${grade}</option>`;
      });
    }
  });
}

async function loadStudents() {
  try {
    showLoading(true);
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`);
    if (!res.ok) throw new Error('فشل في تحميل بيانات الطلاب');
    
    let data = await res.json();
    sha = data.sha;
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    students = JSON.parse(decodedContent);
    renderTable();
    renderStudentCards();
  } catch (error) {
    console.error("Error loading students:", error);
    students = {};
    renderTable();
    renderStudentCards();
    Swal.fire({
      title: 'تحذير',
      text: 'لا يوجد بيانات حالية للطلاب، سيتم إنشاء ملف جديد عند الحفظ',
      icon: 'warning'
    });
  } finally {
    showLoading(false);
  }
}

async function loadPosts() {
  try {
    showLoading(true);
    let res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`);
    if (!res.ok) throw new Error('فشل في تحميل المنشورات');
    
    let data = await res.json();
    let decodedContent = decodeURIComponent(escape(atob(data.content)));
    posts = JSON.parse(decodedContent);
    renderPosts();
  } catch (error) {
    console.error("Error loading posts:", error);
    posts = {};
    renderPosts();
    Swal.fire({
      title: 'تحذير',
      text: 'لا يوجد منشورات حالية، سيتم إنشاء ملف جديد عند الحفظ',
      icon: 'warning'
    });
  } finally {
    showLoading(false);
  }
}

function renderTable(filterGrade = null) {
  if (window.innerWidth <= 768) return; // لا تعرض الجدول على الهواتف
  
  let html = `
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>الكود</th>
            <th>الاسم</th>
            <th>الصف</th>
            <th>المستوى</th>
            <th>الحضور</th>
            <th>المصروفات</th>
            <th>الملاحظات</th>
            <th>تعديل</th>
            <th>حذف</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  let count = 1;
  let studentCount = 0;
  
  for (let id in students) {
    let s = students[id];
    if (filterGrade && s.main.trim() !== filterGrade.trim()) continue;

    studentCount++;
    
    // تحضير بيانات الحضور
    let attendanceHtml = weekDays.map(day => {
      const status = s.attendance?.[day] || '-';
      return `
        <div class="attendance-select">
          ${day}: 
          <select onchange="updateAttendance('${id}','${day}',this.value)" style="padding: 5px; border-radius: 5px; background: var(--white); color: var(--text-color);">
            <option value="حاضر" ${status === "حاضر" ? 'selected' : ''}>حاضر</option>
            <option value="غائب" ${status === "غائب" ? 'selected' : ''}>غائب</option>
            <option value="-" ${status === "-" ? 'selected' : ''}>-</option>
          </select>
        </div>
      `;
    }).join('');
    
    // تحضير بيانات المصروفات
    let feesHtml = months.map(month => {
      const paid = s.fees?.[month] || false;
      return `
        <div class="fee-checkbox">
          ${month}: 
          <input type="checkbox" onchange="updateFee('${id}','${month}',this.checked)" ${paid ? 'checked' : ''} 
                 style="transform: scale(1.3); margin-right: 5px;">
        </div>
      `;
    }).join('');
    
    // تحضير قسم الملاحظات
    let notesHtml = `
      <div class="notes-section">
        <div class="notes-content">
          ${s.notes || '<span style="color: var(--text-light);">لا توجد ملاحظات</span>'}
        </div>
        <div class="notes-actions">
          <button class="btn" onclick="showNotesModal('${id}')">
            <i class="fas fa-edit"></i> تعديل الملاحظات
          </button>
        </div>
      </div>
    `;
    
    html += `
      <tr>
        <td>${count++}</td>
        <td>${id}</td>
        <td>${s.name}</td>
        <td>${s.main}</td>
        <td>${s.info || '-'}</td>
        <td>${attendanceHtml}</td>
        <td>${feesHtml}</td>
        <td>${notesHtml}</td>
        <td><button class="btn" onclick="showEditModal('${id}')"><i class="fas fa-edit"></i> تعديل</button></td>
        <td><button class="btn btn-danger" onclick="showDeleteModal('${id}')"><i class="fas fa-trash"></i> حذف</button></td>
      </tr>
    `;
  }
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  document.getElementById('studentsTable').innerHTML = studentCount > 0 ? html : `
    <div style="text-align: center; padding: 40px; background: var(--white); border-radius: 12px; box-shadow: var(--shadow);">
      <h3 style="color: var(--text-light);"><i class="fas fa-info-circle"></i> لا يوجد طلاب مسجلين حالياً</h3>
    </div>
  `;
  
  document.getElementById('studentsCount').innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <span><i class="fas fa-users"></i> عدد الطلاب المعروضين: ${studentCount}</span>
      <span><i class="fas fa-calendar-alt"></i> ${new Date().toLocaleDateString('ar-EG')}</span>
    </div>
  `;
}

function renderStudentCards(filterGrade = null) {
  if (window.innerWidth > 768) {
    document.getElementById('studentsCards').innerHTML = '';
    return;
  }
  
  let html = '';
  let studentCount = 0;
  
  for (let id in students) {
    let s = students[id];
    if (filterGrade && s.main.trim() !== filterGrade.trim()) continue;

    studentCount++;
    
    // تحديد فئة المستوى لتنسيق العرض
    let levelClass = '';
    if (s.info === "ضعيف") levelClass = "level-weak";
    else if (s.info === "مقبول") levelClass = "level-acceptable";
    else if (s.info === "جيد") levelClass = "level-good";
    else if (s.info === "جيد جدا") levelClass = "level-very-good";
    else if (s.info === "ممتاز") levelClass = "level-excellent";
    
    html += `
      <div class="student-card" id="student-card-${id}">
        <div class="student-header" onclick="toggleStudentDetails('${id}')">
          <div>
            <div class="student-name">${s.name}</div>
            <div class="student-id">كود: ${id}</div>
          </div>
          <div>
            <div class="student-grade">${s.main}</div>
            ${s.info ? `<span class="student-level ${levelClass}">${s.info}</span>` : ''}
          </div>
        </div>
        
        <div class="student-details" id="details-${id}">
          <div class="details-section">
            <div class="details-title"><i class="fas fa-calendar-check"></i> الحضور</div>
            <div class="attendance-grid">
              ${weekDays.map(day => `
                <div class="attendance-item">
                  <span>${day}</span>
                  <select onchange="updateAttendance('${id}','${day}',this.value)" 
                          style="padding: 3px; border-radius: 5px; background: var(--white); color: var(--text-color);">
                    <option value="حاضر" ${s.attendance?.[day] === "حاضر" ? 'selected' : ''}>حاضر</option>
                    <option value="غائب" ${s.attendance?.[day] === "غائب" ? 'selected' : ''}>غائب</option>
                    <option value="-" ${!s.attendance?.[day] || s.attendance?.[day] === "-" ? 'selected' : ''}>-</option>
                  </select>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="details-section">
            <div class="details-title"><i class="fas fa-money-bill-wave"></i> المصروفات</div>
            <div class="fees-grid">
              ${months.map(month => `
                <div class="fee-item">
                  <span>${month}</span>
                  <input type="checkbox" onchange="updateFee('${id}','${month}',this.checked)" 
                         ${s.fees?.[month] ? 'checked' : ''} style="transform: scale(1.2);">
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="details-section">
            <div class="details-title"><i class="fas fa-sticky-note"></i> الملاحظات</div>
            <div class="notes-content">
              ${s.notes || 'لا توجد ملاحظات'}
            </div>
          </div>
          
          <div class="student-actions">
            <button class="btn" onclick="showEditModal('${id}')">
              <i class="fas fa-edit"></i> تعديل
            </button>
            <button class="btn btn-danger" onclick="showDeleteModal('${id}')">
              <i class="fas fa-trash"></i> حذف
            </button>
            <button class="btn btn-success" onclick="showNotesModal('${id}')">
              <i class="fas fa-edit"></i> ملاحظات
            </button>
          </div>
        </div>
      </div>
    `;
  }
  
  document.getElementById('studentsCards').innerHTML = studentCount > 0 ? html : `
    <div style="text-align: center; padding: 40px; background: var(--white); border-radius: 12px; box-shadow: var(--shadow);">
      <h3 style="color: var(--text-light);"><i class="fas fa-info-circle"></i> لا يوجد طلاب مسجلين حالياً</h3>
    </div>
  `;
  
  document.getElementById('studentsCount').innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <span><i class="fas fa-users"></i> عدد الطلاب المعروضين: ${studentCount}</span>
      <span><i class="fas fa-calendar-alt"></i> ${new Date().toLocaleDateString('ar-EG')}</span>
    </div>
  `;
}

function toggleStudentDetails(id) {
  const details = document.getElementById(`details-${id}`);
  details.classList.toggle('active');
  
  // إغلاق التفاصيل الأخرى إذا كانت مفتوحة
  document.querySelectorAll('.student-details').forEach(detail => {
    if (detail.id !== `details-${id}` && detail.classList.contains('active')) {
      detail.classList.remove('active');
    }
  });
}

function renderPosts() {
  const postsList = document.getElementById('postsList');
  postsList.innerHTML = '';
  
  if (Object.keys(posts).length === 0) {
    postsList.innerHTML = `
      <div style="text-align: center; padding: 40px; background: var(--white); border-radius: 12px; box-shadow: var(--shadow);">
        <h3 style="color: var(--text-light);"><i class="fas fa-info-circle"></i> لا يوجد منشورات حالياً</h3>
      </div>
    `;
    return;
  }
  
  // ترتيب المنشورات من الأحدث إلى الأقدم
  const sortedPosts = Object.entries(posts).sort((a, b) => new Date(b[1].date) - new Date(a[1].date));
  
  sortedPosts.forEach(([id, post]) => {
    const postElement = document.createElement('div');
    postElement.className = 'post';
    
    let imageHtml = '';
    if (post.image) {
      imageHtml = `<img src="${post.image}" class="post-image" alt="صورة المنشور" onclick="expandImage(this)">`;
    }
    
    postElement.innerHTML = `
      <div class="post-delete" onclick="deletePost('${id}')">
        <i class="fas fa-trash"></i>
      </div>
      <div class="post-header">
        <div class="post-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div>
          <div class="post-author">${post.author}</div>
          <div class="post-date">${post.date}</div>
        </div>
      </div>
      <div class="post-content">
        <h3>${post.title}</h3>
        <p>${post.content.replace(/\n/g, '<br>')}</p>
        ${imageHtml}
      </div>
      <div class="post-actions">
        <div class="post-action ${post.likedBy && post.likedBy.includes('admin') ? 'liked' : ''}" 
             onclick="toggleLike('${id}')">
          <i class="fas fa-heart"></i>
          <span>${post.likes || 0} إعجاب</span>
        </div>
        <div class="post-action" onclick="sharePost('${id}')">
          <i class="fas fa-share"></i>
          <span>${post.shares || 0} مشاركة</span>
        </div>
        <div class="post-action" onclick="showPostModal('${id}')">
          <i class="fas fa-edit"></i>
          <span>تعديل</span>
        </div>
      </div>
      <div class="mobile-actions">
        <button class="btn" onclick="toggleLike('${id}')">
          <i class="fas fa-heart"></i> إعجاب (${post.likes || 0})
        </button>
        <button class="btn" onclick="sharePost('${id}')">
          <i class="fas fa-share"></i> مشاركة
        </button>
        <button class="btn" onclick="showPostModal('${id}')">
          <i class="fas fa-edit"></i> تعديل
        </button>
      </div>
    `;
    postsList.appendChild(postElement);
  });
}

function updateAttendance(id, day, value) {
  if (!students[id].attendance) {
    students[id].attendance = {};
  }
  students[id].attendance[day] = value;
}

function updateFee(id, month, value) {
  if (!students[id].fees) {
    students[id].fees = {};
  }
  students[id].fees[month] = value;
}

function searchStudent() {
  const id = document.getElementById('searchId').value.trim();
  if (!id) {
    Swal.fire({
      title: 'تنبيه',
      text: 'الرجاء إدخال كود الطالب للبحث',
      icon: 'warning'
    });
    return;
  }

  if (students[id]) {
    const student = students[id];
    let attendanceList = weekDays.map(day => 
      `<li>${day}: ${student.attendance?.[day] || '-'}</li>`
    ).join('');
    
    let feesList = months.map(month => 
      `<li>${month}: ${student.fees?.[month] ? '✅ مسددة' : '❌ غير مسددة'}</li>`
    ).join('');
    
    let notesHtml = student.notes ? `
      <hr>
      <h4><i class="fas fa-sticky-note"></i> الملاحظات:</h4>
      <div style="background: var(--light-bg); padding: 10px; border-radius: 8px;">
        ${student.notes}
      </div>
    ` : '';
    
    Swal.fire({
      title: '📄 بيانات الطالب',
      html: `
        <div style="text-align: right;">
          <p><b><i class="fas fa-id-card"></i> الكود:</b> ${id}</p>
          <p><b><i class="fas fa-user"></i> الاسم:</b> ${student.name}</p>
          <p><b><i class="fas fa-graduation-cap"></i> الصف:</b> ${student.main}</p>
          <p><b><i class="fas fa-star"></i> المستوى:</b> ${student.info || '-'}</p>
          <hr>
          <h4><i class="fas fa-calendar-check"></i> الحضور:</h4>
          <ul>${attendanceList}</ul>
          <h4><i class="fas fa-money-bill-wave"></i> المصروفات:</h4>
          <ul>${feesList}</ul>
          ${notesHtml}
        </div>
      `,
      confirmButtonText: 'حسناً',
      width: '600px'
    });
    
    // Highlight the student card if on mobile
    if (window.innerWidth <= 768) {
      const card = document.getElementById(`student-card-${id}`);
      if (card) {
        card.scrollIntoView({ behavior: 'smooth' });
        card.style.boxShadow = '0 0 0 3px var(--primary-color)';
        setTimeout(() => {
          card.style.boxShadow = 'var(--shadow)';
        }, 2000);
      }
    }
  } else {
    Swal.fire({
      title: '⚠️ تنبيه',
      text: 'لم يتم العثور على الطالب',
      confirmButtonText: 'حسناً'
    });
  }
}

function openFile() {
  window.open(githubFileUrl, '_blank');
}

function showGradeModal() {
  const gradeSelect = document.getElementById('gradeSelect');
  gradeSelect.innerHTML = '<option value="">عرض جميع الطلاب</option>';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
  document.getElementById('gradeModal').style.display = 'block';
}

function filterByGrade() {
  const gradeSelect = document.getElementById('gradeSelect');
  const selectedGrade = gradeSelect.value;
  renderTable(selectedGrade);
  renderStudentCards(selectedGrade);
  closeModal();
}

function showAddModal() {
  currentStudentId = null;
  document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus"></i> إضافة طالب جديد';
  
  // توليد كود تلقائي وتعطيل الحقل
  const studentIdField = document.getElementById('studentId');
  studentIdField.value = generateStudentId();
  studentIdField.disabled = true;
  
  document.getElementById('studentName').value = '';
  document.getElementById('studentLevel').value = '';
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '<option value="" disabled selected>اختر الصف</option>';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
  });
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
  
  // Focus على حقل الاسم
  setTimeout(() => {
    document.getElementById('studentName').focus();
  }, 100);
}

function showEditModal(id) {
  currentStudentId = id;
  const student = students[id];
  
  document.getElementById('modalTitle').innerHTML = `<i class="fas fa-user-edit"></i> تعديل بيانات الطالب ${id}`;
  
  // تمكين حقل الكود في حالة التعديل
  const studentIdField = document.getElementById('studentId');
  studentIdField.value = id;
  studentIdField.disabled = false;
  
  document.getElementById('studentName').value = student.name;
  
  const gradeSelect = document.getElementById('studentGrade');
  gradeSelect.innerHTML = '';
  grades.forEach(grade => {
    gradeSelect.innerHTML += `<option value="${grade}" ${grade === student.main ? 'selected' : ''}>${grade}</option>`;
  });
  
  const levelSelect = document.getElementById('studentLevel');
  levelSelect.innerHTML = '<option value="" disabled>اختر المستوى</option>';
  levels.forEach(level => {
    levelSelect.innerHTML += `<option value="${level}" ${level === student.info ? 'selected' : ''}>${level}</option>`;
  });
  
  document.getElementById('saveStudentBtn').onclick = saveStudent;
  document.getElementById('studentModal').style.display = 'block';
}

function showNotesModal(id) {
  currentStudentId = id;
  const student = students[id];
  
  document.getElementById('notesContent').value = student.notes || '';
  document.getElementById('notesModal').style.display = 'block';
}

function saveNotes() {
  const notes = document.getElementById('notesContent').value.trim();
  if (currentStudentId) {
    students[currentStudentId].notes = notes;
    renderTable();
    renderStudentCards();
    closeModal();
    showSuccess('تم حفظ الملاحظات بنجاح');
  }
}

function showDeleteModal(id) {
  deleteStudentId = id;
  const student = students[id];
  document.getElementById('deleteMessage').innerHTML = `
    <p>هل أنت متأكد من حذف الطالب التالي؟</p>
    <div style="background: var(--gray-light); padding: 10px; border-radius: 8px; margin-top: 10px;">
      <p><strong><i class="fas fa-id-card"></i> الكود:</strong> ${id}</p>
      <p><strong><i class="fas fa-user"></i> الاسم:</strong> ${student.name}</p>
      <p><strong><i class="fas fa-graduation-cap"></i> الصف:</strong> ${student.main}</p>
    </div>
    <p style="color: var(--danger-color); margin-top: 10px;"><i class="fas fa-exclamation-triangle"></i> هذا الإجراء لا يمكن التراجع عنه!</p>
  `;
  document.getElementById('deleteModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('studentModal').style.display = 'none';
  document.getElementById('gradeModal').style.display = 'none';
  document.getElementById('deleteModal').style.display = 'none';
  document.getElementById('notesModal').style.display = 'none';
}

function closePostModal() {
  document.getElementById('postModal').style.display = 'none';
}

function closeImageModal() {
  document.getElementById('imageModal').style.display = 'none';
}

function expandImage(img) {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('expandedImage');
  modal.style.display = 'block';
  modalImg.src = img.src;
}

function addStudentFromForm() {
  const id = generateStudentId();
  const name = document.getElementById('newStudentName').value.trim();
  const grade = document.getElementById('newStudentGrade').value;
  const level = document.getElementById('newStudentLevel').value;
  
  if (!name) {
    showError('يجب إدخال اسم الطالب');
    document.getElementById('newStudentName').focus();
    return;
  }
  
  if (!grade) {
    showError('يجب اختيار الصف');
    document.getElementById('newStudentGrade').focus();
    return;
  }
  
  // Add new student
  students[id] = {
    name,
    main: grade,
    info: level,
    notes: '',
    attendance: Object.fromEntries(weekDays.map(day => [day, "-"])),
    fees: Object.fromEntries(months.map(month => [month, false]))
  };
  
  // Capture the UI to share as image
  captureStudentUI(id, name, grade, level);
  
  renderTable();
  renderStudentCards();
  clearAddForm();
}

async function captureStudentUI(id, name, grade, level) {
  try {
    // Create a temporary element to capture
    const tempDiv = document.createElement('div');
    tempDiv.style.position = 'fixed';
    tempDiv.style.left = '-9999px';
    tempDiv.style.padding = '15px';
    tempDiv.style.backgroundColor = 'linear-gradient(to right, #ff758c, #ff7eb3);';
    tempDiv.style.borderRadius = '10px';
    tempDiv.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
    tempDiv.style.width = '300px';
    tempDiv.style.fontFamily = "'Tajawal', sans-serif";
    
    tempDiv.innerHTML = `
      <div style="text-align: center;">
        <h2 style="color: #1976d2; margin-bottom: 15px; font-size: 20px;">بيانات الطالب</h2>
        <div style="text-align: right; padding: 0 10px;">
          <p style="margin: 8px 0; font-size: 14px;"><strong><i class="fas fa-id-card"></i> الكود:</strong> ${id}</p>
          <p style="margin: 8px 0; font-size: 14px;"><strong><i class="fas fa-user"></i> الاسم:</strong> ${name}</p>
          <p style="margin: 8px 0; font-size: 14px;"><strong><i class="fas fa-graduation-cap"></i> الصف:</strong> ${grade}</p>
        </div>
        <p style="margin-top: 15px; color: #666; font-size: 12px;">تاريخ الإضافة: ${new Date().toLocaleDateString('ar-EG')}</p>
      </div>
    `;
    
    document.body.appendChild(tempDiv);
    
    // Use html2canvas to capture the element
    const canvas = await html2canvas(tempDiv, {
      scale: 1,
      logging: false,
      useCORS: true,
      width: 300,
      height: tempDiv.offsetHeight
    });
    
    document.body.removeChild(tempDiv);
    
    // Convert canvas to image URL
    const imageUrl = canvas.toDataURL('image/png');
    
    // عرض رسالة بنجاح مع كود الطالب والصورة
    const shareUrl = encodeURIComponent(window.location.href);
    
    Swal.fire({
      title: 'تمت الإضافة بنجاح',
      html: `
        <div style="text-align: right;">
          <div class="share-image-container">
            <img src="${imageUrl}" class="share-image" alt="بيانات الطالب">
          </div>
          <p><b><i class="fas fa-id-card"></i> كود الطالب:</b> ${id}</p>
          <p><b><i class="fas fa-user"></i> الاسم:</b> ${name}</p>
          <p><b><i class="fas fa-graduation-cap"></i> الصف:</b> ${grade}</p>
          
          <div class="share-buttons">
            <a href="https://www.facebook.com/sharer/sharer.php?u=${shareUrl}" 
               target="_blank" class="share-btn facebook">
              <i class="fab fa-facebook-f"></i> فيسبوك
            </a>
            <a href="https://wa.me/?text=${encodeURIComponent(`بيانات الطالب:\nالكود: ${id}\nالاسم: ${name}\nالصف: ${grade}}`)}" 
               target="_blank" class="share-btn whatsapp">
              <i class="fab fa-whatsapp"></i> واتساب
            </a>
            <a href="https://t.me/share/url?url=${shareUrl}" 
               target="_blank" class="share-btn telegram">
              <i class="fab fa-telegram-plane"></i> تيليجرام
            </a>
            <a href="#" onclick="downloadStudentImage('${id}', '${imageUrl}')" class="share-btn" style="background-color: #4CAF50;">
              <i class="fas fa-download"></i> تحميل الصورة
            </a>
          </div>
        </div>
      `,
      icon: 'success',
      confirmButtonText: 'حسناً',
      width: '600px'
    });
    
  } catch (error) {
    console.error('Error capturing student UI:', error);
    // Fallback to regular message if image capture fails
    const shareText = `تم تسجيل طالب جديد:
الاسم: ${name}
الصف: ${grade}
كود الطالب: ${id}`;
    
    const shareUrl = encodeURIComponent(window.location.href);
    const encodedText = encodeURIComponent(shareText);
    
    Swal.fire({
      title: 'تمت الإضافة بنجاح',
      html: `
        <div style="text-align: right;">
          <p><b><i class="fas fa-id-card"></i> كود الطالب:</b> ${id}</p>
          <p><b><i class="fas fa-user"></i> الاسم:</b> ${name}</p>
          <p><b><i class="fas fa-graduation-cap"></i> الصف:</b> ${grade}</p>
          
          <div class="share-buttons">
            <a href="https://www.facebook.com/sharer/sharer.php?u=${shareUrl}&quote=${encodedText}" 
               target="_blank" class="share-btn facebook">
              <i class="fab fa-facebook-f"></i> فيسبوك
            </a>
            <a href="https://wa.me/?text=${encodedText}" 
               target="_blank" class="share-btn whatsapp">
              <i class="fab fa-whatsapp"></i> واتساب
            </a>
            <a href="https://t.me/share/url?url=${shareUrl}&text=${encodedText}" 
               target="_blank" class="share-btn telegram">
              <i class="fab fa-telegram-plane"></i> تيليجرام
            </a>
          </div>
        </div>
      `,
      icon: 'success',
      confirmButtonText: 'حسناً',
      width: '600px'
    });
  }
}

function downloadStudentImage(id, imageUrl) {
  const link = document.createElement('a');
  link.href = imageUrl;
  link.download = `طالب_${id}.png`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function clearAddForm() {
  document.getElementById('newStudentName').value = '';
  document.getElementById('newStudentGrade').value = '';
  document.getElementById('newStudentLevel').value = '';
  document.getElementById('newStudentId').value = generateStudentId();
}

function saveStudent() {
  const id = document.getElementById('studentId').value.trim();
  const name = document.getElementById('studentName').value.trim();
  const grade = document.getElementById('studentGrade').value;
  const level = document.getElementById('studentLevel').value;
  
  if (!id) {
    showError('يجب إدخال كود الطالب');
    document.getElementById('studentId').focus();
    return;
  }
  
  if (!name) {
    showError('يجب إدخال اسم الطالب');
    document.getElementById('studentName').focus();
    return;
  }
  
  if (!grade) {
    showError('يجب اختيار الصف');
    document.getElementById('studentGrade').focus();
    return;
  }
  
  if (currentStudentId === null && students[id]) {
    showError('كود الطالب موجود مسبقاً');
    document.getElementById('studentId').focus();
    return;
  }
  
  if (currentStudentId === null) {
    // Add new student
    students[id] = {
      name,
      main: grade,
      info: level,
      notes: '',
      attendance: Object.fromEntries(weekDays.map(day => [day, "-"])),
      fees: Object.fromEntries(months.map(month => [month, false]))
    };
    
    showSuccess('تم إضافة الطالب بنجاح');
  } else {
    // Update existing student
    if (currentStudentId !== id) {
      // If ID changed, we need to create new entry and delete old one
      students[id] = {
        name,
        main: grade,
        info: level,
        notes: students[currentStudentId].notes || '',
        attendance: {...students[currentStudentId].attendance},
        fees: {...students[currentStudentId].fees}
      };
      delete students[currentStudentId];
    } else {
      // Just update the existing student
      students[id].name = name;
      students[id].main = grade;
      students[id].info = level;
    }
    showSuccess('تم تحديث بيانات الطالب بنجاح');
  }
  
  renderTable();
  renderStudentCards();
  closeModal();
}

function copyStudentLink(id) {
  const student = students[id];
  const shareText = `بيانات الطالب:
الاسم: ${student.name}
الصف: ${student.main}
المستوى: ${student.info || '-'}
كود الطالب: ${id}
${student.notes ? `\nالملاحظات: ${student.notes}` : ''}`;
  
  navigator.clipboard.writeText(shareText).then(() => {
    Swal.fire({
      title: 'تم النسخ!',
      text: 'تم نسخ بيانات الطالب إلى الحافظة',
      icon: 'success',
      timer: 2000
    });
  }).catch(err => {
    showError('فشل في نسخ البيانات: ' + err);
  });
}

function confirmDelete() {
  if (deleteStudentId) {
    delete students[deleteStudentId];
    renderTable();
    renderStudentCards();
    closeModal();
    showSuccess('تم حذف الطالب بنجاح');
    deleteStudentId = null;
  }
}

// وظائف المنشورات
function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
  document.getElementById(`${tabName}-tab`).classList.add('active');
}

function showPostModal(postId = null) {
  currentPostId = postId;
  postImageFile = null;
  
  if (postId) {
    // وضع التعديل
    document.getElementById('postModalTitle').innerHTML = '<i class="fas fa-edit"></i> تعديل المنشور';
    const post = posts[postId];
    document.getElementById('editPostTitle').value = post.title;
    document.getElementById('editPostContent').value = post.content;
    
    // عرض الصورة إذا كانت موجودة
    const preview = document.getElementById('postImagePreview');
    if (post.image) {
      preview.src = post.image;
      preview.style.display = 'block';
    } else {
      preview.style.display = 'none';
    }
  } else {
    // وضع الإضافة
    document.getElementById('postModalTitle').innerHTML = '<i class="fas fa-plus"></i> منشور جديد';
    document.getElementById('editPostTitle').value = '';
    document.getElementById('editPostContent').value = '';
    document.getElementById('postImagePreview').style.display = 'none';
  }
  
  document.getElementById('savePostBtn').onclick = savePost;
  document.getElementById('postModal').style.display = 'block';
}

function previewPostImage() {
  const fileInput = document.getElementById('postImageInput');
  const preview = document.getElementById('postImagePreview');
  
  if (fileInput.files && fileInput.files[0]) {
    postImageFile = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
    }
    
    reader.readAsDataURL(fileInput.files[0]);
  }
}

function savePost() {
  const title = document.getElementById('editPostTitle').value.trim();
  const content = document.getElementById('editPostContent').value.trim();
  
  if (!title) {
    showError('الرجاء إدخال عنوان للمنشور');
    return;
  }
  
  if (!content) {
    showError('الرجاء إدخال محتوى للمنشور');
    return;
  }
  
  const postId = currentPostId || Date.now().toString();
  
  if (!currentPostId) {
    // منشور جديد
    posts[postId] = {
      title,
      content,
      likes: 0,
      likedBy: [],
      shares: 0,
      date: new Date().toLocaleString('ar-EG'),
      author: 'المدير'
    };
    
    // Handle image upload if exists
    if (postImageFile) {
      const reader = new FileReader();
      reader.onload = function(e) {
        posts[postId].image = e.target.result;
        savePostsToGitHub();
        renderPosts();
        closePostModal();
        showSuccess('تم نشر المنشور بنجاح');
      };
      reader.readAsDataURL(postImageFile);
    } else {
      savePostsToGitHub();
      renderPosts();
      closePostModal();
      showSuccess('تم نشر المنشور بنجاح');
    }
  } else {
    // تعديل منشور موجود
    posts[postId].title = title;
    posts[postId].content = content;
    
    // Handle image upload if exists
    if (postImageFile) {
      const reader = new FileReader();
      reader.onload = function(e) {
        posts[postId].image = e.target.result;
        savePostsToGitHub();
        renderPosts();
        closePostModal();
        showSuccess('تم تحديث المنشور بنجاح');
      };
      reader.readAsDataURL(postImageFile);
    } else {
      // Only update image if it wasn't removed
      if (!document.getElementById('postImagePreview').style.display === 'none' && posts[postId].image) {
        delete posts[postId].image;
      }
      savePostsToGitHub();
      renderPosts();
      closePostModal();
      showSuccess('تم تحديث المنشور بنجاح');
    }
  }
}

function deletePost(postId) {
  Swal.fire({
    title: 'هل أنت متأكد؟',
    text: 'سيتم حذف هذا المنشور ولا يمكن التراجع عن هذا الإجراء!',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    confirmButtonText: 'نعم، احذف',
    cancelButtonText: 'إلغاء'
  }).then((result) => {
    if (result.isConfirmed) {
      delete posts[postId];
      savePostsToGitHub();
      renderPosts();
      showSuccess('تم حذف المنشور بنجاح');
    }
  });
}

function toggleLike(postId) {
  const post = posts[postId];
  const user = 'admin'; // يمكن تغيير هذا إذا كان لديك نظام مستخدمين
  
  if (!post.likedBy) {
    post.likedBy = [];
  }
  
  if (post.likedBy.includes(user)) {
    // إزالة الإعجاب
    post.likes--;
    post.likedBy = post.likedBy.filter(u => u !== user);
  } else {
    // إضافة إعجاب
    post.likes = (post.likes || 0) + 1;
    post.likedBy.push(user);
  }
  
  savePostsToGitHub();
  renderPosts();
}

function sharePost(postId) {
  const post = posts[postId];
  let shareText = `${post.title}\n\n${post.content}\n\nتاريخ النشر: ${post.date}`;
  const shareUrl = encodeURIComponent(window.location.href);
  const encodedText = encodeURIComponent(shareText);
  
  // زيادة عدد المشاركات
  post.shares = (post.shares || 0) + 1;
  savePostsToGitHub();
  renderPosts();
  
  // إنشاء محتوى المشاركة
  let shareHtml = `
    <div style="text-align: right;">
      <p>اختر طريقة المشاركة:</p>
      <div class="share-buttons">
        <a href="https://www.facebook.com/sharer/sharer.php?u=${shareUrl}&quote=${encodedText}" 
           target="_blank" class="share-btn facebook">
          <i class="fab fa-facebook-f"></i> فيسبوك
        </a>
        <a href="https://wa.me/?text=${encodedText}" 
           target="_blank" class="share-btn whatsapp">
          <i class="fab fa-whatsapp"></i> واتساب
        </a>
        <a href="https://t.me/share/url?url=${shareUrl}&text=${encodedText}" 
           target="_blank" class="share-btn telegram">
          <i class="fab fa-telegram-plane"></i> تيليجرام
        </a>
  `;
  
  // إضافة زر تحميل الصورة إذا كان المنشور يحتوي على صورة
  if (post.image) {
    shareHtml += `
        <a href="#" onclick="downloadPostImage('${postId}')" class="share-btn" style="background-color: #4CAF50;">
          <i class="fas fa-download"></i> تحميل الصورة
        </a>
    `;
  }
  
  shareHtml += `
      </div>
    </div>
  `;
  
  Swal.fire({
    title: 'مشاركة المنشور',
    html: shareHtml,
    showConfirmButton: false,
    width: '600px'
  });
}

function downloadPostImage(postId) {
  const post = posts[postId];
  if (post.image) {
    const link = document.createElement('a');
    link.href = post.image;
    link.download = `منشور_${postId}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}

function copyPostLink(postId) {
  const post = posts[postId];
  const shareText = `${post.title}\n\n${post.content}\n\nتاريخ النشر: ${post.date}`;
  
  navigator.clipboard.writeText(shareText).then(() => {
    Swal.fire({
      title: 'تم النسخ!',
      text: 'تم نسخ المنشور إلى الحافظة',
      icon: 'success',
      timer: 2000
    });
  }).catch(err => {
    showError('فشل في نسخ المنشور: ' + err);
  });
}

async function savePostsToGitHub() {
  const token = document.getElementById('token').value.trim();
  if (!token) {
    showError('الرجاء إدخال توكن GitHub أولاً');
    document.getElementById('token').focus();
    return;
  }

  const content = JSON.stringify(posts, null, 2);
  const utf8Content = unescape(encodeURIComponent(content));
  const encoded = btoa(utf8Content);

  try {
    showLoading(true);
    
    // تحقق مما إذا كان الملف موجودًا بالفعل للحصول على SHA
    let sha = '';
    try {
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`, {
        headers: {
          'Authorization': `token ${token}`
        }
      });
      
      if (res.ok) {
        const data = await res.json();
        sha = data.sha;
      }
    } catch (error) {
      console.log('الملف غير موجود، سيتم إنشاء ملف جديد');
    }
    
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${postsPath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: "تحديث المنشورات من لوحة التحكم",
        content: encoded,
        sha: sha || undefined,
        branch: branch
      })
    });

    if (res.ok) {
      const data = await res.json();
      showSuccess('تم حفظ المنشورات بنجاح على GitHub');
    } else {
      const error = await res.json();
      showError(`فشل في حفظ المنشورات! ${error.message}`);
    }
  } catch (error) {
    showError(`خطأ في الاتصال: ${error.message}`);
  } finally {
    showLoading(false);
  }
}

async function saveToGitHub() {
  const token = document.getElementById('token').value.trim();
  if (!token) {
    showError('الرجاء إدخال توكن GitHub أولاً');
    document.getElementById('token').focus();
    return;
  }
  localStorage.setItem("gh_token", token);

  // حفظ بيانات الطلاب
  const content = JSON.stringify(students, null, 2);
  const utf8Content = unescape(encodeURIComponent(content));
  const encoded = btoa(utf8Content);

  try {
    showLoading(true);
    const saveBtn = document.querySelector('button[onclick="saveToGitHub()"]');
    originalButtonText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="spinner"></span> جاري الحفظ...';
    saveBtn.disabled = true;
    
    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: "تحديث بيانات الطلاب من لوحة التحكم",
        content: encoded,
        sha: sha,
        branch: branch
      })
    });

    if (res.ok) {
      const data = await res.json();
      sha = data.content.sha;
      showSuccess('تم حفظ البيانات بنجاح على GitHub');
      loadStudents();
    } else {
      const error = await res.json();
      showError(`فشل في الحفظ! ${error.message}`);
    }
  } catch (error) {
    showError(`خطأ في الاتصال: ${error.message}`);
  } finally {
    showLoading(false);
    const saveBtn = document.querySelector('button[onclick="saveToGitHub()"]');
    if (saveBtn) {
      saveBtn.innerHTML = originalButtonText;
      saveBtn.disabled = false;
    }
  }
}

function showLoading(show) {
  isLoading = show;
  const loader = document.createElement('div');
  loader.id = 'loadingOverlay';
  loader.style.position = 'fixed';
  loader.style.top = '0';
  loader.style.left = '0';
  loader.style.width = '100%';
  loader.style.height = '100%';
  loader.style.backgroundColor = 'rgba(0,0,0,0.5)';
  loader.style.display = 'flex';
  loader.style.justifyContent = 'center';
  loader.style.alignItems = 'center';
  loader.style.zIndex = '9998';
  loader.innerHTML = `
    <div style="background: var(--white); padding: 30px; border-radius: 12px; text-align: center; box-shadow: var(--shadow);">
      <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto 15px; border-top-color: var(--primary-color);"></div>
      <p style="font-weight: bold; color: var(--text-color);">جاري التحميل...</p>
    </div>
  `;
  
  if (show) {
    document.body.appendChild(loader);
  } else {
    const existingLoader = document.getElementById('loadingOverlay');
    if (existingLoader) {
      existingLoader.remove();
    }
  }
}

function showError(message) {
  Swal.fire({
    title: '❌ خطأ',
    text: message,
    icon: 'error',
    confirmButtonText: 'حسناً'
  });
}

function showSuccess(message) {
  Swal.fire({
    title: '✅ تم بنجاح',
    text: message,
    icon: 'success',
    confirmButtonText: 'حسناً'
  });
}

// Export data functions
function exportData(format) {
  if (Object.keys(students).length === 0) {
    showError('لا يوجد بيانات لتصديرها');
    return;
  }

  switch(format) {
    case 'pdf':
      exportToPDF();
      break;
    case 'excel':
      exportToExcel();
      break;
    case 'word':
      exportToWord();
      break;
    case 'json':
      exportToJSON();
      break;
    default:
      showError('صيغة التصدير غير معروفة');
  }
}

function exportToPDF() {
  const doc = new jsPDF();
  
  // Add title
  doc.setFont('Tajawal', 'normal');
  doc.setTextColor(33, 150, 243);
  doc.setFontSize(22);
  doc.text('تقرير بيانات الطلاب', 105, 15, null, null, 'center');
  
  // Add date
  doc.setFontSize(12);
  doc.setTextColor(100, 100, 100);
  doc.text(`تاريخ التصدير: ${new Date().toLocaleDateString('ar-EG')}`, 105, 25, null, null, 'center');
  
  let y = 35;
  
  // Add each student's data
  Object.keys(students).forEach((id, index) => {
    const student = students[id];
    
    // Start new page if needed
    if (y > 250) {
      doc.addPage();
      y = 20;
    }
    
    // Student header
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text(`الطالب ${index + 1}: ${student.name} (${id})`, 14, y);
    y += 10;
    
    // Basic info
    doc.setFontSize(12);
    doc.text(`الصف: ${student.main}`, 14, y);
    doc.text(`المستوى: ${student.info || '-'}`, 100, y);
    y += 8;
    
    // Notes
    if (student.notes) {
      doc.text('الملاحظات:', 14, y);
      y += 8;
      doc.text(student.notes, 14, y, { maxWidth: 180 });
      y += 10;
    }
    
    // Attendance
    doc.text('الحضور:', 14, y);
    y += 8;
    
    let attendanceText = weekDays.map(day => {
      return `${day}: ${student.attendance?.[day] || '-'}`;
    }).join('، ');
    
    doc.text(attendanceText, 14, y, { maxWidth: 180 });
    y += 10;
    
    // Fees
    doc.text('المصروفات:', 14, y);
    y += 8;
    
    let feesText = months.map(month => {
      return `${month}: ${student.fees?.[month] ? 'مسددة' : 'غير مسددة'}`;
    }).join('، ');
    
    doc.text(feesText, 14, y, { maxWidth: 180 });
    y += 15;
    
    // Add separator
    doc.setDrawColor(200, 200, 200);
    doc.line(14, y, 196, y);
    y += 5;
  });
  
  // Save the PDF
  doc.save('بيانات_الطلاب.pdf');
}

function exportToExcel() {
  // Prepare data
  const data = [];
  
  // Add headers
  data.push([
    'كود الطالب', 'الاسم', 'الصف', 'المستوى', 'الملاحظات',
    ...weekDays.map(d => `حضور ${d}`),
    ...months.map(m => `مصروفات ${m}`)
  ]);
  
  // Add students data
  Object.keys(students).forEach(id => {
    const student = students[id];
    const row = [
      id,
      student.name,
      student.main,
      student.info || '-',
      student.notes || '-',
      ...weekDays.map(day => student.attendance?.[day] || '-'),
      ...months.map(month => student.fees?.[month] ? 'مسددة' : 'غير مسددة')
    ];
    data.push(row);
  });
  
  // Create worksheet
  const ws = XLSX.utils.aoa_to_sheet(data);
  
  // Create workbook
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "بيانات الطلاب");
  
  // Export to Excel
  XLSX.writeFile(wb, "بيانات_الطلاب.xlsx");
}

function exportToWord() {
  // Create HTML content
  let html = `
    <!DOCTYPE html>
    <html dir="rtl">
    <head>
      <meta charset="UTF-8">
      <title>بيانات الطلاب</title>
      <style>
        body { font-family: 'Tajawal', sans-serif; }
        h1 { color: #1976d2; text-align: center; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #1976d2; color: white; }
        .notes { background-color: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0; }
      </style>
    </head>
    <body>
      <h1>تقرير بيانات الطلاب</h1>
      <p style="text-align: center;">تاريخ التصدير: ${new Date().toLocaleDateString('ar-EG')}</p>
  `;
  
  // Add students data
  let count = 1;
  Object.keys(students).forEach(id => {
    const student = students[id];
    html += `
      <div style="page-break-inside: avoid;">
        <h3>الطالب ${count++}: ${student.name} (${id})</h3>
        <table>
          <tr>
            <th>الصف</th>
            <th>المستوى</th>
          </tr>
          <tr>
            <td>${student.main}</td>
            <td>${student.info || '-'}</td>
          </tr>
        </table>
        ${student.notes ? `<div class="notes"><strong>الملاحظات:</strong> ${student.notes}</div>` : ''}
        <hr>
      </div>
    `;
  });
  
  html += `
    </body>
    </html>
  `;
  
  // Create Blob and download
  const blob = new Blob([html], { type: 'application/msword' });
  saveAs(blob, 'بيانات_الطلاب.doc');
}

function exportToJSON() {
  const dataStr = JSON.stringify(students, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  saveAs(blob, 'بيانات_الطلاب.json');
}

// Initialize when page loads
window.onload = function() {
  // Check if already logged in
  if (localStorage.getItem('isLoggedIn') === 'true') {
    document.getElementById('loginScreen').style.display = 'none';
    loadStudents();
    loadPosts();
    fillGradeSelects();
  }
  
  // Focus on password field if not logged in
  if (document.getElementById('loginScreen').style.display !== 'none') {
    document.getElementById('loginPassword').focus();
  }
  
  // Set up event listeners
  document.getElementById('savePostBtn').onclick = savePost;
  
  // Generate initial student ID for add form
  document.getElementById('newStudentId').value = generateStudentId();
  
  // Handle window resize for responsive display
  window.addEventListener('resize', function() {
    if (window.innerWidth <= 768) {
      renderStudentCards();
    } else {
      renderTable();
    }
  });
};
</script>
</body>
</html>
